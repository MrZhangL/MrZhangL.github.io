<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java并发-ThreadLocal - MrZhang</title><meta description="ThreadLocal在Java中应用非常之多，ThreadLocal用于保存与线程绑定的对象，即一个对象通过ThreadLocal与线程进行绑定后，我们在任意的方法中，都能获取到线程所绑定的对象。"><meta property="og:type" content="blog"><meta property="og:title" content="Java并发-ThreadLocal"><meta property="og:url" content="http://example.com/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/"><meta property="og:site_name" content="MrZhang"><meta property="og:description" content="ThreadLocal在Java中应用非常之多，ThreadLocal用于保存与线程绑定的对象，即一个对象通过ThreadLocal与线程进行绑定后，我们在任意的方法中，都能获取到线程所绑定的对象。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/leizz1/pictures/raw/master/img/image-20191225143927470.png"><meta property="og:image" content="https://gitee.com/leizz1/pictures/raw/master/img/image-20201001203039938.png"><meta property="article:published_time" content="2020-09-30T13:49:53.000Z"><meta property="article:modified_time" content="2020-10-01T14:03:13.000Z"><meta property="article:author" content="tomcode"><meta property="article:tag" content="多线程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/leizz1/pictures/raw/master/img/image-20191225143927470.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/"},"headline":"MrZhang","image":["https://gitee.com/leizz1/pictures/raw/master/img/image-20191225143927470.png","https://gitee.com/leizz1/pictures/raw/master/img/image-20201001203039938.png"],"datePublished":"2020-09-30T13:49:53.000Z","dateModified":"2020-10-01T14:03:13.000Z","author":{"@type":"Person","name":"tomcode"},"description":"ThreadLocal在Java中应用非常之多，ThreadLocal用于保存与线程绑定的对象，即一个对象通过ThreadLocal与线程进行绑定后，我们在任意的方法中，都能获取到线程所绑定的对象。"}</script><link rel="canonical" href="http://example.com/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="MrZhang" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-30T13:49:53.000Z" title="2020-09-30T13:49:53.000Z">2020-09-30</time>发表</span><span class="level-item"><time dateTime="2020-10-01T14:03:13.000Z" title="2020-10-01T14:03:13.000Z">2020-10-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Java多线程</a></span><span class="level-item">18 分钟读完 (大约2754个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Java并发-ThreadLocal</h1><div class="content"><p>ThreadLocal在Java中应用非常之多，ThreadLocal用于保存与线程绑定的对象，即一个对象通过ThreadLocal与线程进行绑定后，我们在任意的方法中，都能获取到线程所绑定的对象。<a id="more"></a></p>
<h1 id="一个ThreadLocal的用例"><a href="#一个ThreadLocal的用例" class="headerlink" title="一个ThreadLocal的用例"></a>一个ThreadLocal的用例</h1><p>当我们需要添加转账业务时，将会在Service加入如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transferMoney</span><span class="params">(Account source, Account target, <span class="keyword">float</span> money)</span> </span>&#123;</span><br><span class="line">    Connection connection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = dataSource.getConnection();		<span class="comment">// 从连接池里获取一个连接</span></span><br><span class="line">        connection.setAutoCommit(<span class="keyword">false</span>);    <span class="comment">//关闭自动提交，开启事务</span></span><br><span class="line">        <span class="comment">// 查找用户</span></span><br><span class="line">        Account s1 = accountDao.findById(source.id);</span><br><span class="line">        Account t1 = accountDao.findById(target.id);</span><br><span class="line">        <span class="comment">// 更新用户</span></span><br><span class="line">        s1.setMoney(s1.getMoney() - money);</span><br><span class="line">        t1.setMoney(t1.getMoney() + money);</span><br><span class="line">        <span class="comment">// 提交更新</span></span><br><span class="line">        accountDao.updataAccount(s1);</span><br><span class="line">        <span class="comment">// int i = 3/0;</span></span><br><span class="line">        accountDao.updataAccount(t1);</span><br><span class="line">        <span class="comment">// 提交事务</span></span><br><span class="line">        connection.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection.rollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(connection != <span class="keyword">null</span>) connection.closeConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dao层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updataAccount</span><span class="params">(Account account)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    queryRunner.update(<span class="string">&quot;update `account` set `name` = ?, money = ? where id = ?&quot;</span>,</span><br><span class="line">                       account.getName(), account.getMoney(), account.getId());		</span><br><span class="line">    <span class="comment">// 没有传入connection，会自己从dataSource里取一个连接，执行完自动归还</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转账操作将由多个dao层方法完成，如果中间在执行了几条后出现异常，则后面的将不再执行，因此需要进行事务控制，而面对之前设计的代码，我们都是通过QureyRunner从连接池中任意取一条来执行方法，因此面临的问题是执行第10行和第12行时取的是不同的连接，<strong>不同的连接没办法做到事务控制</strong>，因此我们需要做出改进。</p>
<p>通过以上代码执行可能是以下情况(同时发送多笔转账操作)：</p>
<p>(1) 线程1从连接池中取出连接1访问数据库后执行了accountDao.updataAccount(s1)操作并归还连接，图示中执行1-2-3</p>
<p>(2) 此时跳转到线程2也执行了转账或其他操作(以转账为例)，从连接池中取出来连接1，图示中执行4</p>
<p>(3) 此时又跳回到线程1，执行accountDao.updataAccount(t1)，从连接池中取出了3，两次连接不同，无法进行事务控制</p>
<p>(4) 在Sevice层取出用于事务控制的连接于Dao层的连接也不同，提交或回滚事务对于两个update操作没有任何影响。</p>
<p><img src="https://gitee.com/leizz1/pictures/raw/master/img/image-20191225143927470.png" alt="image-20191225143927470"></p>
<p><strong>解决办法</strong></p>
<p>首先，在这里我们可以通过<strong>传参</strong>的方式，将开启事务的connection传入到对应的dao层操作中，使用传入的connection对象即可保证进行事务控制、更新两个用户的操作都是属于同一个数据库连接，这样就可以完成事务的控制。但是传参的方式不太好，对业务的侵入比较大，提高的代码的耦合程度。</p>
<p>在这里，还有另一种解决方案，我们可以利用ThreadLocal来解决这一问题，Java的ThreadLocal可以让线程绑定一个对象，当我们需要这个变量时，我们可以在任何地方取出当前线程对应的变量。</p>
<p><strong>ThreadLocal类：</strong></p>
<ul>
<li>将对象与线程对应，key-value的形式   </li>
<li>每个线程Thread对象中都有一个ThreadLocal的内部类ThreadLocalMap的对象，里面储存了该线程所对应的对象  </li>
<li>通过ThreadLocal类对象调用set与get方法都是对当前线程对应的对象进行操作</li>
</ul>
<p>下面使用ThreadLocal来定义从数据库连接池中获取连接的工具类<code>ConnectionUtils</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(value = &quot;connectionUtils&quot;)</span>	<span class="comment">// 注入到Spring容器当中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Connection&gt; connectionThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Connection&gt;();  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionThreadLocal</span><span class="params">(ThreadLocal&lt;Connection&gt; connectionThreadLocal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionThreadLocal = connectionThreadLocal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取一个数据库连接：</span></span><br><span class="line">    <span class="comment">//	1. 如果当前线程未获取过连接或者已经归还，则从连接池中获取一个连接</span></span><br><span class="line">    <span class="comment">//  2. 如果当前线程获取过连接且未归还，则直接返回该连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getLocalConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection == <span class="keyword">null</span> || connection.isClosed()) &#123;</span><br><span class="line">                connection = dataSource.getConnection();</span><br><span class="line">                connectionThreadLocal.set(connection);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//归还连接并且解绑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CloseConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                connectionThreadLocal.remove();</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再对事务进行封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//事务管理工具类</span></span><br><span class="line"><span class="meta">@Component(&quot;transactionUtils&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;connectionUtils&quot;)</span></span><br><span class="line">    ConnectionUtils connectionUtils;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 开启事务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getLocalConnection().setAutoCommit(<span class="keyword">false</span>);    <span class="comment">//关闭自动提交，开启事务</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 提交事务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getLocalConnection().commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 回滚事务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getLocalConnection().rollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 归还连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">        connectionUtils.CloseConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>则我们可以将转账操作的service层与dao层改进为：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transferMoney</span><span class="params">(Account source, Account target, <span class="keyword">float</span> money)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//1.开启事务</span></span><br><span class="line">        tsManager.start();</span><br><span class="line">        <span class="comment">//2.执行操作</span></span><br><span class="line">        <span class="comment">//2.1 查找用户</span></span><br><span class="line">        Account s1 = accountDao.findById(source.id);</span><br><span class="line">        Account t1 = accountDao.findById(target.id);</span><br><span class="line">        <span class="comment">//2.2 更新用户</span></span><br><span class="line">        s1.setMoney(s1.getMoney() - money);</span><br><span class="line">        t1.setMoney(t1.getMoney() + money);</span><br><span class="line">        <span class="comment">//2.3 提交更新</span></span><br><span class="line">        accountDao.updataAccount(s1);</span><br><span class="line">        <span class="comment">//int i = 3/0;</span></span><br><span class="line">        accountDao.updataAccount(t1);</span><br><span class="line">        <span class="comment">//3.提交事务</span></span><br><span class="line">        tsManager.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        tsManager.rollback();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        tsManager.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dao层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updataAccount</span><span class="params">(Account account)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    queryRunner.update(connectionUtils.getLocalConnection(),<span class="string">&quot;update `account` set `name` = ?, money = ? where id = ?&quot;</span>,</span><br><span class="line">                       account.getName(), account.getMoney(), account.getId());</span><br><span class="line">    <span class="comment">// 传入了指定的connection，使用该connection执行sql，操作完不会自动归还连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样改造以后，当我们执行一次<code>transferMoney</code>，每次使用的数据库连接都是在tsManager.start()中从数据库连接池中取出来的连接，直到事务提交或回滚，然后调用tsManager.close()向连接池归还连接。</p>
<h1 id="ThreadLocal的核心原理"><a href="#ThreadLocal的核心原理" class="headerlink" title="ThreadLocal的核心原理"></a>ThreadLocal的核心原理</h1><p>ThreadLocal是依托于每个Thread对象中都有一个ThreadMap类对象，即为一个哈希表的对象，该哈希表的key为ThreadLocal对象，Value为我们要存储的与线程绑定的对象。我们每次调用ThreadLocal的get()/set()/remove()等方法时都是先通过当前线程找到ThreadLocalMap对象，然后通过ThreadLocal对象作为key找到对应的key-value对。</p>
<img src="https://gitee.com/leizz1/pictures/raw/master/img/image-20201001203039938.png" alt="image-20201001203039938" style="zoom:67%;" />

<p>我们来看一下get()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();	<span class="comment">// 获取当前的线程</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);		<span class="comment">// 获取对应线程的ThreadLocalMap</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;				   <span class="comment">// ThreadLocalMap是懒加载的</span></span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);	<span class="comment">// 获取对应的Entry</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            T result = (T)e.value;			</span><br><span class="line">            <span class="keyword">return</span> result;			<span class="comment">// 返回绑定的对象</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();		<span class="comment">// 没有设置过值，则初始化key-value，value为null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ThreadLocalMap并不是一个Map对象，与JDK中的HashMap不同：</p>
<ul>
<li>由于ThreadLocalMap中的key都为ThreadLocal对象，因此JDK中对ThreadLocal对象中都保存了一个threadLocalHashCode的int变量，该变量就是用于在哈希表中查找的哈希值。<ul>
<li>threadLocalHashCode是在new这个ThreadLocal对象时生成的，ThreadLocal中有一个静态成员变量<code>AtomicInteger nextHashCode</code>，每次生成一个ThreadLocal对象，都会为其配置nextHashCode作为hash值，然后再自增1。这样每个ThreadLocal对象都有不同的hash值。</li>
</ul>
</li>
<li>ThreadLocalMap采用的是<code>开放地址</code>的方法来解决hash冲突，而JDK的HashMap采用的是<code>链地址</code>的方法来解决hash冲突</li>
</ul>
<p>下面是ThreadLocalMap中查找key-value对的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);	<span class="comment">// 通过hash值对槽的长度取模</span></span><br><span class="line">    Entry e = table[i];</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)	</span><br><span class="line">        <span class="comment">// 对应slot槽上存在entry，且存储的entry对应的ThreadLocal与当前传入的ThreadLocal是同一个对象则代表找到了</span></span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);	<span class="comment">// hash后对应的位置上没有找到对应的entry</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getEntryAfterMiss</code>是<code>开放地址</code>法继续从后续slot中查找元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;	<span class="comment">// 从i开始向后搜索slot，直到为null或者找到了对应的key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();		<span class="comment">// 获取entry对应的key，即ThreadLocal对象</span></span><br><span class="line">        <span class="keyword">if</span> (k == key)		<span class="comment">// 如果entry中存的TreadLocal与传入需要查找的ThreadLocal相等，则代表找到了</span></span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">            expungeStaleEntry(i);		<span class="comment">// 在查找过程中，发现entry对应的key为null了，这是我们后续会讨论到的内存泄漏处理</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            i = nextIndex(i, len);		<span class="comment">// 本次的slot不是要找的，继续寻找下一个slot</span></span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样set()/remove()方法也是类似。</p>
<h1 id="ThreadLocal中的内存泄漏"><a href="#ThreadLocal中的内存泄漏" class="headerlink" title="ThreadLocal中的内存泄漏"></a>ThreadLocal中的内存泄漏</h1><p>在我们使用ThreadLocal过程中，例如上面的ConnectionUtil中，如果ThreadLocal对象并不需要是一个持久变量，即如果ConnectionUtil被释放了，会导致其类中的ThreadLocal的引用被删除，那么此时的这个ThreadLocal需要被GC时，但是如果我们没有对每个线程都调用ThreadLocal的remove方法，那么就会有某个线程中的ThreadLocalMap的entry保留了该ThreadLocal的引用，使得该ThreadLocal对象无法被GC，并且一直保留到该线程结束，造成了内存泄漏。JDK通过<code>弱引用</code>的方式来解决这种内存泄漏的情况。</p>
<p><strong>弱引用</strong></p>
<p>Java中存在四种引用类型，强引用、软引用、弱引用、虚引用。</p>
<p>弱引用指向的对象，当进行垃圾回收时，如果该对象只有弱引用而没有强引用指向其时，就会没清除。ThreadLocal就是利用弱引用来防止内存泄漏，在ThreadLocalMap中，Entry对象继承了WeakReference：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="keyword">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，在new一个Entry对象时，该entry中保存的key(即ThreadLocal对象)为一个弱引用。那么当外部的强引用消失时，尽管ThreadLocalMap中还保留了ThreadLocal的引用，但是该引用是弱引用，GC会认为ThreadLocal对象为垃圾而将其清除。这样一来就会出现哈希slot中的entry对应的key为null的情况。</p>
<p>尽管ThreadLocal对象被清理了，但是Entry对应的value不是弱引用，这样一来也会造成内存泄漏，首先，value不能是弱引用，因为我们就是将value存入ThreadLocalMap中好让我们在该线程执行到任何地方时我们都能够取出来，如果为弱引用极有可能在我们不想释放的时候就已经被释放了。我们之前在分析get()方法时，就在查找对应entry时碰到了key为null的情况，如果碰到了这种情况，则是代表内存泄漏了，会将对应value队形进行释放。同样在set()/remove()方法中，查找时一旦发现key为null的entry就会清理其value来尽量避免内存泄漏。</p>
<p>ThreadLocal的安全使用方法则是每次set()后在之后不使用的情况下需要手动调用remove()方法，这样便不会造成内存泄漏了。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java并发-ThreadLocal</p><p><a href="http://example.com/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/">http://example.com/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>tomcode</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-09-30</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-10-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/10/20/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">docker常用命令</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/09/17/CAS%E4%B9%8BLongAdder/"><span class="level-item">CAS之LongAdder</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://gitee.com/leizz1/pictures/raw/master/null/AF32230B-6341-40A5-BADE-7C898E5E858B(20190701-101.JPG" alt="tomcode"></figure><p class="title is-size-4 is-block line-height-inherit">tomcode</p><p class="is-size-6 is-block">努力努力再努力</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/MrZhangL" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget is-sticky" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#一个ThreadLocal的用例"><span class="mr-2">1</span><span>一个ThreadLocal的用例</span></a></li><li><a class="is-flex" href="#ThreadLocal的核心原理"><span class="mr-2">2</span><span>ThreadLocal的核心原理</span></a></li><li><a class="is-flex" href="#ThreadLocal中的内存泄漏"><span class="mr-2">3</span><span>ThreadLocal中的内存泄漏</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JVM/"><span class="level-start"><span class="level-item">JVM</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="level-start"><span class="level-item">Java多线程</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Netty/"><span class="level-start"><span class="level-item">Netty</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/SSM/"><span class="level-start"><span class="level-item">SSM</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="level-start"><span class="level-item">分布式</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-10-30T13:51:55.000Z">2020-10-30</time></p><p class="title is-6"><a class="link-muted" href="/2020/10/30/Nacos%E6%BA%90%E7%A0%81-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/">Nacos源码-服务注册流程</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-10-29T10:16:35.000Z">2020-10-29</time></p><p class="title is-6"><a class="link-muted" href="/2020/10/29/Nacos%E6%BA%90%E7%A0%81-Nacos%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8/">Nacos源码-Nacos服务端源码启动</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-10-20T09:11:02.000Z">2020-10-20</time></p><p class="title is-6"><a class="link-muted" href="/2020/10/20/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">docker常用命令</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-09-30T13:49:53.000Z">2020-09-30</time></p><p class="title is-6"><a class="link-muted" href="/2020/09/30/Java%E5%B9%B6%E5%8F%91-ThreadLocal/">Java并发-ThreadLocal</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Java多线程</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-09-17T02:48:28.000Z">2020-09-17</time></p><p class="title is-6"><a class="link-muted" href="/2020/09/17/CAS%E4%B9%8BLongAdder/">CAS之LongAdder</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Java多线程</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mybatis/"><span class="tag">mybatis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nacos/"><span class="tag">nacos</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/netty/"><span class="tag">netty</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tag">多线程</span><span class="tag is-grey-lightest">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="MrZhang" height="28"></a><p class="size-small"><span>&copy; 2020 tomcode</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>