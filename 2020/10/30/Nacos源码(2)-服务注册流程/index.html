<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Nacos源码(2)-服务注册流程 - MrZhang</title><meta description="Nacos一个重要的作用就是用作微服务的注册中心，各个微服务向Nacos注册，并且从Nacos拉取自己所需要的其他微服务，因此学习一下Nacos的服务注册流程。"><meta property="og:type" content="blog"><meta property="og:title" content="Nacos源码(2)-服务注册流程"><meta property="og:url" content="http://example.com/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/"><meta property="og:site_name" content="MrZhang"><meta property="og:description" content="Nacos一个重要的作用就是用作微服务的注册中心，各个微服务向Nacos注册，并且从Nacos拉取自己所需要的其他微服务，因此学习一下Nacos的服务注册流程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gk75bng47cj31g50u0wq8.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gk75xroviyj31he0u0gug.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gk76cjnxxyj315i04475e.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gk7olgl8gbj31d80pqmz0.jpg"><meta property="article:published_time" content="2020-10-30T13:51:55.000Z"><meta property="article:modified_time" content="2020-11-05T08:00:22.000Z"><meta property="article:author" content="tomcode"><meta property="article:tag" content="nacos"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gk75bng47cj31g50u0wq8.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/"},"headline":"MrZhang","image":["https://tva1.sinaimg.cn/large/0081Kckwly1gk75bng47cj31g50u0wq8.jpg","https://tva1.sinaimg.cn/large/0081Kckwly1gk75xroviyj31he0u0gug.jpg","https://tva1.sinaimg.cn/large/0081Kckwly1gk76cjnxxyj315i04475e.jpg","https://tva1.sinaimg.cn/large/0081Kckwly1gk7olgl8gbj31d80pqmz0.jpg"],"datePublished":"2020-10-30T13:51:55.000Z","dateModified":"2020-11-05T08:00:22.000Z","author":{"@type":"Person","name":"tomcode"},"description":"Nacos一个重要的作用就是用作微服务的注册中心，各个微服务向Nacos注册，并且从Nacos拉取自己所需要的其他微服务，因此学习一下Nacos的服务注册流程。"}</script><link rel="canonical" href="http://example.com/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="MrZhang" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-10-30T13:51:55.000Z" title="2020-10-30T13:51:55.000Z">2020-10-30</time>发表</span><span class="level-item"><time dateTime="2020-11-05T08:00:22.000Z" title="2020-11-05T08:00:22.000Z">2020-11-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></span><span class="level-item">23 分钟读完 (大约3375个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Nacos源码(2)-服务注册流程</h1><div class="content"><p>Nacos一个重要的作用就是用作微服务的注册中心，各个微服务向Nacos注册，并且从Nacos拉取自己所需要的其他微服务，因此学习一下Nacos的服务注册流程。<a id="more"></a></p>
<h1 id="客户端的服务发现与注册"><a href="#客户端的服务发现与注册" class="headerlink" title="客户端的服务发现与注册"></a>客户端的服务发现与注册</h1><p>Nacos的服务注册采用的是HTTP请求，通过官网的描述，我们可以直接通过一个Http请求来注册我们的服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&#x27;http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080&#x27;</span></span><br></pre></td></tr></table></figure>

<p>通过一个post请求，我们就可以将服务注册到Nacos上，但是，不推荐直接发起Http请求来注册服务，因为注册服务的过程远远比单纯发起一个HTTP请求复杂，Nacos提供了与服务端交互的客户端，位于源码中的<code>nacos-client</code>模块。在Spring Cloud中，Nacos作为注册模块采用的就是<code>nacos-client</code></p>
<p>，我们从Spring Cloud中入手来了解Nacos如何在项目启动时完成服务的注册。</p>
<p>SpringCloud只是向外开发了一套自动注册的标准，而自动注册的功能是需要开发者去提供了，Nacos、Eureka等注册中心，都是针对了SpringCloud做了适配，实现自动注册，因此我们的目光不能只放在SpringCloud上了。对于SpringBoot、SpirngCloud而言，都是通过注解实现自动配置，大多数组件的注入都是通过XXXAutoConfiguration来实现，因此我们查找一下是否有关于Nacos的AutoConfiguration，经过搜索，确实有一个叫<code>NacosDiscoveryAutoConfiguration</code>，看到这个名字，我们就可以推断，这个类就是用于Nacos服务发现的自动配置：</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk75bng47cj31g50u0wq8.jpg" alt="image-20201030102224900" style="zoom: 67%;" />



<p>通过上面的代码我们可以知道，Nacos自动配置类生效依赖于<code>ServiceRegistryAutoConfiguration</code>和<code>AutoServiceRegistrationAutoConfiguration</code>两个配置类的生效，这两个类都是<code>Spring Cloud</code>提供的，也就是说这两个类是SpringCloud提供的服务发现与注册的标准，只有这两个配置类生效，才允许进行服务注册与发现，只要导入了Spring Cloud依赖，那么这两个类将通过SPI自动注入到容器中，这两个类配置在<code>spring-cloud-commons</code>的项目下<code>spring.factories</code>文件下：</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk75xroviyj31he0u0gug.jpg" alt="image-20201030104340441" style="zoom: 50%;" />

<p>也就是说当我们引入spring-cloud-alibaba-nacos-discovery的依赖时，同时也会引入spring-cloud-commons，会自动向容器中注册这两个类，那么Nacos的自动配置类也能够生效。我们在回到<code>NacosDiscoveryAutoConfiguration</code>中，该配置类向容器中注入了三个Bean对象，分别为：</p>
<ul>
<li>NacosServiceRegistry：该Bean是注册中心的客户端，用于与注册中心Nacos交互，例如注册服务，拉取服务、心跳续约等，该类实现了SpringCloud提供的<code>ServiceRegistry</code>接口。</li>
<li>NacosRegistration：该Bean是从application.yml/properties配置文件中加载当前微服务的一些信息，封装为Nacos需要的服务注册的信息。该类实现了SpringCloud提供的<code>Registration</code>与<code>ServiceInstance</code>接口</li>
<li>NacosAutoServiceRegistration：该Bean实现了服务的自动注册与发现，利用NacosServiceRegistry与NacosRegistration将当前的微服务注册到Naocs上。该类继承了SpringCloud提供的<code>AbstractAutoServiceRegistration</code>类</li>
</ul>
<p>前两个Bean对象都很好理解，自动注册的代码主要在<code>NacosAutoServiceRegistration</code>中实现。</p>
<p>SpringCloud针对服务的自动注册也提供了一套标准，那就是<code>AbstractAutoServiceRegistration</code>：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk76cjnxxyj315i04475e.jpg" alt="image-20201030105753006"></p>
<p>特别注意的是，该类实现了<code>ApplicationListener&lt;WebServerInitializedEvent&gt;</code>，实现了该类的类，如果注入到容器中，那么在Web容器初始化结束后，自动调用其接口的<code>void onApplicationEvent(E event);</code>方法。我们也可以估计到，服务的自动注册与发现就是通过该方法实现的，查看<code>AbstractAutoServiceRegistration</code>的该方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractAutoServiceRegistration</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(WebServerInitializedEvent event)</span> </span>&#123;</span><br><span class="line">   bind(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(WebServerInitializedEvent event)</span> </span>&#123;</span><br><span class="line">   ApplicationContext context = event.getApplicationContext();</span><br><span class="line">   <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ConfigurableWebServerApplicationContext) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;management&quot;</span>.equals(((ConfigurableWebServerApplicationContext) context)</span><br><span class="line">            .getServerNamespace())) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">this</span>.port.compareAndSet(<span class="number">0</span>, event.getWebServer().getPort());</span><br><span class="line">   <span class="keyword">this</span>.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Discovery Lifecycle disabled. Not starting&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// only initialize if nonSecurePort is greater than 0 and it isn&#x27;t already running</span></span><br><span class="line">  <span class="comment">// because of containerPortInitializer below</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.running.get()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.context.publishEvent(</span><br><span class="line">      <span class="keyword">new</span> InstancePreRegisteredEvent(<span class="keyword">this</span>, getRegistration()));	<span class="comment">// 向容器中发布即将服务注册的事件</span></span><br><span class="line">    register();		<span class="comment">// 完成服务注册</span></span><br><span class="line">    <span class="keyword">if</span> (shouldRegisterManagement()) &#123;</span><br><span class="line">      registerManagement();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.context.publishEvent(</span><br><span class="line">      <span class="keyword">new</span> InstanceRegisteredEvent&lt;&gt;(<span class="keyword">this</span>, getConfiguration()));  <span class="comment">// 向容器中发布服务注册完成的事件</span></span><br><span class="line">    <span class="keyword">this</span>.running.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.serviceRegistry.register(getRegistration());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到<code>onApplicationEvent</code>方法的调用链，一直到start()方法，在该方法中，在服务注册的前后都向Spring容器中发布了服务注册前/后的事件，<code>register()</code>方法是向注册中心注册微服务，而有调用了serviceRegistry的<code>register(R registration)</code>方法，该方法便是将服务的服务的注册信息注册到注册中心。</p>
<p>我们需要注意，在Nacos的自动配置类中，向容器中自动注入了<code>AbstractAutoServiceRegistration</code>的子类<code>NacosAutoServiceRegistration</code>，而<code>NacosAutoServiceRegistration</code>在初始化的时候，传入了<code>NacosServiceRegistry</code>和<code>NacosRegistration</code>。这样就非常的清晰明了，在调用下面这句话时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.serviceRegistry.register(getRegistration());</span><br></pre></td></tr></table></figure>

<p>serviceRegistry即为<code>NacosServiceRegistry</code>对象，getRegistration()放回的就是<code>NacosRegistration</code></p>
<p>经过验证：</p>
<p>在<code>AbstractAutoServiceRegistration</code>中，<code>getRegistration()</code>方法是一个抽象方法，该方法将由其子类实现完成服务注册，我们使用的是Nacos，在实现中，返回的就是在初始化时传入到<code>AbstractAutoServiceRegistration</code>中的<code>NacosRegistration</code>。</p>
<p>现在我们就可以来看<code>NacosServiceRegistry</code>的registry()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Registration registration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isEmpty(registration.getServiceId())) &#123;</span><br><span class="line">      log.warn(<span class="string">&quot;No service to register for nacos client...&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   String serviceId = registration.getServiceId();</span><br><span class="line"></span><br><span class="line">   Instance instance = getNacosInstanceFromRegistration(registration);	<span class="comment">// 转化为Nacos的Instance类</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      namingService.registerInstance(serviceId, instance);	<span class="comment">// 注册到Nacos</span></span><br><span class="line">      log.info(<span class="string">&quot;nacos registry, &#123;&#125; &#123;&#125;:&#123;&#125; register finished&quot;</span>, serviceId,</span><br><span class="line">            instance.getIp(), instance.getPort());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;nacos registry, &#123;&#125; register failed...&#123;&#125;,&quot;</span>, serviceId,</span><br><span class="line">            registration.toString(), e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中通过<code>namingService.registerInstance(serviceId, instance);</code>完成服务注册，namingService是<code>nacos-client</code>提供的与服务端互交的客户端对象，主要用于给Nacos服务端发起Http请求并且如果是临时节点将保持心跳。</p>
<h1 id="服务端服务注册"><a href="#服务端服务注册" class="headerlink" title="服务端服务注册"></a>服务端服务注册</h1><p>Nacos服务端本身也是一个Springboot项目，向Nacos服务端发起Http请求就能注册服务，因此我们需要找到Controller中能够接收服务注册的某个方法，我们通过客户端的代码可以看到注册服务的url地址是<code>/nacos/v1/ns/instance</code>，因此我们在相关的Controller中找到该url的方法，位于nacos-namming模块下的InstanceController的register方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@Secured(parser = NamingResourceParser.class, action = ActionTypes.WRITE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> String serviceName = WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">    <span class="keyword">final</span> String namespaceId = WebUtils</span><br><span class="line">            .optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Instance instance = parseInstance(request);</span><br><span class="line">    </span><br><span class="line">    serviceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serviceManager用于管理所有的Service，在阅读源码前，我们有必要先了解一下ServiceManager的组成：</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk7olgl8gbj31d80pqmz0.jpg" alt="image-20201030212911284" style="zoom:50%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServiceManager中保存了</span></span><br><span class="line">Map&lt;String, Map&lt;String, Service&gt;&gt; serviceMap;		<span class="comment">// namespace:(serviceName:Service)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于每个Service中保存了</span></span><br><span class="line">Map&lt;String, Cluster&gt; clusterMap;	<span class="comment">// clusterName:Cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个Cluster中保存了</span></span><br><span class="line">Set&lt;Instance&gt; persistentInstances;	<span class="comment">// 持久节点</span></span><br><span class="line">Set&lt;Instance&gt; ephemeralInstances;		<span class="comment">// 临时节点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ServiceManager保存了</span></span><br><span class="line">ConsistencyService consistencyService;</span><br><span class="line"><span class="comment">// ConsistencyService保存了一个Datastore</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DataStore dataStore;</span><br><span class="line"><span class="comment">// dataStore保存了</span></span><br><span class="line">Map&lt;String, Datum&gt; dataMap;</span><br><span class="line"><span class="comment">// Datum保存了</span></span><br><span class="line"><span class="keyword">public</span> T value;	<span class="comment">// 一般情况下，Datum的泛型为List&lt;Instance&gt;,前面的Map的key为Service的名称</span></span><br></pre></td></tr></table></figure>

<p>这些数据的关系描述：</p>
<ul>
<li>每个ServiceManager中保存了多个Namespace，不同Namespace下的Serivce可以重名</li>
<li>每个Namespace下保存了多个Service，即一个微服务</li>
<li>每个Service下保存了多个Cluster，例如北京的组成一个集群，深圳的组成一个集群</li>
<li>每个Cluster下保存了多个Instance，即多个微服务的实例</li>
<li>ServiceManager中还保存了一个对象ConsistencyService，该对象中保存了一个dataMap，即实例ID：实例，即所有的实例，用于同步数据。</li>
</ul>
<p>回到注册服务的Controller，registerInstance()代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建空的service</span></span><br><span class="line">    createEmptyService(namespaceId, serviceName, instance.isEphemeral());</span><br><span class="line">	  <span class="comment">// 获取到创建的Service</span></span><br><span class="line">    Service service = getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.INVALID_PARAM,</span><br><span class="line">                <span class="string">&quot;service not found, namespace: &quot;</span> + namespaceId + <span class="string">&quot;, service: &quot;</span> + serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">	  <span class="comment">// 添加实例</span></span><br><span class="line">    addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>registerInstance主要分为2部，即创建一个空的Service与向Service中添加实例</p>
<p><strong><font size="4px">createEmptyService</font></strong></p>
<p>创建空的Service(当Service不存在时才创建)，该方法主要会调用到createServiceIfAbsent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serviceManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createServiceIfAbsent</span><span class="params">(String namespaceId, String serviceName, <span class="keyword">boolean</span> local, Cluster cluster)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    Service service = getService(namespaceId, serviceName);	<span class="comment">// 先看serviceMap中有没有该Service</span></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">			 <span class="comment">// 没有则创建Service</span></span><br><span class="line">        Loggers.SRV_LOG.info(<span class="string">&quot;creating empty service &#123;&#125;:&#123;&#125;&quot;</span>, namespaceId, serviceName);</span><br><span class="line">        service = <span class="keyword">new</span> Service();</span><br><span class="line">        service.setName(serviceName);</span><br><span class="line">        service.setNamespaceId(namespaceId);</span><br><span class="line">        service.setGroupName(NamingUtils.getGroupName(serviceName));</span><br><span class="line">        <span class="comment">// now validate the service. if failed, exception will be thrown</span></span><br><span class="line">        service.setLastModifiedMillis(System.currentTimeMillis());</span><br><span class="line">        service.recalculateChecksum();</span><br><span class="line">        <span class="keyword">if</span> (cluster != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cluster.setService(service);</span><br><span class="line">            service.getClusterMap().put(cluster.getName(), cluster);</span><br><span class="line">        &#125;</span><br><span class="line">        service.validate();</span><br><span class="line">			 <span class="comment">// 将Service存储到serviceMap中并且初始化</span></span><br><span class="line">        putServiceAndInit(service);</span><br><span class="line">        <span class="comment">// 持久化</span></span><br><span class="line">        <span class="keyword">if</span> (!local) &#123;</span><br><span class="line">            addOrReplaceService(service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来到putServiceAndInit中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serviceManager</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putServiceAndInit</span><span class="params">(Service service)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    putService(service);		<span class="comment">// 向serviceMap中添加service</span></span><br><span class="line">    service.init();				  <span class="comment">// 初始化service</span></span><br><span class="line">    <span class="comment">// 同步器监听</span></span><br><span class="line">    consistencyService</span><br><span class="line">            .listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">true</span>), service);</span><br><span class="line">    consistencyService</span><br><span class="line">            .listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">false</span>), service);</span><br><span class="line">    Loggers.SRV_LOG.info(<span class="string">&quot;[NEW-SERVICE] &#123;&#125;&quot;</span>, service.toJson());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法先向serviceMap中添加了service，这部分比较简单，后续init了service，最后设置了consistencyService的监听，关于同步我们后续再说，看一看service的init()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向HealthCheck的执行器中提交检查健康的任务</span></span><br><span class="line">    HealthCheckReactor.scheduleCheck(clientBeatCheckTask);</span><br><span class="line">    <span class="comment">// 把集群内保存的Service都设置为当前的Service，一般情况下刚刚创建的Service的clusterMap没有集群</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Cluster&gt; entry : clusterMap.entrySet()) &#123;</span><br><span class="line">        entry.getValue().setService(<span class="keyword">this</span>);</span><br><span class="line">        entry.getValue().init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化主要是提交一个对服务进行健康检查的任务，每隔一段时间，都会检查该服务中所有实例是否定期上报健康心跳，如果没有心跳，则先保留一段时间，如果还未上报，则踢出。</p>
<p><strong><font size="4px">addInstance</font></strong></p>
<p>创建了空的Service后，就将注册的实例添加到Service中，如果原来就存在该Service，就直接添加实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serviceManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInstance</span><span class="params">(String namespaceId, String serviceName, <span class="keyword">boolean</span> ephemeral, Instance... ips)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	  <span class="comment">// 根据注册信息生成InastanceList的key，即保存一个Service中所有Instance的key，保存在consistencyService中</span></span><br><span class="line">    String key = KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);</span><br><span class="line"></span><br><span class="line">    Service service = getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (service) &#123;</span><br><span class="line">        <span class="comment">// 求得新加入Instance后的Instance列表</span></span><br><span class="line">        List&lt;Instance&gt; instanceList = addIpAddresses(service, ephemeral, ips);</span><br><span class="line"></span><br><span class="line">        Instances instances = <span class="keyword">new</span> Instances();</span><br><span class="line">        instances.setInstanceList(instanceList);</span><br><span class="line">			 </span><br><span class="line">        <span class="comment">// 将该服务对应的所有Insatance存储到consistencyService一份，并且通知serviceMap更新</span></span><br><span class="line">        consistencyService.put(key, instances);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法主要也是两部分，一个是更新Instance列表，另一个是将Instance列表存到consistencyService一份</p>
<p>首先看生成更新后Instance列表，即addIpAddresses方法，会调用到updateIpAddresses方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serviceManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Instance&gt; <span class="title">updateIpAddresses</span><span class="params">(Service service, String action, <span class="keyword">boolean</span> ephemeral, Instance... ips)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从consistencyService获取所有的Instance</span></span><br><span class="line">    Datum datum = consistencyService</span><br><span class="line">            .get(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), ephemeral));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从service中获取所有的Instance</span></span><br><span class="line">    List&lt;Instance&gt; currentIPs = service.allIPs(ephemeral);</span><br><span class="line">    Map&lt;String, Instance&gt; currentInstances = <span class="keyword">new</span> HashMap&lt;&gt;(currentIPs.size());</span><br><span class="line">    Set&lt;String&gt; currentInstanceIds = Sets.newHashSet();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝到一个临时的Map中</span></span><br><span class="line">    <span class="keyword">for</span> (Instance instance : currentIPs) &#123;</span><br><span class="line">        currentInstances.put(instance.toIpAddr(), instance);</span><br><span class="line">        currentInstanceIds.add(instance.getInstanceId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Instance&gt; instanceMap;</span><br><span class="line">    <span class="keyword">if</span> (datum != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 更新datum中所有实例的健康状态，并返回datum中的所有实例为instanceMap</span></span><br><span class="line">        instanceMap = setValid(((Instances) datum.value).getInstanceList(), currentInstances);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        instanceMap = <span class="keyword">new</span> HashMap&lt;&gt;(ips.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Instance instance : ips) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!service.getClusterMap().containsKey(instance.getClusterName())) &#123;</span><br><span class="line">            <span class="comment">// 如果没有service属于的集群就创建一个集群</span></span><br><span class="line">            Cluster cluster = <span class="keyword">new</span> Cluster(instance.getClusterName(), service);</span><br><span class="line">            cluster.init();</span><br><span class="line">            <span class="comment">// 将instance添加到集群中</span></span><br><span class="line">            service.getClusterMap().put(instance.getClusterName(), cluster);</span><br><span class="line">            Loggers.SRV_LOG</span><br><span class="line">                    .warn(<span class="string">&quot;cluster: &#123;&#125; not found, ip: &#123;&#125;, will create new cluster with default configuration.&quot;</span>,</span><br><span class="line">                            instance.getClusterName(), instance.toJson());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) &#123;</span><br><span class="line">            instanceMap.remove(instance.getDatumKey());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 添加到临时的Map中</span></span><br><span class="line">            instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));</span><br><span class="line">            instanceMap.put(instance.getDatumKey(), instance);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (instanceMap.size() &lt;= <span class="number">0</span> &amp;&amp; UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD.equals(action)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">&quot;ip list can not be empty, service: &quot;</span> + service.getName() + <span class="string">&quot;, ip list: &quot;</span> + JacksonUtils</span><br><span class="line">                        .toJson(instanceMap.values()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回更新后的Instance列表，注意，此时还未更新service的cluster与consistencyService</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(instanceMap.values());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述方法返回了加入新的Instance后的所有Instance列表，它是基于consistencyService中存储的Instance为基准进行更新的，经过该方法，如果需要添加的Instance的集群是不存在的，则新建一个Cluster。</p>
<p>上述方法返回后，然后将更新后的Instance列表更新至各个map当中，addInstance中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consistencyService.put(key, instances);</span><br></pre></td></tr></table></figure>

<p>在一般的情况下，consistencyService为DistroConsistencyServiceImpl类的对象，该类是ConsistencyService的实现类，这个接口对于数据同步非常重要，后续再分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Record value)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">  onPut(key, value);</span><br><span class="line">  taskDispatcher.addTask(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPut</span><span class="params">(String key, Record value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将某个service的所有Instances更新到consistencyService的dataStore</span></span><br><span class="line">    <span class="keyword">if</span> (KeyBuilder.matchEphemeralInstanceListKey(key)) &#123;</span><br><span class="line">        Datum&lt;Instances&gt; datum = <span class="keyword">new</span> Datum&lt;&gt;();</span><br><span class="line">        datum.value = (Instances) value;</span><br><span class="line">        datum.key = key;</span><br><span class="line">        datum.timestamp.incrementAndGet();</span><br><span class="line">        dataStore.put(key, datum);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断service对应的实例列表是否添加了监听，我们在前面createEmptyService中添加了监听</span></span><br><span class="line">    <span class="keyword">if</span> (!listeners.containsKey(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加数据发生变化的事件</span></span><br><span class="line">    notifier.addTask(key, ApplyAction.CHANGE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一方法主要是更新dataStore中的Instances列表，并且添加一个数据变化的事件到一个Queue中，在Nacos服务端会有线程不停的判断是否有事件，有事件就会取出去触发监听者，其中本地的serviceMap中的Cluster监听到该事件会同步数据到Cluster中的Instances集合中，即完成了服务注册的流程。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Nacos源码(2)-服务注册流程</p><p><a href="http://example.com/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/">http://example.com/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>tomcode</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-10-30</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-11-05</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/nacos/">nacos</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/11/05/JAVA%E5%B9%B6%E5%8F%91-AQS/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">JAVA并发-AQS</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/29/Nacos%E6%BA%90%E7%A0%81(1)-Nacos%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8/"><span class="level-item">Nacos源码(1)-Nacos服务端源码启动</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://gitee.com/leizz1/pictures/raw/master/null/AF32230B-6341-40A5-BADE-7C898E5E858B(20190701-101.JPG" alt="tomcode"></figure><p class="title is-size-4 is-block line-height-inherit">tomcode</p><p class="is-size-6 is-block">努力努力再努力</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/MrZhangL" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget is-sticky" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#客户端的服务发现与注册"><span class="mr-2">1</span><span>客户端的服务发现与注册</span></a></li><li><a class="is-flex" href="#服务端服务注册"><span class="mr-2">2</span><span>服务端服务注册</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JVM/"><span class="level-start"><span class="level-item">JVM</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="level-start"><span class="level-item">Java多线程</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Netty/"><span class="level-start"><span class="level-item">Netty</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/SSM/"><span class="level-start"><span class="level-item">SSM</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="level-start"><span class="level-item">分布式</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-11-19T04:55:12.000Z">2020-11-19</time></p><p class="title is-6"><a class="link-muted" href="/2020/11/19/JAVA%E5%B9%B6%E5%8F%91-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8BThreadPoolExecutor/">JAVA并发-线程池之ThreadPoolExecutor</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Java多线程</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-11-06T11:24:35.000Z">2020-11-06</time></p><p class="title is-6"><a class="link-muted" href="/2020/11/06/Nacos%E6%BA%90%E7%A0%81(3)-Distro%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/">Nacos源码(3)-Distro数据同步</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-11-05T07:24:35.000Z">2020-11-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/11/05/JAVA%E5%B9%B6%E5%8F%91-AQS/">JAVA并发-AQS</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Java多线程</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-10-30T13:51:55.000Z">2020-10-30</time></p><p class="title is-6"><a class="link-muted" href="/2020/10/30/Nacos%E6%BA%90%E7%A0%81(2)-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/">Nacos源码(2)-服务注册流程</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-10-29T10:16:35.000Z">2020-10-29</time></p><p class="title is-6"><a class="link-muted" href="/2020/10/29/Nacos%E6%BA%90%E7%A0%81(1)-Nacos%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8/">Nacos源码(1)-Nacos服务端源码启动</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mybatis/"><span class="tag">mybatis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nacos/"><span class="tag">nacos</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/netty/"><span class="tag">netty</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tag">多线程</span><span class="tag is-grey-lightest">5</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="MrZhang" height="28"></a><p class="size-small"><span>&copy; 2020 tomcode</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/MrZhangL"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>