{"pages":[{"title":"tags","text":"","link":"/tags/index.html"},{"title":"categories","text":"","link":"/categories/index.html"}],"posts":[{"title":"Nettyæ ¸å¿ƒç»„ä»¶-ByteBuf","text":"JDKæä¾›çš„Bufferç±»å®åœ¨å¤ªéš¾ç”¨ï¼Œä¾‹å¦‚è¯»å†™æ“ä½œåˆ‡æ¢éœ€è¦flip()ï¼ŒDirectByteBufferä½¿ç”¨èµ·æ¥ä¸æ–¹ä¾¿ã€‚å› æ­¤Nettyè‡ªå·±æä¾›äº†ä¸€å¥—ç¼“å†²åŒºçš„ByteBufç±»æ¥æ–¹ä¾¿çš„è¿›è¡Œç¼“å†²åŒºæ“ä½œï¼Œåœ¨åŠŸèƒ½ä¸Šä¸NIOçš„ByteBufferæ˜¯ç›¸åŒçš„ã€‚ æ¦‚è¿°Nettyæä¾›çš„ByteBufä¼˜ç‚¹æœ‰å¦‚ä¸‹ï¼š å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„ç¼“å†²åŒºç±»å‹æ‰©å±• é€šè¿‡å†…ç½®çš„ç¬¦åˆç¼“å†²åŒºç±»å‹å®ç°äº†é€æ˜çš„é›¶æ‹·è´ å®¹é‡å¯ä»¥æŒ‰éœ€å¢é•¿ åœ¨è¯»å’Œå†™è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨ #flip() æ–¹æ³• è¯»å’Œå†™ä½¿ç”¨äº†ä¸åŒçš„ç´¢å¼• æ”¯æŒæ–¹æ³•çš„é“¾å¼è°ƒç”¨ æ”¯æŒå¼•ç”¨è®¡æ•° æ”¯æŒæ± åŒ– ByteBufåŸºç¡€â€‹ ByteBufæ˜¯Nettyæœ‰å…³ç¼“å†²åŒºç±»çš„æŠ½è±¡åŸºç±»ï¼Œæ‰€æœ‰çš„ç¼“å†²åŒºç±»éƒ½æ˜¯ç»§æ‰¿è‡ªè¯¥ç±»ï¼Œè¯¥ç±»çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯æŠ½è±¡çš„ï¼ŒByteBufå¯¹å­—èŠ‚æ•°ç»„çš„æ“ä½œæ¯”NIOçš„ByteBufferæ–¹ä¾¿ã€çµæ´»çš„å¤šã€‚ è¯»å†™æ¨¡å¼ByteBufä¸­æœ‰å¦‚ä¸‹é‡è¦å±æ€§(è¿™å‡ ä¸ªå±æ€§æ²¡æœ‰åœ¨ByteBufä¸­ç»™å‡ºè€Œæ˜¯åœ¨AbstractByteBufä¸­ç»™å‡ºï¼Œä½†æ˜¯ByteBufä¸­å®šä¹‰äº†è·å–è¿™äº›å±æ€§çš„æ–¹æ³•)ï¼š readerIndexï¼šè¯»ç´¢å¼• writerIndexï¼šå†™ç´¢å¼• capacityï¼šå­—èŠ‚æ•°ç»„çš„å½“å‰å®¹é‡ maxCapacityï¼šå­—èŠ‚æ•°ç»„çš„æœ€å¤§å®¹é‡ï¼Œå½“writerIndexè¶…è¿‡capacityæ—¶ï¼Œå¯ä»¥è‡ªåŠ¨åœ°æ‰©å®¹ï¼Œæ¯æ¬¡ä¸º2*capacityï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡maxCapacity ByteBufå¼•å…¥äº†readerIndexå’ŒwriterIndexæ¥å°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†å¼€è¿›è¡Œç´¢å¼•ï¼Œé¿å…äº†NIOçš„ByteBufferåœ¨è¯»å†™åˆ‡æ¢æ—¶éœ€è¦flip() å››ä¸ªå¤§å°å…³ç³»å¾ˆç®€å•ï¼šreaderIndex &lt;= writerIndex &lt;= capacity &lt;= maxCapacity ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š 123456+-------------------+------------------+------------------+| discardable bytes | readable bytes | writable bytes || | (CONTENT) | |+-------------------+------------------+------------------+| | | |0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity &lt;= maxCapacity å›¾ä¸­ä¸»è¦æœ‰ä¸‰æ®µæ•°æ®ï¼š Discardable bytes(å¯åºŸå¼ƒæ•°æ®æ®µ)ï¼šåœ¨å†™å…¥åè¢«è¯»å–äº†çš„æ•°æ®ï¼Œä½äº0~readerIndexä¹‹é—´ã€‚ readable bytes(å¯è¯»å–çš„æ•°æ®æ®µ)ï¼šè¯»å–æ“ä½œåªåˆ°äº†readerIndexï¼ŒreaderIndex~writerIndexä¹‹é—´çš„æ•°æ®å†™å…¥äº†ä½†æ²¡æœ‰è¯»å–è¿‡ï¼Œæ‰€ä»¥æ˜¯å¯è¯»å–çš„æ•°æ®ã€‚ writable bytes(å¯å†™çš„æ•°æ®æ®µ)ï¼šå­—èŠ‚æ•°ç»„è¿˜æ²¡æœ‰è¢«å†™æ»¡ï¼Œåœ¨writerIndex~capacityä¹‹é—´çš„ç©ºé—´è¿˜å¯ä»¥å†è¢«å†™å…¥æ•°æ®ã€‚ æ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªå±æ€§ï¼š markReaderIndexï¼šæ ‡è®°è¯»çš„ç´¢å¼•ä½ç½® markWriterIndexï¼šæ ‡è®°å†™çš„ç´¢å¼•ä½ç½® è¿™ä¸¤ä¸ªmarkå±æ€§ä¸NIOä¸­çš„ByteBufferæä¾›çš„markæ ‡è®°ä¸€æ ·ã€‚ è¯»å†™æ“ä½œByteBufä¸­å®šä¹‰äº†å¾ˆå¤šä¸è¯»å†™ç›¸å…³çš„æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233// Byte 1 å­—èŠ‚public abstract byte getByte(int index);public abstract short getUnsignedByte(int index);public abstract ByteBuf setByte(int index, int value);public abstract byte readByte();public abstract short readUnsignedByte();public abstract ByteBuf writeByte(int value);// Int 4 å­—èŠ‚public abstract int getInt(int index);public abstract int getIntLE(int index);public abstract long getUnsignedInt(int index);public abstract long getUnsignedIntLE(int index);public abstract ByteBuf setInt(int index, int value);public abstract ByteBuf setIntLE(int index, int value);public abstract int readInt();public abstract int readIntLE();public abstract long readUnsignedInt();public abstract long readUnsignedIntLE();public abstract ByteBuf writeInt(int value);public abstract ByteBuf writeIntLE(int value);// Byte æ•°ç»„public abstract ByteBuf getBytes(int index, ByteBuf dst);public abstract ByteBuf getBytes(int index, ByteBuf dst, int length);public abstract ByteBuf setBytes(int index, ByteBuf src);public abstract ByteBuf setBytes(int index, ByteBuf src, int length);// Stringpublic abstract CharSequence getCharSequence(int index, int length, Charset charset);public abstract int setCharSequence(int index, CharSequence sequence, Charset charset);public abstract CharSequence readCharSequence(int length, Charset charset);public abstract int writeCharSequence(CharSequence sequence, Charset charset); ä»¥ä¸Šç»™å‡ºäº†éƒ¨åˆ†å…¸å‹çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒByteBufå¯ä»¥æ–¹ä¾¿åœ°è¯»å–/å†™å…¥å„ç§ä¸åŒçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¹¶ä¸”å¾ˆå¤šæ–¹æ³•è¿”å›ByteBufå¯¹è±¡(æœ¬èº«)å¯ä»¥è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚ ä»¥ä¸Šä¸åŒçš„æ–¹æ³•å¯¹readerIndexå’ŒwriterIndexçš„å½±å“æ˜¯ä¸åŒçš„ï¼š #getXXX(index) æ–¹æ³•ï¼Œè¯»å–æŒ‡å®šä½ç½®çš„æ•°æ®ï¼Œä¸æ”¹å˜ readerIndex ç´¢å¼•ã€‚ #readXXX() æ–¹æ³•ï¼Œè¯»å– readerIndex ä½ç½®çš„æ•°æ®ï¼Œä¼šæ”¹æˆ readerIndex ç´¢å¼•ã€‚ #setXXX(index, value) æ–¹æ³•ï¼Œå†™å…¥æ•°æ®åˆ°æŒ‡å®šä½ç½®ï¼Œä¸æ”¹å˜ writeIndex ç´¢å¼•ã€‚ #writeXXX(value) æ–¹æ³•ï¼Œå†™å…¥æ•°æ®åˆ°æŒ‡å®šä½ç½®ï¼Œä¼šæ”¹å˜ writeIndex ç´¢å¼•ã€‚ é‡Šæ”¾æ“ä½œ1234public abstract ByteBuf discardReadBytes(); // é‡Šæ”¾å·²è¯»çš„å­—èŠ‚ç©ºé—´public abstract ByteBuf discardSomeReadBytes(); // é‡Šæ”¾éƒ¨åˆ†å·²è¯»çš„å­—èŠ‚ç©ºé—´public abstract ByteBuf clear(); // æ¸…ç©ºå­—èŠ‚ç©ºé—´ã€‚å®é™…æ˜¯ä¿®æ”¹ readerIndex=writerIndex=0ï¼Œæ ‡è®°æ¸…ç©ºã€‚ discardReadBytes é‡Šæ”¾æ‰€æœ‰çš„å·²è¯»çš„ç©ºé—´ï¼Œç›¸å½“äºæŠŠdiscardableæ®µçš„æ•°æ®éƒ½é‡Šæ”¾æ‰ã€‚ ä¼˜ç‚¹ï¼šè¾¾åˆ°é‡ç”¨åºŸå¼ƒæ®µçš„ç©ºé—´å†…å­˜ã€‚ ç¼ºç‚¹ï¼šé‡Šæ”¾çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡å¤åˆ¶å¯è¯»æ®µåˆ° ByteBuf çš„å¤´éƒ¨ã€‚æ‰€ä»¥ï¼Œé¢‘ç¹é‡Šæ”¾ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ 1234567891011121314151617// é‡Šæ”¾å‰BEFORE discardReadBytes() +-------------------+------------------+------------------+ | discardable bytes | readable bytes | writable bytes | +-------------------+------------------+------------------+ | | | | 0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity===========================================================================// é‡Šæ”¾åAFTER discardReadBytes() +------------------+--------------------------------------+ | readable bytes | writable bytes (got more space) | +------------------+--------------------------------------+ | | |readerIndex (0) &lt;= writerIndex (decreased) &lt;= capacity discardSomeReadBytes é‡Šæ”¾éƒ¨åˆ†ç©ºé—´ï¼Œå–å†³äºå…·ä½“å­ç±»çš„å®ç° clear æ¸…ç©ºå­—èŠ‚ç©ºé—´ã€‚å®é™…æ˜¯ä¿®æ”¹ readerIndex = writerIndex = 0 ï¼Œæ ‡è®°æ¸…ç©ºã€‚ ä¼˜ç‚¹ï¼šé€šè¿‡æ ‡è®°æ¥å®ç°æ¸…ç©ºï¼Œé¿å…ç½®ç©º ByteBuf ï¼Œæå‡æ€§èƒ½ã€‚ ç¼ºç‚¹ï¼šæ•°æ®å®é™…è¿˜å­˜åœ¨ï¼Œå¦‚æœé”™è¯¯ä¿®æ”¹ writerIndex æ—¶ï¼Œä¼šå¯¼è‡´è¯»åˆ°â€œè„â€æ•°æ®ã€‚ 1234567891011121314151617// é‡Šæ”¾å‰BEFORE clear() +-------------------+------------------+------------------+ | discardable bytes | readable bytes | writable bytes | +-------------------+------------------+------------------+ | | | | 0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity=========================================================================== // é‡Šæ”¾åAFTER clear() +---------------------------------------------------------+ | writable bytes (got more space) | +---------------------------------------------------------+ | | 0 = readerIndex = writerIndex &lt;= capacity ByteBufæ ¸å¿ƒå­ç±» æŒ‰å†…å­˜ç±»å‹åˆ†ï¼š HeapByteBuf(å †å†…å­—èŠ‚ç¼“å†²)ï¼šå­—èŠ‚æ•°ç»„ç¼“å†²åŒºä½äºJVMçš„å †åŒºã€‚ç‰¹ç‚¹æ˜¯ç”³è¯·å’Œé‡Šæ”¾æ•ˆç‡è¾ƒé«˜ï¼Œä½†æ˜¯ç¼ºç‚¹ä¸NIOçš„å †å†…ç¼“å†²åŒºä¸€æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œI/Oæ“ä½œæ—¶æ•°æ®ä¸èƒ½ç›´æ¥è¯»/å†™åˆ°å †å†…ç¼“å†²åŒºï¼Œéœ€è¦å…ˆåœ¨å†…æ ¸ç©ºé—´å»ºç«‹ä¸€ä¸ªç¼“å†²åŒºï¼ŒæŠŠç½‘ç»œä¼ è¾“çš„æ•°æ®å†™åˆ°å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºåå†æ‹·è´åˆ°å †å†…çš„ç¼“å†²åŒºï¼Œè¯»å†™çš„æ€§èƒ½æœ‰æŸè€—ã€‚ DirectByteBuf(ç›´æ¥å†…å­˜å­—èŠ‚ç¼“å­˜)ï¼šå­—èŠ‚æ•°ç»„çš„ç¼“å†²ä½äºJVMçš„å †å¤–ç©ºé—´(å…ƒç©ºé—´)ã€‚ç‰¹ç‚¹æ˜¯I/Oè¯»å†™æ•ˆç‡é«˜ï¼Œå› ä¸ºè¯¥ç¼“å†²åŒºå»ºç«‹åœ¨å †å¤–ï¼Œå¹¶ä¸”åˆ©ç”¨mmapçš„ç³»ç»Ÿè°ƒç”¨ä½¿å¾—æ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥è¯»å†™è¯¥ç¼“å†²åŒºçš„æ•°æ®ï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œåƒå †å†…å­—èŠ‚ç¼“å†²é‚£æ ·çš„æ‹·è´ï¼Œæ€§èƒ½æ›´é«˜ã€‚ç¼ºç‚¹æ˜¯ç”±äºä½äºå †å¤–å†…å­˜ï¼Œé‡Šæ”¾å¿…é¡»è§¦å‘Full GCï¼Œè€ŒFull GCå¯¹æ€§èƒ½çš„æŸè€—æ¯”è¾ƒå¤§ï¼Œéœ€è¦åˆç†ä½¿ç”¨ã€‚ å †å†…ç¼“å†²ä¸å †å¤–ç¼“å†²çš„ç»†èŠ‚åœ¨NIOä¸­å·²ç»è¯´æ˜æ¸…æ¥šï¼ŒNettyçš„ç¼“å†²ç±»ä¹Ÿå…·å¤‡ç›¸åŒçš„ç‰¹ç‚¹ï¼Œåœ¨æ­¤ä¸è¯¦ç»†èµ˜è¿°ã€‚ æŒ‰æ˜¯å¦å»ºç«‹å¯¹è±¡æ± åˆ†ï¼š PooledByteBuf(å…·æœ‰å¯¹è±¡æ± )ï¼šè¯¥å­—èŠ‚æ•°ç»„ç¼“å†²åŒºå¯¹è±¡ä½äºç¼“å†²å¯¹è±¡æ± å†…ï¼Œé‡Šæ”¾æ—¶ä¼šè¢«å½’è¿˜åˆ°å¯¹è±¡æ± ä¸­å¾—ä»¥é‡å¤åˆ©ç”¨ï¼Œè¿™æ ·æ¯æ¬¡ä½¿ç”¨ByteBufæ—¶å°±ä¸éœ€è¦é‡æ–°å»åˆ›å»ºå¯¹è±¡ï¼Œç»å¸¸åˆ›å»ºByteBufä¼šè§¦å‘GCï¼Œå°¤å…¶æ˜¯DirectByteBufä¼šè§¦å‘Full GCï¼Œé€ æˆæ€§èƒ½æŸè€—ã€‚ UnpooledByteBuf(ä¸å…·æœ‰å¯¹è±¡æ± )ï¼šå•çº¯åˆ›å»ºä¸€ä¸ªæ–°çš„ByteBufå¯¹è±¡ï¼Œä½¿ç”¨å®Œåå°±ç­‰å¾…GCé‡Šæ”¾ã€‚ç”±äºå¯¹è±¡æ± ç»´æŠ¤ä¸åˆ›å»ºæ¯”è¾ƒéº»çƒ¦ï¼Œä¸éœ€è¦å¤§é‡åˆ›å»ºç¼“å†²åŒºå¯¹è±¡çš„åœ°æ–¹æ¨èä½¿ç”¨UnpooledByteBuf æŒ‰æ˜¯å¦ä½¿ç”¨Unsafeåˆ†ç±»ï¼š ç”±äºJavaä¸èƒ½å¤Ÿä»ç›´æ¥æ“ä½œåº•å±‚ï¼ŒJDKæä¾›äº†sun.misc.Unsafeå¯¹äºåº•å±‚çš„å†…å­˜ä¸çº¿ç¨‹ç›´æ¥æ“ä½œï¼ŒUnsafeè¢«å¹¿æ³›ç”¨äºJDKçš„å®˜æ–¹æºç ä¸­(å¹¶å‘åŒ…)ï¼Œä½†æ˜¯å®˜æ–¹ä¸æ¨èå¼€å‘è€…ä½¿ç”¨ï¼Œå› ä¸ºUnsafeå¯¹äºå†…å­˜ç›´æ¥è¿›è¡Œæ“ä½œï¼Œç”³è¯·çš„å†…å­˜ä¸å—JVMç®¡ç†ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼Œä¸C++çš„new/å’Œdeleteç±»ä¼¼ï¼Œç”³è¯·çš„ç©ºé—´å¦‚æœä¸æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¾¿ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ ä½¿ç”¨Unsafeï¼šç”±äºUnsafeç”³è¯·çš„ç¼“å†²åŒºä½äºJVMå†…å­˜åŒºåŸŸçš„å¤–éƒ¨ï¼Œå®Œå…¨ä¸å—JVMç®¡æ§ï¼Œå³ä¸ä¼šå¯¹GCé€ æˆå½±å“ï¼Œç”³è¯·çš„ç©ºé—´åœ¨ä¸ä½¿ç”¨æ—¶å¯ä»¥ç›´æ¥æ‰‹åŠ¨é‡Šæ”¾ï¼Œå› æ­¤å…·æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚ ä¸ä½¿ç”¨Unasfeï¼šç”³è¯·çš„ç¼“å†²åŒºä½äºJVMå†…å­˜ä¸­(HeapByteBufåœ¨å †å†…ï¼ŒDirectByteBufåœ¨å †å¤–å…ƒç©ºé—´)ï¼Œé¢‘ç¹çš„ç”³è¯·ä¸´æ—¶å¯¹è±¡ä¼šé€ æˆGCå‹åŠ›ï¼Œé¢‘ç¹çš„GCä¼šæŸè€—æ€§èƒ½ã€‚ å…³äºæ•ˆç‡çš„è¯´æ˜ï¼š â€‹ Javaä¸­ï¼Œå‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç”±JVMç®¡ç†çš„ï¼Œæ¯æ¬¡åœ¨ä½¿ç”¨newéƒ½ä¼šåœ¨å †ç©ºé—´åˆ›å»ºä¸€ä¸ªå¯¹è±¡å(ä¸å®Œå…¨ä¸€å®šåœ¨å †ç©ºé—´ï¼ŒJVMé€ƒé€¸åˆ†æå…è®¸å±€éƒ¨å°å¯¹è±¡åˆ›å»ºåœ¨æ ˆåŒº)ï¼Œå¦‚æœè¯¥å±€éƒ¨å¯¹è±¡å¤±å»äº†å¼•ç”¨ï¼Œå¹¶ä¸ä¼šé©¬ä¸Šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯ç­‰åˆ°å†…å­˜å ç”¨åˆ°ä¸€å®šäº‹ä»¶æ‰ä¼šè°ƒç”¨GCè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¯¹è±¡çš„å›æ”¶å¯¹äºç¨‹åºå‘˜è€Œè¨€æ—¶ä¸å¯æ§çš„ã€‚å› æ­¤ï¼Œä¸ä½¿ç”¨Unsafeï¼Œåœ¨é«˜å¹¶å‘çš„ç¯å¢ƒä¸‹ï¼Œå¦‚æœé¢‘ç¹çš„åˆ›å»ºä¸´æ—¶çš„ByteBufï¼ˆå°¤å…¶æ˜¯DirectByteBufï¼‰ï¼Œä¼šé¢‘ç¹çš„è°ƒç”¨GCï¼ˆDirectByteBufè°ƒç”¨çš„æ˜¯Full GCï¼‰ï¼Œè¿™æ— ç–‘å¯¹æ€§èƒ½æœ‰å·¨å¤§çš„æŸå¤±ã€‚è€Œä½¿ç”¨Unsafeå°±åƒå†™C/C++ä¸€æ ·ï¼Œå¯ä»¥æ§åˆ¶ç¼“å†²åŒºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ç”¨çš„æ—¶å€™é©¬ä¸Šé‡Šæ”¾è€Œä¸ç”¨å»éº»çƒ¦GCï¼Œæ•ˆç‡æ›´é«˜ã€‚ â€‹ Unsafeå¯¹äºæ™®é€šçš„å¼€å‘è€…ä¸è¦å»ä½¿ç”¨ï¼Œå› ä¸ºéå¸¸åœ°ä¸å®‰å…¨ï¼Œä¸€æ—¦å‡ºé—®é¢˜å°±ä¼šé€ æˆJVMå´©æºƒã€‚Nettyä¸ºæˆ‘ä»¬å°è£…å¥½äº†Unsafeçš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘Unsafeç¼“å†²åŒºçš„å†…å­˜é‡Šæ”¾ï¼ŒNettyå·²ç»é€šè¿‡å¼•ç”¨è®¡æ•°å’Œå†…å­˜æ³„æ¼æ£€æµ‹æ¥ä¿è¯ç¼“å†²åŒºçš„å†…å­˜é‡Šæ”¾ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚","link":"/2020/09/01/Netty%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-ByteBuf/"},{"title":"å‡½æ•°å¼ç¼–ç¨‹","text":"å‡½æ•°å¼ç¼–ç¨‹åœ¨ç°åœ¨ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹èƒ½ä½¿å¾—ä»£ç æ›´åŠ ç®€æ´ã€‚ 1 ä½¿ç”¨lambdaè¡¨è¾¾å¼&emsp;&emsp;ç°åœ¨æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œç»™å®šä¸€ä¸ªå‘˜å·¥ç±»ï¼ŒåŒ…å«å§“åã€æ€§åˆ«ã€å¹´é¾„ã€å·¥èµ„ï¼Œæƒ³ä»æ‰€æœ‰å‘˜å·¥ä¸­æ‰¾åˆ°æ€§åˆ«ä¸ºç”·ï¼Œæˆ–è€…å¹´é¾„å°äº30å²ï¼Œæˆ–è€…å·¥èµ„å¤§äº5000çš„å‘˜å·¥ï¼ŒæŒ‰ç…§ä»¥å‰çš„æ–¹æ³•æˆ‘ä»¬å¯èƒ½ä¼šè¿™æ ·åšï¼š 12345class Employee{ private String name; private boolean sex; private int age; private int salary; 123456789101112131415161718192021222324252627282930313233public static void main(String[] args) { List&lt;Employee&gt; employees = Arrays.asList( new Employee(&quot;zs&quot;, true, 25, 6000), new Employee(&quot;ls&quot;, true, 35, 9000), new Employee(&quot;ww&quot;, false, 21, 5000), new Employee(&quot;lx&quot;, true, 45, 12000), new Employee(&quot;qs&quot;, false, 33, 7000) ); // æŸ¥æ‰¾å¹´é¾„å°äº30çš„ List&lt;Employee&gt; employeesBelow30 = new ArrayList&lt;&gt;(); for(Employee employee : employees){ if(employee.getAge() &lt; 30){ employeesBelow30.add(employee); } } // æŸ¥æ‰¾æ€§åˆ«ä¸ºç”·çš„ List&lt;Employee&gt; employeesMan = new ArrayList&lt;&gt;(); for(Employee employee : employees){ if(employee.getAge() &lt; 30){ employeesMan.add(employee); } } // æŸ¥æ‰¾å·¥èµ„å¤§äº5000çš„ List&lt;Employee&gt; employeesSalaryExceed5000 = new ArrayList&lt;&gt;(); for(Employee employee : employees){ if(employee.getAge() &lt; 30){ employeesSalaryExceed5000.add(employee); } }} &emsp;&emsp;æˆ–è€…æˆ‘ä»¬å¯ä»¥å†™ä¸‰ä¸ªæ–¹æ³•ï¼šæŒ‰å¹´é¾„ç­›é€‰ã€æŒ‰æ€§åˆ«ç­›é€‰ã€æŒ‰å·¥èµ„ç­›é€‰ï¼Œé‚£æˆ‘ä»¬å¯èƒ½éœ€è¦æä¾›éå¸¸å¤šçš„æ–¹æ³•(ä¾‹å¦‚å¹´é¾„å¤§äºæŸä¸ªå€¼ï¼Œå¹´é¾„å°äºæŸä¸ªå€¼ï¼Œå¹´é¾„åœ¨æŸä¸ªå€¼åˆ°æŸä¸ªå€¼ä¹‹é—´) â€‹ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼+lambdaè¡¨è¾¾å¼ï¼Œè¿™äº›é—®é¢˜éƒ½èƒ½å¤Ÿè½»æ¾è§£å†³ï¼š 12345678910111213141516171819202122232425262728293031323334353637public class Learn1 { public static void main(String[] args) { List&lt;Employee&gt; employees = Arrays.asList( new Employee(&quot;zs&quot;, true, 25, 6000), new Employee(&quot;ls&quot;, true, 35, 9000), new Employee(&quot;ww&quot;, false, 21, 5000), new Employee(&quot;lx&quot;, true, 45, 12000), new Employee(&quot;qs&quot;, false, 33, 7000) ); // æŸ¥æ‰¾å¹´é¾„å°äº30çš„ List&lt;Employee&gt; employeesBelow30 = filter(employees, e -&gt; e.getAge() &lt; 30); // æŸ¥æ‰¾æ€§åˆ«ä¸ºç”·çš„ List&lt;Employee&gt; employeesMan = filter(employees, e -&gt; e.isSex()); // æŸ¥æ‰¾å·¥èµ„å¤§äº5000çš„ List&lt;Employee&gt; employeesSalaryExceed5000 = filter(employees, e -&gt; e.getSalary() &gt; 5000); } public static List&lt;Employee&gt; filter(List&lt;Employee&gt; employees, EmployeeOperater&lt;Employee&gt; employeeFilter){ List&lt;Employee&gt; employeesMeetCondition = new ArrayList&lt;&gt;(); for(Employee employee : employees) { if(employeeFilter.filter(employee)){ employeesMeetCondition.add(employee); } } return employeesMeetCondition; }}@FunctionalInterfaceinterface EmployeeOperater&lt;T&gt;{ boolean filter(T t);} &emsp;&emsp;è¿™æ ·ä¸€æ¥æˆ‘ä»¬çš„ä»£ç ä¼šä¼˜é›…ã€ç®€æ´å¾ˆå¤šï¼Œæˆ‘ä»¬æ— éœ€å†å‘ä¸Šè¿°ä»£ç ä¸€æ ·æ¯æ¬¡éƒ½å»å†™éå†çš„ä»£ç ï¼Œä¹Ÿæ— éœ€ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿å»ç¼–å†™å¤ªå¤šé‡å¤çš„ç­›é€‰æ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„æŸ¥è¯¢éœ€æ±‚æ¥åˆ¶å®šæŸ¥è¯¢ç­–ç•¥å³å¯ã€‚ &emsp;&emsp;åç»­ä½¿ç”¨Stream APIè¿˜æœ‰æ›´ç®€ä¾¿çš„æ–¹å¼ï¼Œæ— éœ€å†™æ¥å£ä¸filteræ–¹æ³•ã€‚ Lambdaè¡¨è¾¾å¼çš„ä½¿ç”¨å¿…é¡»é…åˆæ¥å£ï¼Œå¹¶ä¸”åªå«æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œæ ¼å¼ï¼š 123456@FunctionalInterfacepublic interface æ¥å£å{ public abstract void å‡½æ•°å(); //åªèƒ½æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³• // ... // ä¸‹é¢å¯ä»¥æœ‰é»˜è®¤æ–¹æ³•ç­‰ï¼Œåªéœ€è¦ä¿è¯åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•å³å¯} â€‹ å¦‚æœåœ¨æ¥å£å†…å®šä¹‰äº†å¤šä¸ªæŠ½è±¡æ–¹æ³•æˆ–ä¸å®šä¹‰æŠ½è±¡æ–¹æ³•ï¼Œåˆ™ä¸æ˜¯å‡½æ•°å¼æ¥å£ï¼Œé‡‡ç”¨@FunctionalInterfaceæ³¨è§£å¯ä»¥æ£€æŸ¥æ˜¯å¦ä¸ºå‡½æ•°å¼æ¥å£ï¼Œè‹¥ä¸æ˜¯åˆ™åœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ã€‚ 2 JDKæä¾›çš„å…³äºlambdaè¡¨è¾¾å¼çš„å››å¤§å‡½æ•°å¼æ¥å£ Consumer&lt;T&gt; æ¶ˆè´¹å‹æ¥å£ void accept(T t); Supplier&lt;T&gt; ä¾›ç»™å‹æ¥å£ T get(); Function&lt;T, R&gt; å‡½æ•°å‹æ¥å£ R apply(T t); Predicate&lt;T&gt; æ–­è¨€å‹æ¥å£ boolean test(T t); 3 æ–¹æ³•å¼•ç”¨å’Œæ„é€ å™¨å¼•ç”¨&emsp;&emsp;åœ¨ä½¿ç”¨lambdaè¡¨è¾¾å¼æ—¶ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½éœ€è¦å»å®ç°æ¥å£çš„æ–¹æ³•ï¼Œè¿™æ ·å¯èƒ½ä¼šæ¯”è¾ƒéº»çƒ¦ï¼ŒJDKæä¾›äº†æ–¹æ³•å¼•ç”¨æ¥æ›´åŠ ä¾¿æ·çš„ä½¿ç”¨lambdaè¡¨è¾¾å¼ï¼Œå³ç›´æ¥å°†å·²æœ‰çš„æ–¹æ³•ä½œä¸ºå‡½æ•°å¼æ¥å£çš„å®ç°ï¼Œæ–¹æ³•å¼•ç”¨æœ‰å¦‚ä¸‹å‡ ç§å½¢å¼ï¼š ç±»å::é™æ€æ–¹æ³•å å¯¹è±¡::å®ä¾‹æ–¹æ³•å ç±»å::å®ä¾‹æ–¹æ³•å 12345678910111213141516public static void main(String[] args) { // å¯¹è±¡::å®ä¾‹æ–¹æ³•å================ List&lt;Integer&gt; list = Arrays.asList(2,3,4,1,5); PrintStream printStream = System.out; Consumer&lt;Integer&gt; consumer = printStream::println; list.forEach(consumer); // ä¸Šé¢ä¸‰è¡Œå˜ä¸ºä¸€è¡Œ list.forEach(System.out::println); // foreachéœ€è¦æä¾›Consumeræ¥å£çš„å®ç° // ç±»å::é™æ€æ–¹æ³•å Comparator&lt;Integer&gt; comparable = Integer::compare; // T compare(T t1, T t2); // ç±»å::å®ä¾‹æ–¹æ³•åï¼Œæ³¨æ„è¿™ç§å½¢å¼æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œåœ¨æ­¤ä¾‹ä¸­ï¼Œå³ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¢«å¼•ç”¨æ–¹æ³•çš„å‚æ•°ã€‚ BiPredicate&lt;String, String&gt; predicate0 = (x, y) -&gt; x.equals(y); BiPredicate&lt;String, String&gt; predicate = String::equals; // boolean test(T t1, T t2);} æ„é€ å™¨å¼•ç”¨ï¼š ç±»å::new &emsp;&emsp;æ„é€ å™¨å¼•ç”¨å…¶å®ä¸æ–¹æ³•å¼•ç”¨ç±»ä¼¼ï¼Œä¸€ä¸ªç±»å¯èƒ½æœ‰å¤šä¸ªæ„é€ å™¨ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨é€‰æ‹©ä¸æ¥å£å‚æ•°ç›¸åŒ¹é…çš„æ„é€ å™¨æ–¹æ³•ã€‚ 1Supplier&lt;Employee&gt; supplier = Employee::new; // ç”±äºSupplieræ¥å£çš„æ–¹æ³•ä¸ºT get()ï¼Œæ‰€ä»¥è‡ªåŠ¨é€‰æ‹©çš„æ˜¯æ— å‚æ„é€ å™¨","link":"/2020/05/22/han-shu-shi-bian-cheng/"},{"title":"HashMap","text":"Javaä¸­çš„HashMapçš„åŸç†å°±æ˜¯å“ˆå¸Œè¡¨ï¼Œå®ç°ä¸»è¦æ˜¯é€šè¿‡æ•°ç»„+é“¾è¡¨(æˆ–çº¢é»‘æ ‘)ã€‚ é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„(é»˜è®¤å¤§å°ä¸º16)ï¼Œå½“å‘å…¶ä¸­æ’å…¥key-valueé”®å€¼å¯¹æ—¶ï¼Œä¼šæ ¹æ®keyé€šè¿‡æ•£åˆ—ç®—æ³•è®¡ç®—å“ˆå¸Œå€¼ï¼Œè®¡ç®—å‡ºçš„å“ˆå¸Œå€¼ä¸ºè¯¥å…ƒç´ å‚¨å­˜åœ¨æ•°ç»„ä¸­çš„ä½ç½®(å› æ­¤å“ˆå¸Œå€¼å¿…é¡»ä¸ºåˆæ³•çš„ç´¢å¼•)ã€‚å¦‚æœè¯¥ä½ç½®ä¸Šå­˜åœ¨äº†å…ƒç´ (é“¾è¡¨)ï¼Œå…ˆæ£€æŸ¥è¯¥é“¾è¡¨ä¸Šæ˜¯å¦æœ‰keyç›¸ç­‰çš„å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å°±å°†è¿™ä¸ªå…ƒç´ ä½œä¸ºé“¾è¡¨èŠ‚ç‚¹è¿æ¥åœ¨è¯¥ä½ç½®å·²å­˜åœ¨å…ƒç´ çš„åé¢ï¼Œæœ‰çš„è¯å°±è¦†ç›–ã€‚ â€‹ â€‹ ä¸€ä¸ªkey-valueå…ƒç´ ä¸ºä¸€ä¸ªEntryå¯¹è±¡ï¼ŒEntryå¯¹è±¡ä¸­å­˜å‚¨äº†ï¼š â€‹ (1)è¯¥å…ƒç´ çš„hashå€¼ â€‹ (2)é”®å€¼key â€‹ (3)value â€‹ (4)ä¸‹ä¸€ä¸ªEntryå¯¹è±¡çš„å¼•ç”¨ â€‹ JDK1.8ä¸­Nodeç±»å³ä¸ºEntryç±»ã€‚ æ•°ç»„çš„åˆå§‹å¤§å°HashMapçš„æ•°ç»„å¤§å°å‡ä¸º2çš„å¹‚æ¬¡æ–¹ï¼Œæ— è®ºä½ ç»™çš„å®¹é‡å¤§å°ä¸ºå¤šå°‘ï¼Œéƒ½ä¼šæ±‚å‡ºå¤§äºç»™å®šåˆå§‹å®¹é‡çš„æœ€å°çš„2çš„å¹‚æ¬¡æ–¹ä½œä¸ºHashmapæ•°ç»„çš„å®¹é‡ã€‚è‡³äºä¸ºä»€ä¹ˆè¦æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œç­‰ä¼šå†ä»‹ç»ï¼Œé¦–å…ˆæ¥çœ‹çœ‹HashMapå¦‚ä½•æ¥æ±‚å–å¤§äºç»™å®šåˆå§‹å®¹é‡çš„æœ€å°çš„2çš„å¹‚æ¬¡æ–¹çš„æ•°å€¼ã€‚ 123456789static final int tableSizeFor(int cap) { int n = cap - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;} æ¯æ¬¡åˆå§‹åŒ–Hashmapæ•°ç»„å¤§å°æ—¶ï¼Œéƒ½ä¼šä½¿ç”¨è¯¥å‡½æ•°æ¥è®¡ç®—æ•°ç»„çš„å¤§å°ï¼Œä¼ å…¥çš„capä¸ºæ„é€ å‡½æ•°ä¼ å…¥çš„åˆå§‹å¤§å°ã€‚ æˆ‘ä»¬å…ˆå¿½è§†n=cap-1ï¼Œæˆ‘ä»¬æ¥çœ‹ä½è¿ç®—ï¼Œé€šè¿‡5æ­¥ä½è¿ç®—ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å¾—ä¸€ä¸ªintç±»å‹æ•°å­—çš„æœ€é«˜ä½æ‰€å¯¹åº”çš„2çš„å¹‚æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯å°äºç»™å®šnçš„æœ€å¤§çš„2çš„å¹‚æ¬¡æ–¹ï¼š3=ã€‹2ï¼Œ10=ã€‹8. ç°åœ¨æˆ‘ä»¬å‡å®šä¸€ä¸ªintç±»å‹çš„æ•°è½¬åŒ–ä¸º2è¿›åˆ¶ä¸º1\\**ï¼Œ\\ä»£è¡¨ä¸ºä»»æ„ä¸€ä¸ªæ•°å­— è¿›è¡Œ&gt;&gt;&gt;1ï¼š01**** æˆ–|ï¼š1\\*** | 01**** = 11**** è¿›è¡Œ&gt;&gt;&gt;2ï¼š0011** æˆ–|ï¼š11**** | 0011** = 1111** è¿›è¡Œ&gt;&gt;&gt;4ï¼š000011 æˆ–|ï¼š1111** | 000011 = 111111 æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ— è®ºæœ€é«˜ä½1åé¢æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬éƒ½èƒ½æŠŠ1çš„æœ€é«˜ä½åé¢éƒ½å˜ä¸º1ï¼Œ&gt;&gt;&gt;1ä¸ä¸€æ¬¡æˆ–æ“ä½œèƒ½ä¿è¯ä»æœ€é«˜ä½ç®—èµ·å‰ä¸¤ä¸ªå‡ä¸º1ï¼Œç»§è€Œ&gt;&gt;&gt;2å’Œæˆ–ä¿è¯å‰4ä¸ªå‡ä¸º1â€¦ï¼Œ&gt;&gt;&gt;16å’Œæˆ–ä¿è¯å‰32ä½éƒ½ä¸º1ï¼Œé‚£ä¹ˆintæœ€é«˜ä½32ä½ï¼Œè¿›è¿‡è¿™å‡ æ­¥åä¸€ä¸ªintçš„æ•°å¿…å®šæ‰€æœ‰ä½éƒ½ä¸º1ã€‚ ä¸ºä»€ä¹ˆå®¹é‡è¦ä¸º2çš„å¹‚æ¬¡æ–¹ï¼Ÿ è¿™æ˜¯ç”±äºjdkåœ¨hashmapä¸­æ±‚keyçš„hashcodeå¯¹åº”çš„æ•°ç»„indexä¸‹æ ‡æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯&amp;è¿ç®—ã€‚æœ¬æ¥æˆ‘ä»¬åº”è¯¥æ˜¯æ±‚hashcode%æ•°ç»„é•¿åº¦lï¼Œä½†æ˜¯å½“æ•°ç»„é•¿åº¦lä¸º2çš„å¹‚æ¬¡æ–¹æ—¶ï¼Œå°±ä¼šæœ‰hashcode%l=hashcode&amp;(l-1)ã€‚&amp;è¿ç®—çš„æ•ˆç‡è¦é«˜äºå–æ¨¡è¿ç®—ã€‚ å½“lä¸º2çš„å¹‚æ¬¡æ–¹å³l=2^nï¼Œåˆ™l-1çš„ä½nä½éƒ½ä¸º1ï¼Œè¿›è¡Œä¸è¿ç®—ååªä¼šä¿ç•™hashcodeçš„ånå°¾ï¼Œånä½å³ä¸ºhashcodeå¯¹lå–ä½™çš„å€¼ã€‚ æ’å…¥å…ƒç´ ç»†èŠ‚åœ¨JDK1.7ä¸­ï¼ŒHashMapè°ƒç”¨putæ–¹æ³•æ˜¯é‡‡ç”¨å¤´æ’æ³•å°†å…ƒç´ åŠ å…¥å¯¹åº”çš„é“¾è¡¨(å•å‘é“¾è¡¨)ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨Hashç®—æ³•è®¡ç®—å‡ºHashcodeå€¼ï¼Œæ±‚å‡ºæ’å…¥çš„keyåº”è¯¥å­˜å‚¨åœ¨æ•°ç»„ä¸­å“ªä¸ªä¸‹æ ‡å¯¹åº”çš„é“¾è¡¨ä¸­ï¼Œç„¶åéå†æŸ¥è¯¢è¯¥é“¾è¡¨ï¼Œå¦‚æœé“¾è¡¨ä¸­ä¸å­˜åœ¨æ’å…¥çš„keyï¼Œé‚£ä¹ˆå°±åœ¨é“¾è¡¨çš„å¤´éƒ¨æ’å…¥è¯¥å…ƒç´ ã€‚ é‡‡ç”¨å¤´æ’æ³•çš„åŸå› æ˜¯å› ä¸ºé“¾è¡¨æ˜¯å•å‘é“¾è¡¨ï¼Œå¦‚æœæ’å…¥åˆ°å°¾éƒ¨çš„å¤æ‚åº¦ä¸ºO(n)ï¼Œnä¸ºé“¾è¡¨çš„é•¿åº¦ï¼Œå¦‚æœæ’å…¥åˆ°å¤´éƒ¨ï¼Œå¤æ‚åº¦ä¸ºO(1)ã€‚ ä½†æ˜¯å…¶å®å¦‚æœéœ€è¦å‘é“¾è¡¨ä¸­æ’å…¥æ–°çš„å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦éå†é“¾è¡¨å»è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦éå†æ‰€å…ƒç´ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œç„¶åæ’å…¥ï¼›å¦‚æœè¿™ä¸ªkeyå­˜åœ¨é‚£ä¹ˆæˆ‘ä»¬åªæ˜¯ä¿®æ”¹keyæ‰€åœ¨é“¾è¡¨èŠ‚ç‚¹å¯¹åº”çš„valueå³å¯ï¼Œä¸éœ€è¦å†è¿›è¡Œéå†ï¼Œå› æ­¤å¤´æ’æ³•å’Œå°¾æ’æ³•å‡ ä¹æ²¡æœ‰å·®åˆ«ã€‚JDK1.7é‡‡ç”¨çš„å¤´æ’æ³•ï¼Œè€ŒJDK1.8åˆ™é‡‡ç”¨å°¾æ’æ³•ã€‚ JDK1.8åœ¨é“¾è¡¨æ’å…¥çš„é€»è¾‘ä¸Šä¸JDK1.7ç±»ä¼¼ï¼Œåªæ˜¯é‡‡ç”¨å°¾æ’æ³•ã€‚ä½†æ˜¯JDK1.8åœ¨é“¾è¡¨é•¿åº¦å¤§äº8æ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œçº¢é»‘æ ‘çš„æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾æ•ˆç‡å‡ä¸ºO(logn)ï¼Œåœ¨JDK1.8ä¸­ï¼Œä¸€é¢—çº¢é»‘æ ‘åŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå› ä¸ºTreeNodeä¹Ÿæ˜¯ç»§æ‰¿äº†Nodeã€‚å¦‚æœåƒJDK1.7åªé‡‡ç”¨é“¾è¡¨ï¼Œé‚£ä¹ˆåœ¨é“¾è¡¨ä¸ŠæŸ¥è¯¢æ•ˆç‡ä¸ºO(n)ï¼Œåœ¨è¿™é‡ŒnæŒ‡é“¾è¡¨é•¿åº¦ï¼Œä¸æ˜¯HashMapçš„å¤§å°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445// JDK1.8ä¸­çš„putfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) { Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; if ((tab = table) == null || (n = tab.length) == 0) // æ•°ç»„è¿˜æ²¡åˆå§‹åŒ– n = (tab = resize()).length; if ((p = tab[i = (n - 1) &amp; hash]) == null) // æ ¹æ®hashå€¼æ±‚å‡ºåœ¨æ•°ç»„ä¸Šåº”è¯¥å­˜å‚¨çš„ä½ç½®ï¼Œæ•°ç»„å¯¹åº”ä½ç½®ä¸Šæ²¡æœ‰å…ƒç´ å°±ç›´æ¥èµ‹å€¼ tab[i] = newNode(hash, key, value, null); else { // æ•°ç»„å¯¹åº”ä½ç½®ä¸Šæœ‰å…ƒç´  Node&lt;K,V&gt; e; K k; if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) // å¦‚æœå¤´ç»“ç‚¹çš„keyä¸æ’å…¥çš„keyç›¸åŒï¼Œå°±ç›´æ¥ä¿®æ”¹å³å¯ e = p; else if (p instanceof TreeNode) // å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ç±»å‹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œæ„å‘³ç€è¯¥ä½ç½®å·²ç»è½¬åŒ–ä¸ºçº¢é»‘æ ‘äº† e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value); // é€šè¿‡çº¢é»‘æ ‘æ·»åŠ çš„æ–¹æ³•å»æ·»åŠ èŠ‚ç‚¹æˆ–ä¿®æ”¹èŠ‚ç‚¹ï¼Œkeyå·²ç»å­˜åœ¨å°±è¿”å›å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¸å­˜åœ¨è¿”å›null else { for (int binCount = 0; ; ++binCount) { // è¯¥ä½ç½®ä¸ºé“¾è¡¨å½¢å¼ï¼Œéå†é“¾è¡¨ if ((e = p.next) == null) { p.next = newNode(hash, key, value, null); // å¦‚æœéå†åˆ°é“¾è¡¨å°¾éƒ¨äº†è¿˜ä¸å­˜åœ¨putçš„keyï¼Œå°±æŠŠè¿™ä¸ªèŠ‚ç‚¹æ’åœ¨å°¾éƒ¨ // åˆ¤æ–­èŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äº8ï¼ŒbinCountæ­¤æ—¶æ²¡æœ‰åŠ ä¸Šæ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼ŒTREEIFY_THRESHOLDä¸º8ï¼Œå³binCount&gt;=7ï¼Œè½¬åŒ–æ—¶é“¾è¡¨é•¿åº¦ä¸ºbinCount+1+1ï¼Œ1ä¸ªä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹ if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); // å°†è¯¥é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ break; } // å¦‚æœé“¾è¡¨ä¸­å­˜åœ¨è¯¥keyï¼Œå°±ç›´æ¥ä¿®æ”¹ if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) break; p = e; } } if (e != null) { // existing mapping for key // å¦‚æœå­˜åœ¨è¿™ä¸ªkeyï¼Œå°±ä¿®æ”¹å¯¹åº”çš„valueå³å¯ V oldValue = e.value; if (!onlyIfAbsent || oldValue == null) e.value = value; afterNodeAccess(e); return oldValue; } } ++modCount; // ä¿®æ”¹æ¬¡æ•°+1 if (++size &gt; threshold) resize(); // è¶…è¿‡å®¹é‡å°±æ‰©å®¹ afterNodeInsertion(evict); return null;} çº¢é»‘æ ‘çš„å…·ä½“ç»†èŠ‚å‚è€ƒJDKæºç è®²è§£çš„TreeMapã€‚ æ‰©å®¹ç»†èŠ‚JDK1.7ä¸JDK1.8æ‰©å®¹çš„æ€è·¯ç±»ä¼¼ï¼Œåªæ˜¯JDK1.8ä¸­æ‰©å®¹æ—¶éœ€è¦è€ƒè™‘çº¢é»‘æ ‘çš„æ‰©å®¹ï¼Œåœ¨æ­¤ç›´æ¥ä»‹ç»JDK1.8çš„æ‰©å®¹ã€‚ å½“HashMapçš„sizeåˆ°è¾¾é˜ˆå€¼(é˜ˆå€¼é€šå¸¸ä¸ºè´Ÿè½½å› å­*å®¹é‡capicity)ï¼ŒHashMapçš„æ•°ç»„å°±ä¼šæ‰©å®¹ï¼Œæ‰©å®¹ä¸»è¦æ˜¯è§£å†³hashå†²çªï¼Œæ˜¯çš„æ¯ä¸ªæ•°ç»„å¯¹åº”çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„é•¿åº¦å˜å°ï¼Œæé«˜å¢åˆ æ”¹æŸ¥æ•ˆç‡ã€‚ ç”±å‰é¢çš„æ•°ç»„åˆå§‹åŒ–æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ•°ç»„çš„å®¹é‡ä¸€å®šä¸º2çš„å¹‚æ¬¡æ–¹ï¼Œå¹¶ä¸”æ‰©å®¹æ—¶å°±æ˜¯å°†å®¹é‡å˜ä¸ºåŸæ¥çš„2å€ã€‚é‚£ä¹ˆï¼Œåœ¨æ•°ç»„æ‰©å®¹åéœ€è¦å¯¹æ¯ä¸ªèŠ‚ç‚¹é‡æ–°è®¡ç®—åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œä¸è¿‡ï¼Œç”±äºæ•°ç»„å®¹é‡æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸€ä¸ªèŠ‚ç‚¹åœ¨æ‰©å®¹å‰çš„ä½ç½®ä¸æ‰©å®¹åçš„ä½ç½®ï¼Œè®¾æ‰©å®¹å‰å¤§å°ä¸º16ï¼Œæ‰©å®¹åä¸º32ã€‚ æ‰©å®¹å‰ï¼šhash&amp;(16-1)=hash&amp;1111 æ‰©å®¹åï¼šhash&amp;(32-1)=hash&amp;11111 æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰©å®¹å‰å’Œæ‰©å®¹åçš„åœ¨æ•°ç»„ä¸­ç´¢å¼•å¯¹åº”çš„äºŒè¿›åˆ¶åå››ä½éƒ½ç›¸åŒï¼Œåªæœ‰ç¬¬äº”ä½ä¼šå­˜åœ¨å·®å¼‚ã€‚å¦‚æœhashå€¼çš„ç¬¬äº”ä½ä¸º0ï¼Œé‚£ä¹ˆæ‰©å®¹å‰å’Œæ‰©å®¹åçš„ç´¢å¼•ç›¸åŒï¼Œå¦‚æœhashå€¼çš„ç¬¬äº”ä½ä¸º1ï¼Œé‚£ä¹ˆæ‰©å®¹åçš„ç´¢å¼•ä¸ºæ‰©å®¹å‰çš„ç´¢å¼•+16ã€‚åˆ¤æ–­æ˜¯å¦åº”è¯¥+16åªéœ€è¦è®¡ç®—hash&amp;16ï¼Œå¦‚æœä¸º0å°±ä¸å˜ï¼Œå¦‚æœä¸º1å°±æ”¹å˜ã€‚ å› æ­¤å¯¹äºä»»æ„çš„æ‰©å®¹ï¼Œå¦‚æœæ‰©å®¹å‰æ•°ç»„çš„å¤§å°ä¸º2^nï¼ŒèŠ‚ç‚¹çš„ç´¢å¼•ä¸ºiï¼Œé‚£ä¹ˆæ‰©å®¹åèŠ‚ç‚¹çš„ç´¢å¼•åªå¯èƒ½ä¸ºiæˆ–i+2^nï¼Œè‹¥hash&amp;2^n=0ï¼Œåˆ™æ‰©å®¹åèŠ‚ç‚¹ç´¢å¼•ä»ç„¶ä¸ºiï¼›å¦‚æœhash&amp;2^n=1ï¼Œåˆ™æ‰©å®¹åç´¢å¼•ä¸ºi+2^nã€‚ åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œåœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œå¯¹äºæ¯ä¸€ä¸ªé“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼Œéƒ½å¯ä»¥æ‹†è§£ä¸ºä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªé“¾è¡¨ä¸ºç´¢å¼•ä¸å˜çš„èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªé“¾è¡¨ä¸ºç´¢å¼•å˜åŒ–çš„èŠ‚ç‚¹ï¼Œåœ¨è½¬ç§»æ•°æ®æ—¶åªéœ€è¦æŠŠè¿™ä¸¤ä¸ªé“¾è¡¨(å¦‚æœæ‹†è§£åçš„é“¾è¡¨é•¿åº¦å¤§äº8éœ€è¦è½¬åŒ–ä¸ºçº¢é»‘æ ‘)æ”¾ç½®åœ¨æ–°çš„æ•°ç»„ä¸­å³å¯ï¼Œè¿™æ ·å…·æœ‰è¾ƒé«˜çš„æ‰©å®¹æ•ˆç‡ï¼Œè¿™ä¹Ÿæ˜¯HashMapæ•°ç»„é•¿åº¦è¦ä¸º2çš„å¹‚æ¬¡æ–¹çš„åŸå› ä¹‹ä¸€ã€‚ JDKå®ç°çš„HashMapçš„è´Ÿè½½å› å­é»˜è®¤ä¸º0.75ï¼Œä¸ºä»€ä¹ˆæ˜¯0.75å‘¢ï¼Ÿ â€‹ HashMapçš„è´Ÿè½½å› å­ç”¨äºå½“å…ƒç´ æ€»ä¸ªæ•°å¤§äºè´Ÿè½½å› å­*æ•°ç»„é•¿åº¦æ—¶ï¼Œå°±è¿›è¡Œæ‰©å®¹æ“ä½œã€‚è´Ÿè½½å› å­å°±æ˜¯ç”¨æƒè¡¡ç©ºé—´åˆ©ç”¨ç‡å’Œæ“ä½œå…ƒç´ æ•ˆç‡çš„ï¼š å½“è´Ÿè½½å› å­è¾ƒå°æ—¶ï¼Œè¿™æ ·ä¸€æ¥æ¯ä¸ªæ¡¶(æ•°ç»„é“¾è¡¨)æ‰€å­˜æ”¾çš„å…ƒç´ æ•°é‡ç›¸å¯¹æ›´å°‘ï¼Œå…ƒç´ æ“ä½œé€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ï¼Œå¹¶ä¸”å¦‚æœé¢‘ç¹çš„æ’å…¥å…ƒç´ ï¼ŒHashMapçš„æ‰©å®¹æ“ä½œä¼šæ›´åŠ é¢‘ç¹ï¼Œæ‰©å®¹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œä¼šé€ æˆæ•ˆç‡ä½ä¸‹ å½“è´Ÿè½½å› å­è¾ƒå¤§æ—¶ï¼Œæ¯ä¸ªæ¡¶å­˜æ”¾çš„å…ƒç´ æ•°é‡ç›¸å¯¹æ›´å¤šï¼Œå…ƒç´ æ“ä½œçš„é€Ÿåº¦ç›¸å¯¹æ›´æ…¢ï¼Œä½†æ˜¯ç©ºé—´èŠ‚çœï¼Œå¹¶ä¸”é¢‘ç¹æ’å…¥å…ƒç´ HashMapçš„æ‰©å®¹ä¹Ÿä¼šå°‘ä¸€äº› åœ¨HashMapçš„æºç ä¸­æåˆ°ï¼Œå‡è®¾keyçš„hashcodeéšæœºï¼Œæ¯ä¸ªæ¡¶ä¸­æ”¾å…¥èŠ‚ç‚¹çš„é¢‘ç‡æ»¡è¶³ä»¥0.5ä¸ºå‚æ•°çš„æ³Šæ¾åˆ†å¸ƒï¼Œåœ¨è´Ÿè½½å› å­ä¸º0.75çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ¡¶ä¸­å‡ºç°å…ƒç´ ä¸ªæ•°çš„æ¦‚ç‡å¦‚ä¸‹ï¼š 12345678910* 0: 0.60653066* 1: 0.30326533* 2: 0.07581633* 3: 0.01263606* 4: 0.00157952* 5: 0.00015795* 6: 0.00001316* 7: 0.00000094* 8: 0.00000006* more: less than 1 in ten million â€‹ è¿™æ„å‘³ç€å½“ç„¶å…ƒç´ ä¸ªæ•°å¤§äº8çš„æ¦‚ç‡éå¸¸ä½ï¼Œå› æ­¤è´Ÿè½½å› å­ä¸º0.75æ¯”è¾ƒå¥½ã€‚å½“ç„¶JDKè€ƒè™‘åˆ°äº†hashcodeå¹¶ä¸ä¸€å®šå®Œå…¨éšæœºï¼Œå› æ­¤å½“å…ƒç´ å¤§äº8æ—¶ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘æ¥æé«˜æ•ˆç‡ã€‚","link":"/2020/06/20/hashmap/"},{"title":"Nettyä¸­çš„ChannelOptioné…ç½®","text":"æœ€è¿‘åœ¨å­¦åˆ°nettyæ˜¯å‘ç°ServerBootstrap/Bootstrapç±»ä¸­æœ‰optionçš„é…ç½®ï¼Œå‘ç°optionæ˜¯é…ç½®åœ¨Channelä¸Šä¸socketæ ‡å‡†ç›¸å…³çš„å‚æ•°ï¼Œäºæ˜¯æ€»ç»“ä¸€ä¸‹æœ‰å…³è¯¥å‚æ•°çš„é…ç½®ã€‚ SO_BACKLOGChannelOption.SO_BACKLOGå¯¹åº”çš„æ˜¯tcp/ipåè®®listenå‡½æ•°ä¸­çš„backlogå‚æ•°ï¼Œå‡½æ•°listen(int socketfd,int backlog)ç”¨æ¥åˆå§‹åŒ–æœåŠ¡ç«¯å¯è¿æ¥é˜Ÿåˆ—ã€‚ TCPå»ºç«‹è¿æ¥æ˜¯éœ€è¦æ—¶é—´ï¼Œå¦‚æœä¸€æ®µæ—¶é—´å†…æœ‰å¤§é‡çš„è¿æ¥è¯·æ±‚ï¼Œè®¡ç®—æœºèƒ½å¤Ÿå¤„ç†çš„è¿æ¥æ•°é‡æœ‰é™ï¼Œé‚£ä¹ˆå°±ä¼šå°†è¿™äº›è¯·æ±‚æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚ç”±äºTCPå»ºç«‹è¿æ¥æ˜¯è¦è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹çš„ï¼ŒLinuxä¸­ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—åˆ†åˆ«ä¸ºsyns queueå’Œaccept queueï¼Œåˆ†åˆ«ç”¨äºå‚¨å­˜å¤„äºSYN_RCVD(åŠè¿æ¥ï¼Œç¬¬ä¸€æ¬¡æ¡æ‰‹å)å’ŒESTABLISHED(å»ºç«‹è¿æ¥ï¼Œç¬¬ä¸‰æ¬¡æ¡æ‰‹å)çŠ¶æ€çš„è¿æ¥ã€‚ å½“è¿›è¡Œå®Œç¬¬ä¸€æ¬¡æ¡æ‰‹åï¼ŒæœåŠ¡ç«¯ä¼šå‘èµ·ä¸å®¢æˆ·ç«¯æ¡æ‰‹ï¼Œè¿™æ˜¯è¿™ä¸ªè¿æ¥å°±ä¼šè¢«æ”¾å…¥åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°å®¢æˆ·ç«¯æ¡æ‰‹æˆåŠŸè¿”å›ç»™æœåŠ¡ç«¯å†æ¬¡æ¡æ‰‹æˆåŠŸåï¼Œè¿™ä¸ªè¿æ¥å°±ä¼šè¢«ç§»åˆ°å»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åº”ç”¨ç¨‹åºè°ƒç”¨accept()æ¥è·å–è¿æ¥ã€‚ syns queue é˜Ÿåˆ—é•¿åº¦ç”± /proc/sys/net/ipv4/tcp_max_syn_backlog æŒ‡å®šï¼Œé»˜è®¤ä¸º2048ã€‚ accept queue é˜Ÿåˆ—é•¿åº¦ç”± /proc/sys/net/core/somaxconn å’Œä½¿ç”¨listenå‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°ï¼ŒäºŒè€…å–æœ€å°å€¼ã€‚é»˜è®¤ä¸º128ã€‚å¦‚æœaccpet queueé˜Ÿåˆ—æ»¡äº†ï¼Œserverä¼šæ‹’ç»è¿æ¥å¹¶å°†å‘é€ä¸€ä¸ªECONNREFUSEDé”™è¯¯ä¿¡æ¯Connection refusedåˆ°clientã€‚ åœ¨nettyä¸­somaxconnæ˜¯æ ¹æ®æ“ä½œç³»ç»Ÿçš„é…ç½®æ¥è¿›è¡Œè®¾ç½®çš„ é»˜è®¤æƒ…å†µä¸‹ï¼ŒBACK_LOGä¸SOMAXCONNç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨nettyä¸­è¿›è¡Œé…ç½®æ¥æ”¹å°accepté˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦æ”¹å¤§accepté˜Ÿåˆ—çš„é•¿åº¦ï¼Œåˆ™éœ€è¦æŠŠ/proc/sys/net/core/somaxconnä¸­çš„å‚æ•°ä¹Ÿæ”¹å¤§ï¼Œå› ä¸ºå‰é¢è¯´åˆ°accept queue é˜Ÿåˆ—é•¿åº¦ç”± /proc/sys/net/core/somaxconn å’Œä½¿ç”¨listenå‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°ï¼ŒäºŒè€…å–æœ€å°å€¼ã€‚ SO_KEEPALIVEè¯¥å‚æ•°ç”¨äºè®¾ç½®TCPè¿æ¥ï¼Œå¯ä»¥è®¾ç½®ä¸ºtrueæˆ–falseï¼Œå½“è®¾ç½®è¯¥é€‰é¡¹ä»¥åï¼Œè¿æ¥ä¼šæµ‹è¯•é“¾æ¥çš„çŠ¶æ€ï¼Œè¿™ä¸ªé€‰é¡¹ç”¨äºå¯èƒ½é•¿æ—¶é—´æ²¡æœ‰æ•°æ®äº¤æµçš„è¿æ¥ã€‚å½“è®¾ç½®è¯¥é€‰é¡¹ä»¥åï¼Œå¦‚æœåœ¨ä¸¤å°æ—¶å†…æ²¡æœ‰æ•°æ®çš„é€šä¿¡æ—¶ï¼ŒTCPä¼šè‡ªåŠ¨å‘é€ä¸€ä¸ªæ´»åŠ¨æ¢æµ‹æ•°æ®æŠ¥æ–‡ã€‚ æˆ‘ä»¬çŸ¥é“æ­£å¸¸æƒ…å†µtcpè¿æ¥å…³é—­çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å®¢æˆ·ç«¯å‘èµ·å…³é—­è¿˜æ˜¯æœåŠ¡å‘èµ·å…³é—­éƒ½ä¼šæ­£å¸¸å…³é—­è¿æ¥ï¼ŒåŒæ–¹éƒ½ä¼šé‡Šæ”¾è¯¥è¿æ¥å ç”¨çš„èµ„æºï¼šåº”ç”¨é‡Šæ”¾èµ„æºï¼Œtcpå±‚ä¹Ÿä¼šé‡Šæ”¾èµ„æºï¼ˆä¸»è¦æ˜¯å†…å­˜èµ„æºï¼‰ã€‚ä½†æ˜¯æœ‰äº›æƒ…å†µï¼Œè¯¥ä¸è¯¥é‡Šæ”¾èµ„æºï¼Œå°±ä¸çŸ¥é“äº†ï¼Œå¦‚æœæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä»¥é•¿è¿æ¥çš„æ–¹å¼ä¿æŒè¿æ¥ï¼Œä½†æ˜¯æœåŠ¡ç«¯å·²ç»é•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œé€ æˆè¿™ç§åŸå› åŒ…æ‹¬ä»¥ä¸‹å‡ æ–¹é¢ï¼š å®¢æˆ·ç«¯ç¡®å®æ²¡æœ‰éœ€è¦å‘é€çš„æ•°æ® å®¢æˆ·ç«¯è¿›ç¨‹æ„å¤–ç»ˆæ­¢è¿è¡Œ å®¢æˆ·ç«¯æ‰€åœ¨çš„æœåŠ¡å™¨å®•æœºï¼Œæˆ–åœç”µ ç½‘ç»œä¸­é—´è®¾å¤‡ææ–­è¿æ¥ï¼Œå¦‚é˜²ç«å¢™å¯¹é•¿æ—¶é—´ä¸æ´»åŠ¨çš„è¿æ¥ï¼Œè¿›è¡Œå¼ºåˆ¶å…³é—­ é’ˆå¯¹ä»¥ä¸Š4ç§æƒ…å†µï¼Œåªæœ‰1æ˜¯æ­£å¸¸æƒ…å†µï¼Œä¸åº”è¯¥å…³é—­åŒæ–¹çš„è¿æ¥ï¼Œå…¶å®ƒéƒ½æ˜¯å¼‚å¸¸æƒ…å†µï¼ŒæœåŠ¡ç«¯å°±åº”è¯¥å…³é—­å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œé‡Šæ”¾æœåŠ¡ç«¯çš„èµ„æºã€‚å¦‚æœä¸é‡Šæ”¾ï¼Œå°±ä¼šå­˜åœ¨å¾ˆå¤šåŠè¿æ¥çŠ¶æ€çš„è¿æ¥ï¼Œå ç”¨æœåŠ¡ç«¯å¤§é‡èµ„æºã€‚ç”±äºå­˜åœ¨1è¿™ç§æ­£å¸¸çš„æƒ…å†µï¼ŒæœåŠ¡ç«¯å°±ä¸æ–­éšæ„å…³é—­è¿æ¥ï¼Œéœ€è¦ä¸€ç§æ‰‹æ®µæ¥è§£å†³è¿æ¥è¯¥ä¸è¯¥å…³é—­çš„é—®é¢˜ã€‚TCP/IPåè®®å®ç°ä¸­å°±åŒ…å«äº†å¿ƒè·³æœºåˆ¶ï¼Œåœ¨æœåŠ¡ç«¯ç¨‹åºç¨‹åºä¸­æˆ‘ä»¬åªéœ€è¦è®¾ç½®SO_KEEPALIVEå‚æ•°ï¼Œé‚£ä¹ˆå¦‚è¿æ¥è¶…è¿‡æŒ‡å®šçš„æ—¶é—´ï¼ˆè§ç¬¬3èŠ‚å¿ƒè·³ç›¸å…³çš„å‚æ•°ï¼‰æ²¡æœ‰æ”¶åˆ°æ•°æ®ï¼Œå°±ä¼šè§¦å‘TCPå±‚å‘èµ·å¿ƒè°ƒæ£€æµ‹ï¼Œä»è¿™é‡Œçœ‹å¯ä»¥çœ‹å‡ºTCPåè®®è‡ªèº«å¿ƒè·³çš„ç›®çš„æ˜¯æ£€æµ‹å¼‚å¸¸é“¾æ¥ï¼Œå…³é—­é“¾æ¥ï¼ŒåŠé‡Šæ”¾èµ„æºã€‚ å¦å¤–ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥è‡ªå·±å®ç°å¿ƒè·³æ£€æµ‹æ¥å®ç°å…³é—­å¼‚å¸¸è¿æ¥ã€‚ æš‚æ—¶ä½¿ç”¨è¿‡è¿™å‡ ä¸ªå‚æ•°ï¼Œåç»­è¦åˆ°äº†å†åŠ ","link":"/2020/05/27/netty-zhong-de-channeloption-pei-zhi/"},{"title":"Redisé›†ç¾¤åŸç†","text":"å½“éœ€æ•°æ®é‡å·¨å¤§æ—¶ï¼Œå¹¶å‘é‡é«˜æ—¶ï¼Œå•ä¸ªæ•°æ®åº“çš„å‹åŠ›å·¨å¤§ï¼Œé€šå¸¸é‡‡ç”¨æ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ–¹å¼ï¼ŒåŒæ ·redisæä¾›äº†é›†ç¾¤åŠŸèƒ½æ¥å®ç°æ•°æ®åˆ†åº“å­˜å‚¨ï¼Œé‡‡ç”¨å¤šå°æœåŠ¡å™¨æ¥åˆ†æ‹…å‹åŠ›ï¼Œé¿å…å•æœºå‹åŠ›è¿‡å¤§é€ æˆå®•æœºç­‰æ•…éšœã€‚ 1 Hashç®—æ³•hashç®—æ³•æ˜¯åˆ©ç”¨æ“ä½œkeyçš„hashå€¼æ¥è®¡ç®—è¯¥keyä½äºå“ªä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œä¾‹å¦‚ç°åœ¨æœ‰Nä¸ªredisé›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¬å¼è®¡ç®—å‡ºè¯¥keyä½äºçš„èŠ‚ç‚¹ä¸ºï¼š node=hash(key)%N è¿™ç§ç®—æ³•è¾ƒä¸ºç®€å•ï¼Œé€šå¸¸å¦‚æœæ¯æ¬¡éƒ½æ˜¯ä¸¤å€æ‰©å®¹çš„è¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…¨éƒ¨æ•°æ®è¿›è¡Œè¿ç§»ï¼Œåªéœ€è¦è¿ç§»50%å·¦å³çš„æ•°æ®ã€‚ä½†æ˜¯è¯¥æ–¹å¼éš¾ä»¥è‡ªç”±æ‰©å®¹ï¼Œå°¤å…¶æ˜¯é‡åˆ°åœ¨æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œéƒ½ä¼šé€ æˆæ•°æ®ç´¢å¼•å…¨è¢«æ‰“ä¹±ï¼Œéœ€è¦è¿›è¡Œå¤§é‡åœ°æ•°æ®è¿ç§»ï¼Œé‡æ–°æ˜ å°„æ•°æ®ä¸è®¡ç®—æœºèŠ‚ç‚¹çš„å…³ç³»ã€‚ 2 ä¸€è‡´æ€§Hashåˆ†åŒºä¸€è‡´æ€§Hashåˆ†åŒºç®—æ³•é‡‡ç”¨çš„æ˜¯hashç¯ï¼Œå®ƒå¯¹æœåŠ¡å™¨èŠ‚ç‚¹ä¹Ÿè¿›è¡Œäº†hashå¹¶æ˜ å°„åœ¨hashç¯ä¸Šï¼Œhashåå¯¹2^32å–æ¨¡ï¼Œè¿™æ ·å››ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¹Ÿè¢«æ˜ å°„åœ¨Hashç¯ä¸Š(åˆ†å¸ƒå°½å¯èƒ½å‡åŒ€)ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨è¿›è¡ŒæŸ¥è¯¢æˆ–è€…æ·»åŠ keyæ—¶ï¼ŒåŒæ ·å¯¹keyè¿›è¡Œhashç„¶åå¯¹2^32å–æ¨¡æ˜ å°„åˆ°Hashç¯ä¸Šï¼Œè¯¥keyå­˜å‚¨åœ¨æŒ‰é¡ºæ—¶é’ˆæ–¹å‘åˆ°è¾¾çš„Hashç¯ä¸Šç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ä¾‹å¦‚key1é€šè¿‡hashå–æ¨¡è¢«æ˜ å°„åœ¨äº†node1ä¸node2ä¹‹é—´ï¼Œé¡ºæ—¶é’ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnode2ï¼Œé‚£ä¹ˆkey1å°±å­˜å‚¨åœ¨node2ä¸Š åˆ é™¤èŠ‚ç‚¹ å½“èŠ‚ç‚¹node3è¢«åˆ é™¤åï¼Œè¿™æ ·key2,key3,key4,key5éƒ½å°†è¢«è¿ç§»éƒ½node4å»ï¼Œè¿™æ ·ä¸€æ¥ä¼šé€ æˆnode4å‹åŠ›è¿‡å¤§ã€‚ è™šæ‹ŸèŠ‚ç‚¹ ä¸Šè¿°ç¯å½¢å“ˆå¸Œçš„ç¼ºç‚¹åœ¨äºéš¾ä»¥å°†æ‰€æœ‰çš„æœåŠ¡å™¨èŠ‚ç‚¹å‡åŒ€åœ°åˆ†å¸ƒåœ¨å“ˆå¸Œç¯ä¸Šé€ æˆå•ä¸ªèŠ‚ç‚¹å‹åŠ›è¿‡å¤§ï¼Œå‡ºç°æ•°æ®å€¾æ–œç°è±¡ï¼Œå› æ­¤å°±æå‡ºäº†è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼æ¥å°½é‡å‡åŒ€åœ°åœ¨å“ˆå¸Œç¯ä¸Šåˆ†é…èŠ‚ç‚¹ï¼Œå°±æ˜¯å°†çœŸå®èŠ‚ç‚¹è®¡ç®—å¤šä¸ªå“ˆå¸Œå½¢æˆå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹å¹¶æ”¾ç½®åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå®šä½ç®—æ³•ä¸å˜ï¼Œåªæ˜¯å¤šäº†ä¸€æ­¥è™šæ‹ŸèŠ‚ç‚¹åˆ°çœŸå®èŠ‚ç‚¹æ˜ å°„çš„è¿‡ç¨‹ã€‚ ä¸‹å›¾ä¸ºæ·»åŠ è™šæ‹ŸèŠ‚ç‚¹åçš„å“ˆå¸Œç¯ï¼š å½“èŠ‚ç‚¹4æŒ‚æ‰åï¼Œkey1, key2å’Œkey3ä¼šæ‰“åˆ°èŠ‚ç‚¹2çš„è™šæ‹ŸèŠ‚ç‚¹ä¸Š(ä¹Ÿå°±æ˜¯å­˜åœ¨èŠ‚ç‚¹2æœåŠ¡å™¨ä¸Š)ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆæœåŠ¡å™¨å•ç‚¹å‹åŠ›è¿‡å¤§(æ¯å°æœåŠ¡å™¨çš„è™šæ‹ŸèŠ‚ç‚¹å¯ä»¥æ›´å¤šï¼Œè¿™æ ·èƒ½æ˜¯çš„èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒæ›´å‡åŒ€)ï¼š 3 å“ˆå¸Œæ§½å“ˆå¸Œæ§½æ˜¯redisé‡‡ç”¨çš„é›†ç¾¤æ•°æ®åˆ†å¸ƒçš„æ–¹å¼ï¼Œredisä¸­æœ‰16384ä¸ªæ§½ï¼Œä¸€ä¸ªæ§½å¯¹åº”äº†ä¸€å°éƒ¨åˆ†ç©ºé—´(å¹¶ä¸æ˜¯ä¸€ä¸ªkey)ï¼Œæ§½ç”±æ‰€æœ‰çš„redisé›†ç¾¤èŠ‚ç‚¹æ‰€åˆ†æ‹…ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªkeyæ—¶ï¼š å…ˆæ‰“åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Š(ä¸‹å›¾å‡è®¾å…ˆæ‰“åœ¨èŠ‚ç‚¹Aä¸Š) é€šè¿‡CRC16ç®—æ³•æ¥è®¡ç®—keyçš„å“ˆå¸Œå€¼ ç”¨hashå€¼å¯¹16384å–ä½™æ¥æ±‚å–è¯¥keyå­˜å‚¨åœ¨å“ªä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œç”±äºæ¯ä¸ªèetched a connection so lets call close() throw ExceptionFactory.wrapException(&quot;Error opening session. Cause: &quot; + e, e); } finally { ErrorContext.instance().reset(); }} è¯¥éƒ¨åˆ†ä»£ç ç”¨äºåˆ›å»ºSqlSessionæ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š è·å–åˆ° TransactionFactory äº‹åŠ¡å·¥å‚å¯¹è±¡ é€šè¿‡ TransactionFactory è·å–äº†ä¸€ä¸ª äº‹åŠ¡ Transaction æ ¹æ® execTypeï¼ˆé»˜è®¤æ˜¯ SIMPLE ï¼‰ è·å–äº†ä¸€ä¸ªExecutor ï¼ˆçœŸæ­£æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„å¯¹è±¡ï¼‰ åˆ›å»ºå¹¶è¿”å› DefaultSqlSession å¯¹è±¡ ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªSqlSessionå¯¹åº”ä¸€ä¸ªäº‹åŠ¡(ä¸€ä¸€å¯¹åº”)ï¼Œå¹¶ä¸”æŠŠæ•°æ®åº“çš„æ‰§è¡Œç±»å¯¹è±¡ä¹Ÿä¼ å…¥äº†SqlSessionä¸­ï¼Œåœ¨è¿™é‡Œå¹¶æ²¡æœ‰åˆ›å»ºè¿æ¥ã€‚ Mapperå¯¹è±¡æˆ‘ä»¬åœ¨ä½¿ç”¨mybatisæ—¶ä»…ä»…éœ€è¦åˆ›å»ºMapperçš„æ¥å£å³å¯ï¼Œè€Œä¸éœ€è¦åˆ›å»ºMapperå¯¹åº”çš„å®ç°ç±»ï¼ŒMybatisåœ¨è·å–åˆ°Mapperæ¥å£æ–‡ä»¶æ—¶ï¼Œå°±èƒ½å¸®æˆ‘ä»¬åˆ›å»ºå‡ºä»£ç†å¯¹è±¡ï¼Œå› æ­¤é€šè¿‡getMapperè·å–åˆ°çš„æ˜¯Mapperæ¥å£çš„ä»£ç†ç±»å¯¹è±¡ã€‚ ä»SqlSessionä¸­è·å–Mapperå¯¹è±¡å¹¶ä¸æ„å‘³ç€Mapperå¯¹è±¡å±äºSqlSessionï¼ŒMapperå¯¹è±¡æ˜¯é€šè¿‡SqlSessionä¸­çš„configurationå¯¹è±¡æ‰€åˆ›å»ºçš„(ä¸Šé¢åœ¨åˆ›å»ºSqlSessionå¯¹è±¡æ—¶ä¼ å…¥çš„)ï¼Œè€Œconfigurationåœ¨åˆ›å»ºæ—¶è°ƒç”¨äº†MapperRegistryä¸‹çš„getMapperæ–¹æ³• 1234567891011121314// class MapperRegistrypublic &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) { // æ ¹æ®å¯¹åº”ä¼ å…¥Mapperç±»å‹è·å–Mapperçš„ä»£ç†å·¥å‚ final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type); if (mapperProxyFactory == null) { throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;); } try { // ä»ä»£ç†å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªMapperçš„ä»£ç†å¯¹è±¡ return mapperProxyFactory.newInstance(sqlSession); } catch (Exception e) { throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e); }} é¦–å…ˆä»å·²ç»æ‰«æçš„mapperæ–‡ä»¶åç”Ÿæˆçš„knownMapperså¯¹è±¡ä¸­è·å–åˆ°Mapperçš„ä»£ç†å·¥å‚ ä»ä»£ç†å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªMapperçš„ä»£ç†å¯¹è±¡ ä»£ç†å¯¹è±¡çš„åˆ›å»ºå¦‚ä¸‹ï¼š 123456789// class MapperProxyFactoryprotected T newInstance(MapperProxy&lt;T&gt; mapperProxy) { return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);}public T newInstance(SqlSession sqlSession) { final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache); return newInstance(mapperProxy);} ä½¿ç”¨Jdkçš„åŠ¨æ€ä»£ç†ï¼Œä¼ å…¥å®ç°äº†InvocationHandleæ¥å£çš„MapperProxyç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªä»£ç†ç±»æ˜¯å¦‚ä½•æ‰§è¡Œæ¥å£çš„æ–¹æ³•ã€‚ Mapperä»£ç†å¯¹è±¡æ–¹æ³•çš„æ‰§è¡ŒMapperProxyç±»ä¸­çš„invokeæ–¹æ³•åŠä¸ºä»£ç†å¯¹è±¡æ‰§è¡Œçš„æ–¹æ³•ï¼š 123456789101112131415// MapperProxy@Overridepublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable { try { if (Object.class.equals(method.getDeclaringClass())) { // å½“æ–¹æ³•å±äºObjectçš„æ–¹æ³•ï¼Œå°±ç›´æ¥æŠŠthis(MapperProxy)ä¼ å…¥æ‰§è¡Œï¼Œéƒ½æ˜¯Objectçš„å­ç±» return method.invoke(this, args); } else { // è¿”å›ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå™¨æ¥æ‰§è¡Œæ–¹æ³• return cachedInvoker(method).invoke(proxy, method, args, sqlSession); } } catch (Throwable t) { throw ExceptionUtil.unwrapThrowable(t); }} åœ¨è¿™é‡Œï¼Œå¦‚æœè°ƒç”¨çš„æ–¹æ³•å±äºObjectç±»ï¼Œé‚£ä¹ˆå°±ç”¨thisç›´æ¥è°ƒç”¨è‡ªå·±æ–¹æ³•(é»˜è®¤çš„Objectç±»æ–¹æ³•)ã€‚ å¦‚æœä¸æ˜¯Objectç±»ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ˜¯Mapperæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°†ä¼šåˆ›å»ºä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå™¨æ¥æ‰§è¡Œ(è¯¥æ–¹æ³•åˆ›å»ºåä¼šè¢«ç¼“å­˜èµ·æ¥) 123456789101112131415161718192021222324252627// MapperProxyprivate MapperMethodInvoker cachedInvoker(Method method) throws Throwable { try { // å¦‚æœåˆ›å»ºè¿‡è¯¥æ–¹æ³•çš„æ‰§è¡Œå™¨å¯ä»¥ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰åˆ›å»ºè¿‡åˆ™åˆ©ç”¨ä¸‹é¢ä»£ç å—çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–¹æ³•ç¼“å­˜èµ·æ¥ç„¶åè¿”å›ã€‚ return methodCache.computeIfAbsent(method, m -&gt; { if (m.isDefault()) { // &lt;1&gt;æ˜¯é»˜è®¤æ–¹æ³•defaultå£°æ˜ï¼Œåˆ™æ˜¯ç”¨æˆ·åœ¨æ¥å£ä¸­è‡ªå®šä¹‰äº†è¯¥æ–¹æ³•ï¼Œä¸è¿›è¡Œä»£ç† try { if (privateLookupInMethod == null) { return new DefaultMethodInvoker(getMethodHandleJava8(method)); } else { return new DefaultMethodInvoker(getMethodHandleJava9(method)); } } catch (IllegalAccessException | InstantiationException | InvocationTargetException | NoSuchMethodException e) { throw new RuntimeException(e); } } else { // &lt;2&gt;ä¸æ˜¯defaultæ–¹æ³•ï¼Œä¸€èˆ¬éƒ½èµ°è¿™é‡Œ return new PlainMethodInvoker(new MapperMethod(mapperInterface, method, sqlSession.getConfiguration())); } }); } catch (RuntimeException re) { Throwable cause = re.getCause(); throw cause == null ? re : cause; }} methodCache.computeIfAbsentçš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°å‹å‡½æ•°æ¥å£ï¼Œé¦–å…ˆçœ‹çœ‹computeIfAbsenté‡Œçš„ä»£ç ï¼š 123456789101112131415default V computeIfAbsent(K key, Function&lt;? super K, ? extends V&gt; mappingFunction) { Objects.requireNonNull(mappingFunction); V v; if ((v = get(key)) == null) { // ä»ç¼“å­˜ä¸­è·å–è¯¥æ–¹æ³•çš„æ‰§è¡Œå™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åˆ©ç”¨Functionå‡½æ•°æ¥å£åˆ›å»ºä¸€ä¸ªï¼Œè¿™ä¸ªæ¥å£çš„applyæ–¹æ³•åœ¨ä¸Šé¢å®šä¹‰ V newValue; if ((newValue = mappingFunction.apply(key)) != null) { put(key, newValue); return newValue; } } return v;} æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå™¨ï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡è¯¥æ–¹æ³•çš„æ‰§è¡Œå™¨ï¼Œå°±åˆ©ç”¨applyæ–¹æ³•åˆ›å»ºä¸€ä¸ªç„¶åç¼“å­˜èµ·æ¥ï¼Œå› æ­¤æˆ‘ä»¬è¿˜æ˜¯å›åˆ°lambdaè¡¨è¾¾å¼ä¸­çš„ä»£ç å—ã€‚ Mapperæ¥å£ä¸­çš„defaultæ–¹æ³•ç”±ç”¨æˆ·è‡ªå·±å®ç°ï¼Œä¸è¿›è¡Œä»£ç†ï¼Œè€Œæ“ä½œæ•°æ®åº“çš„å¾€å¾€éƒ½æ˜¯æ²¡æœ‰å®ç°çš„ï¼Œä¸€èˆ¬èµ°&lt;2&gt;ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æ–°åˆ›å»ºçš„è¿™ä¸ªç±»PlainMethodInvokerå¯¹è±¡çš„å®šä¹‰ã€‚ 12345678910111213private static class PlainMethodInvoker implements MapperMethodInvoker { private final MapperMethod mapperMethod; public PlainMethodInvoker(MapperMethod mapperMethod) { super(); this.mapperMethod = mapperMethod; } @Override public Object invoke(Object proxy, Method method, Object[] args, SqlSession sqlSession) throws Throwable { return mapperMethod.execute(sqlSession, args); }} ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªinvokeæ–¹æ³•å°±æ˜¯Mapperä»£ç†å¯¹è±¡æ‰§è¡Œçš„æ–¹æ³•ï¼ŒMapperMethodæ˜¯åœ¨åˆ›å»ºPlainMethodInvokeræ—¶newå‡ºæ¥çš„ï¼Œexcuteæ–¹æ³•å‡ ä¹å°±æ˜¯æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„å…¥å£ï¼Œæˆ‘ä»¬æ¥ç€çœ‹è¿™ä¸ªæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public Object execute(SqlSession sqlSession, Object[] args) { Object result; switch (command.getType()) { case INSERT: { Object param = method.convertArgsToSqlCommandParam(args); // åˆ©ç”¨sqlSessionè¿›è¡Œæ•°æ®åº“insertæ“ä½œ result = rowCountResult(sqlSession.insert(command.getName(), param)); break; } case UPDATE: { Object param = method.convertArgsToSqlCommandParam(args); // åˆ©ç”¨sqlSessionè¿›è¡Œæ•°æ®åº“updateæ“ä½œ result = rowCountResult(sqlSession.update(command.getName(), param)); break; } case DELETE: { Object param = method.convertArgsToSqlCommandParam(args); // åˆ©ç”¨sqlSessionè¿›è¡Œæ•°æ®åº“deleteæ“ä½œ result = rowCountResult(sqlSession.delete(command.getName(), param)); break; } case SELECT: // åˆ©ç”¨sqlSessionè¿›è¡Œæ•°æ®åº“selectæ“ä½œ if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) { executeWithResultHandler(sqlSession, args); result = null; } else if (method.returnsMany()) { result = executeForMany(sqlSession, args); } else if (method.returnsMap()) { result = executeForMap(sqlSession, args); } else if (method.returnsCursor()) { result = executeForCursor(sqlSession, args); } else { Object param = method.convertArgsToSqlCommandParam(args); result = sqlSession.selectOne(command.getName(), param); if (method.returnsOptional() &amp;&amp; (result == null || !method.getReturnType().equals(result.getClass()))) { result = Optional.ofNullable(result); } } break; case FLUSH: // åˆ©ç”¨sqlSessionè¿›è¡Œæ•°æ®åº“flushæ“ä½œ(ä»€ä¹ˆæ“ä½œæš‚æ—¶ä¸æ¸…æ¥š) result = sqlSession.flushStatements(); break; default: throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName()); } if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) { throw new BindingException(&quot;Mapper method '&quot; + command.getName() + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;); } return result;} åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯æ˜è°ƒç”¨Mapperæ¥å£çš„æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨è°ƒç”¨SqlSessionçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ï¼Œè€ŒSqlSessionçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨è°ƒç”¨Excutorçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•(å‰é¢åœ¨åˆ›å»ºSqlSessionå¯¹è±¡ä¸­å·²ç»è¯´äº†ï¼ŒSqlSessionå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªExcutorå¯¹è±¡)è¿™ä¸ªæˆ‘ä»¬åç»­ã€‚ æ€»ç»“ï¼š SqlSessionä½¿ç”¨getMapperæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªMapperæ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”æŠŠè‡ªèº«ä¼ é€’äº†è¿›å» è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†SqlSessionçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ã€‚","link":"/2020/05/29/spring-yu-mybatis-zheng-he-de-yuan-li/"},{"title":"Redisé›†ç¾¤åŸç†","text":"å½“éœ€æ•°æ®é‡å·¨å¤§æ—¶ï¼Œå¹¶å‘é‡é«˜æ—¶ï¼Œå•ä¸ªæ•°æ®åº“çš„å‹åŠ›å·¨å¤§ï¼Œé€šå¸¸é‡‡ç”¨æ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ–¹å¼ï¼ŒåŒæ ·redisæä¾›äº†é›†ç¾¤åŠŸèƒ½æ¥å®ç°æ•°æ®åˆ†åº“å­˜å‚¨ï¼Œé‡‡ç”¨å¤šå°æœåŠ¡å™¨æ¥åˆ†æ‹…å‹åŠ›ï¼Œé¿å…å•æœºå‹åŠ›è¿‡å¤§é€ æˆå®•æœºç­‰æ•…éšœã€‚ 1 Hashç®—æ³•hashç®—æ³•æ˜¯åˆ©ç”¨æ“ä½œkeyçš„hashå€¼æ¥è®¡ç®—è¯¥keyä½äºå“ªä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œä¾‹å¦‚ç°åœ¨æœ‰Nä¸ªredisé›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¬å¼è®¡ç®—å‡ºè¯¥keyä½äºçš„èŠ‚ç‚¹ä¸ºï¼š node=hash(key)%N è¿™ç§ç®—æ³•è¾ƒä¸ºç®€å•ï¼Œé€šå¸¸å¦‚æœæ¯æ¬¡éƒ½æ˜¯ä¸¤å€æ‰©å®¹çš„è¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…¨éƒ¨æ•°æ®è¿›è¡Œè¿ç§»ï¼Œåªéœ€è¦è¿ç§»50%å·¦å³çš„æ•°æ®ã€‚ä½†æ˜¯è¯¥æ–¹å¼éš¾ä»¥è‡ªç”±æ‰©å®¹ï¼Œå°¤å…¶æ˜¯é‡åˆ°åœ¨æŸä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œéƒ½ä¼šé€ æˆæ•°æ®ç´¢å¼•å…¨è¢«æ‰“ä¹±ï¼Œéœ€è¦è¿›è¡Œå¤§é‡åœ°æ•°æ®è¿ç§»ï¼Œé‡æ–°æ˜ å°„æ•°æ®ä¸è®¡ç®—æœºèŠ‚ç‚¹çš„å…³ç³»ã€‚ 2 ä¸€è‡´æ€§Hashåˆ†åŒºä¸€è‡´æ€§Hashåˆ†åŒºç®—æ³•é‡‡ç”¨çš„æ˜¯hashç¯ï¼Œå®ƒå¯¹æœåŠ¡å™¨èŠ‚ç‚¹ä¹Ÿè¿›è¡Œäº†hashå¹¶æ˜ å°„åœ¨hashç¯ä¸Šï¼Œhashåå¯¹2^32å–æ¨¡ï¼Œè¿™æ ·å››ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¹Ÿè¢«æ˜ å°„åœ¨Hashç¯ä¸Š(åˆ†å¸ƒå°½å¯èƒ½å‡åŒ€)ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨è¿›è¡ŒæŸ¥è¯¢æˆ–è€…æ·»åŠ keyæ—¶ï¼ŒåŒæ ·å¯¹keyè¿›è¡Œhashç„¶åå¯¹2^32å–æ¨¡æ˜ å°„åˆ°Hashç¯ä¸Šï¼Œè¯¥keyå­˜å‚¨åœ¨æŒ‰é¡ºæ—¶é’ˆæ–¹å‘åˆ°è¾¾çš„Hashç¯ä¸Šç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ä¾‹å¦‚key1é€šè¿‡hashå–æ¨¡è¢«æ˜ å°„åœ¨äº†node1ä¸node2ä¹‹é—´ï¼Œé¡ºæ—¶é’ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnode2ï¼Œé‚£ä¹ˆkey1å°±å­˜å‚¨åœ¨node2ä¸Š åˆ é™¤èŠ‚ç‚¹ å½“èŠ‚ç‚¹node3è¢«åˆ é™¤åï¼Œè¿™æ ·key2,key3,key4,key5éƒ½å°†è¢«è¿ç§»éƒ½node4å»ï¼Œè¿™æ ·ä¸€æ¥ä¼šé€ æˆnode4å‹åŠ›è¿‡å¤§ã€‚ è™šæ‹ŸèŠ‚ç‚¹ ä¸Šè¿°ç¯å½¢å“ˆå¸Œçš„ç¼ºç‚¹åœ¨äºéš¾ä»¥å°†æ‰€æœ‰çš„æœåŠ¡å™¨èŠ‚ç‚¹å‡åŒ€åœ°åˆ†å¸ƒåœ¨å“ˆå¸Œç¯ä¸Šé€ æˆå•ä¸ªèŠ‚ç‚¹å‹åŠ›è¿‡å¤§ï¼Œå‡ºç°æ•°æ®å€¾æ–œç°è±¡ï¼Œå› æ­¤å°±æå‡ºäº†è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼æ¥å°½é‡å‡åŒ€åœ°åœ¨å“ˆå¸Œç¯ä¸Šåˆ†é…èŠ‚ç‚¹ï¼Œå°±æ˜¯å°†çœŸå®èŠ‚ç‚¹è®¡ç®—å¤šä¸ªå“ˆå¸Œå½¢æˆå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹å¹¶æ”¾ç½®åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå®šä½ç®—æ³•ä¸å˜ï¼Œåªæ˜¯å¤šäº†ä¸€æ­¥è™šæ‹ŸèŠ‚ç‚¹åˆ°çœŸå®èŠ‚ç‚¹æ˜ å°„çš„è¿‡ç¨‹ã€‚ ä¸‹å›¾ä¸ºæ·»åŠ è™šæ‹ŸèŠ‚ç‚¹åçš„å“ˆå¸Œç¯ï¼š å½“èŠ‚ç‚¹4æŒ‚æ‰åï¼Œkey1, key2å’Œkey3ä¼šæ‰“åˆ°èŠ‚ç‚¹2çš„è™šæ‹ŸèŠ‚ç‚¹ä¸Š(ä¹Ÿå°±æ˜¯å­˜åœ¨èŠ‚ç‚¹2æœåŠ¡å™¨ä¸Š)ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆæœåŠ¡å™¨å•ç‚¹å‹åŠ›è¿‡å¤§(æ¯å°æœåŠ¡å™¨çš„è™šæ‹ŸèŠ‚ç‚¹å¯ä»¥æ›´å¤šï¼Œè¿™æ ·èƒ½æ˜¯çš„èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒæ›´å‡åŒ€)ï¼š 3 å“ˆå¸Œæ§½å“ˆå¸Œæ§½æ˜¯redisé‡‡ç”¨çš„é›†ç¾¤æ•°æ®åˆ†å¸ƒçš„æ–¹å¼ï¼Œredisä¸­æœ‰16384ä¸ªæ§½ï¼Œä¸€ä¸ªæ§½å¯¹åº”äº†ä¸€å°éƒ¨åˆ†ç©ºé—´(å¹¶ä¸æ˜¯ä¸€ä¸ªkey)ï¼Œæ§½ç”±æ‰€æœ‰çš„redisé›†ç¾¤èŠ‚ç‚¹æ‰€åˆ†æ‹…ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªkeyæ—¶ï¼š å…ˆæ‰“åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Š(ä¸‹å›¾å‡è®¾å…ˆæ‰“åœ¨èŠ‚ç‚¹Aä¸Š) é€šè¿‡CRC16ç®—æ³•æ¥è®¡ç®—keyçš„å“ˆå¸Œå€¼ ç”¨hashå€¼å¯¹16384å–ä½™æ¥æ±‚å–è¯¥keyå­˜å‚¨åœ¨å“ªä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œç”±äºæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜äº†æ‰€æœ‰çš„å“ˆå¸Œæ§½éƒ½è¢«åˆ†é…åˆ°äº†å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ç›´æ¥å»è®¿é—®è®¡ç®—å‡ºæ¥çš„èŠ‚ç‚¹å³å¯ã€‚ä¾‹å¦‚ä¸‹å›¾ï¼Œè¯·æ±‚é¦–å…ˆæ‰“åœ¨AèŠ‚ç‚¹ä¸Šï¼Œè®¡ç®—å‡ºkeyæ‰€å¤„çš„èŠ‚ç‚¹åº”è¯¥ä¸ºDèŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥å°†è¯·æ±‚è½¬å‘åˆ°èŠ‚ç‚¹Dä¸Šï¼Œä¿è¯æœ€å¤šä¸¤æ¬¡å‘½ä¸­ã€‚ å¢åŠ èŠ‚ç‚¹ä¸åˆ é™¤èŠ‚ç‚¹ å½“redisé›†ç¾¤éœ€è¦æ·»åŠ èŠ‚ç‚¹æ—¶ï¼Œå°±ä¼šä»ç°æœ‰çš„æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹ä¸­å„å–ä¸€éƒ¨åˆ†æ”¾å…¥æ§½æ”¾å…¥æ–°çš„èŠ‚ç‚¹ä¸­(æ•°æ®è¿ç§»+æ§½åˆ†é…è¡¨æ›´æ–°)ã€‚","link":"/2020/05/24/redis-ji-qun/"},{"title":"Springä¸Mybatisæ•´åˆçš„åŸç†(äºŒ)","text":"ä¸Šä¸€ç¯‡æˆ‘ä»¬è®¨è®ºåˆ°åœ¨å•çº¯ä½¿ç”¨Mybatisçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡SqlSessionçš„getMapperæ–¹æ³•æ¥è·å–Mapperæ¥å£çš„ä»£ç†å¯¹è±¡(æ¯æ¬¡è°ƒç”¨getMapperå°±ä¼šæ–°åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡å‡ºæ¥)ï¼ŒåŒæ—¶å°†SqlSessionå¯¹è±¡ä¼ å…¥åˆ°Mapperä»£ç†å¯¹è±¡ä¸­ï¼Œè°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•æœ¬è´¨å°±æ˜¯åœ¨è°ƒç”¨SqlSessionçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ã€‚å¹¶ä¸”ï¼Œæ¯ä¸ªDefaultSqlSessionå¯¹è±¡éƒ½å¯¹åº”äºä¸€ä¸ªæ•°æ®åº“è¿æ¥(ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡)ï¼Œè¿™æ ·æˆ‘ä»¬ä¸ç¦æƒ³åˆ°ï¼Œåœ¨Springæ•´åˆMybatisæ—¶ï¼Œæˆ‘ä»¬å‘Springå®¹å™¨ä¸­æ³¨å…¥çš„æ˜¯Mapperæ¥å£çš„å•ä¾‹ä»£ç†å¯¹è±¡ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼ŒMapperå¯¹è±¡è¢«åŒæ—¶è°ƒç”¨ï¼Œé‚£ä¹ˆSqlSessionæ˜¯å¦æ˜¯å•ä¾‹çš„å‘¢(æ˜¾ç„¶ä¸æ˜¯)ï¼Ÿæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹Springä¸Mybatisæ˜¯å¦‚ä½•æ•´åˆçš„ã€‚ å¦‚ä½•è·å¾—Mapperä»£ç†å¯¹è±¡1. æ³¨å†ŒMapperæ‰«æçš„ç»„ä»¶åœ¨å•çº¯ä½¿ç”¨Mybatisæ—¶è·å–ä»£ç†å¯¹è±¡éå¸¸ç®€å•ï¼Œç›´æ¥è°ƒç”¨SqlSessionçš„getMapperå³å¯ï¼Œå¯¹äºSpring-Mybatisè€Œè¨€ï¼Œä½¿ç”¨è€…æ— éœ€è·å–SqlSessionå¯¹è±¡ï¼Œæ›´ä¸éœ€è¦è°ƒç”¨getMapperæ–¹æ³•æ¥è·å–Mapperä»£ç†å¯¹è±¡ï¼Œåªéœ€è¦æ·»åŠ @Mapperæˆ–è€…@MapperScanæ³¨è§£å³å¯åœ¨Springå®¹å™¨å¯åŠ¨æ—¶ç›´æ¥å‘å®¹å™¨ä¸­æ³¨å…¥Mapperæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹@MapperScanæ³¨è§£ï¼š 123456@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.TYPE)@Documented@Import(MapperScannerRegistrar.class)@Repeatable(MapperScans.class)public @interface MapperScan { ç†Ÿæ‚‰Springçš„åŒå­¦å°±ä¼šçŸ¥é“ï¼ŒMapperScanæ³¨è§£çš„å¼•å…¥ä¼šä½¿ç”¨@Importæ¥å‘å®¹å™¨ä¸­æ³¨å†ŒMapperScannerRegistrarç»„ä»¶ 1public class MapperScannerRegistrar implements ImportBeanDefinitionRegistrar, ResourceLoaderAware MapperScannerRegistrarå®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ç±»å¯ä»¥åœ¨Springå¯åŠ¨æ—¶è°ƒç”¨registerBeanDefinitionsæ–¹æ³•å‘å®¹å™¨ä¸­ä¿®æ”¹æˆ–æ·»åŠ BeanDefinitionï¼ŒSpringåœ¨åˆ›å»ºBeanå¯¹è±¡æ—¶å°±ä¼šæ ¹æ®æ‰€æœ‰çš„BeanDefinitionæ¥åˆ›å»ºBeanã€‚ åœ¨è¿™ä¸ªç±»ä¸­å‘å®¹å™¨ä¸­æ³¨å†ŒBedefinitionçš„å…³é”®è¯­å¥å¦‚ä¸‹ï¼š 12345// åˆ›å»ºä¸€ä¸ªBeanDefinitionçš„BuilderBeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);// çœç•¥(å‘Builderä¸­æ·»åŠ ä¸€äº›å±æ€§)...// é€šè¿‡Builderè·å–BeanDefinitionï¼Œå¹¶å°†registry.registerBeanDefinition(beanName, builder.getBeanDefinition()); ç”±äºä»£ç æ¯”è¾ƒé•¿ï¼Œéƒ½æ˜¯å‘BeanDefinitionä¸­æ·»åŠ ä¸€äº›å±æ€§å› æ­¤çœç•¥æ‰äº†ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„ä¸¤è¡Œä»£ç å°±å¯ä»¥çœ‹åˆ°å‘å®¹å™¨ä¸­æ³¨å…¥MapperScannerConfigurerç±»çš„BeanDefinitionã€‚ MapperScannerConfigureræ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œç”¨äºé…ç½®Mapperæ¥å£æ‰«æï¼Œå¹¶ä¸”è¿›è¡ŒMapperæ¥å£æ‰«æï¼Œå…¶çš„å®šä¹‰å¦‚ä¸‹ï¼š 12public class MapperScannerConfigurer implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware { è¿™ä¸ªç±»å®ç°äº†å¾ˆå¤šæ¥å£,æˆ‘ä»¬ä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯BeanDefinitionRegistryPostProcessorï¼Œåœ¨Springä¸­, å®ç°äº†è¯¥æ¥å£çš„ç±»ä¼šåœ¨BeanDefinitionéƒ½æ³¨å†Œå®Œæˆåè°ƒç”¨postProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œå¯ä»¥ç”¨äºä¿®æ”¹Beançš„å®šä¹‰ä¿¡æ¯ã€‚å› æ­¤æˆ‘ä»¬æ¥çœ‹çœ‹è¯¥æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829// class MapperScannerConfigurer@Overridepublic void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) { // åˆå§‹åŒ–ä¸€äº›å±æ€§ if (this.processPropertyPlaceHolders) { processPropertyPlaceHolders(); } // åŒ…æ‰«æå™¨ï¼Œmybatisç»§æ‰¿Springçš„åŒ…æ‰«æå™¨ ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry); // åˆå§‹åŒ–ä¸€äº›æˆå‘˜å˜é‡ scanner.setAddToConfig(this.addToConfig); scanner.setAnnotationClass(this.annotationClass); scanner.setMarkerInterface(this.markerInterface); scanner.setSqlSessionFactory(this.sqlSessionFactory); scanner.setSqlSessionTemplate(this.sqlSessionTemplate); scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName); scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName); scanner.setResourceLoader(this.applicationContext); scanner.setBeanNameGenerator(this.nameGenerator); scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass); if (StringUtils.hasText(lazyInitialization)) { scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization)); } scanner.registerFilters(); // æ‰§è¡Œæ‰«æ scanner.scan( StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));} Mybatisä½¿ç”¨äº†Springæä¾›çš„æ‰«æç±»ï¼ŒåŠ ä¸Šäº†è‡ªå·±éœ€è¦çš„ä¸€äº›å±æ€§æ¥å¯¹MapperScanä¸­åˆ—å‡ºçš„åŒ…è¿›è¡Œæ‰«æï¼Œåœ¨æœ€åä¸€æ­¥æ‰§è¡Œæ‰«æä¸­å®Œæˆäº†Mybatisçš„FactoryBeanæ³¨å…¥ï¼Œè¯¥FactoryBeanç”¨æ¥ç”ŸæˆMapperçš„ä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆè¦æ³¨å…¥FactoryBeanå‘¢ï¼Ÿ 2 åˆ›å»ºå¯¹åº”çš„FactoryBeané¦–å…ˆï¼Œæˆ‘ä»¬å…ˆä¸å»çœ‹Spring-Mybatisçš„æºç ï¼Œå­¦è¿‡Springçš„éƒ½çŸ¥é“Springå¯ä»¥é€šè¿‡FactoryBeançš„æ–¹å¼æ¥æ³¨å…¥ç»„ä»¶ï¼Œå½“Springå¼€å§‹åˆ›å»ºBeanå¯¹è±¡çš„æ—¶ï¼Œå¦‚æœé‡åˆ°FactoryBeanæ¥å£çš„å®ç°ç±»ï¼Œä¾¿ä¼šè°ƒç”¨FactoryBeançš„getObject()æ¥åˆ›å»ºBeanå¯¹è±¡ï¼Œå› æ­¤Springå®¹å™¨ä¸­æ³¨å…¥çš„å®é™…æ˜¯getObject()è¿”å›çš„å¯¹è±¡çš„Beanå¯¹è±¡ã€‚ æåˆ°è¿™ï¼Œæˆ‘ä»¬è‡ªç„¶è€Œç„¶å¯ä»¥æƒ³åˆ°å½“æˆ‘ä»¬æ‰«æåˆ°æ‰€æœ‰çš„Mapperæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡FactoryBeançš„æ–¹å¼æ¥å‘å®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ªMapperçš„ä»£ç†å¯¹è±¡ï¼Œç¡®å®ï¼ŒMybatisä¸Springæ•´åˆå°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹æºç æ˜¯å¦‚ä½•å®Œæˆè¿™ä¸€æ“ä½œçš„ã€‚ æˆ‘ä»¬è¿›å…¥scan()æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯æ‰§è¡Œäº†doScan()æ–¹æ³•ï¼Œå®ƒçš„ç¬¬ä¸€å…ˆç”¨Springçš„åŒ…æ‰«æåŠŸèƒ½æ‰«æçš„æ‰€æœ‰çš„Mapperæ¥å£å°è£…ä¸ºBeanDefinitionï¼Œç„¶åè¯¥æ–¹æ³•è°ƒç”¨äº†processBeanDefinitionsï¼Œå°†Mapperæ¥å£çš„BeanDefinitionå·æ¢æ¢æŸ±å˜æˆFactoryBeanï¼š 123456789101112131415161718192021222324// class ClassPathMapperScannerprivate void processBeanDefinitions(Set&lt;BeanDefinitionHolder&gt; beanDefinitions) { // ä¼ å…¥çš„beanDefinitionså°±æ˜¯æ‰€æœ‰Mapperæ¥å£çš„BeanDefinition GenericBeanDefinition definition; for (BeanDefinitionHolder holder : beanDefinitions) { definition = (GenericBeanDefinition) holder.getBeanDefinition(); // è·å–æ¯ä¸ªBeanDefinitionæ‰€å¯¹åº”çš„Mapperæ¥å£çš„æ¥å£å String beanClassName = definition.getBeanClassName(); LOGGER.debug(() -&gt; &quot;Creating MapperFactoryBean with name '&quot; + holder.getBeanName() + &quot;' and '&quot; + beanClassName + &quot;' mapperInterface&quot;); // the mapper interface is the original class of the bean // but, the actual class of the bean is MapperFactoryBean // ä»¥ä¸‹ä¸¤å¥å°±æ˜¯å°†BeanDefinitionçš„ç±»å‹ä¿®æ”¹ä¸ºMapperFactoryBeanå¹¶æŠŠæ¥å£çš„ç±»å‹ä¼ å…¥äº†MapperFactoryBeanä¸­ã€‚ // &lt;1&gt;è·å–å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¹¶æŠŠMapperæ¥å£çš„æ¥å£åä¼ å…¥(è¿™é‡Œæ˜¯ä¸éœ€è¦ç®¡Beançš„ç±»å‹å°±å¯ä»¥ç›´æ¥æŒ‡å®š) definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName); // issue #59 // &lt;2&gt;å°†è¿™ä¸ªBeanDefinitionçš„ç±»å‹ä¿®æ”¹ä¸ºMapperFactoryBeanç±»å‹(mapperFactoryBeanClass = MapperFactoryBean.class) definition.setBeanClass(this.mapperFactoryBeanClass); definition.getPropertyValues().add(&quot;addToConfig&quot;, this.addToConfig); // å°†ä»£ç†å¯¹è±¡çš„ä¸€äº›å±æ€§è®¾ç½®è¿›å»(ä¾‹å¦‚SqlSessionçš„ç±»å‹ç­‰ï¼Œçœç•¥) } ä¸Šé¢ä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯&lt;1&gt;&lt;2&gt;ä¸¤å¤„ï¼Œå°†æ‰«æçš„æ‰€æœ‰Mapperæ¥å£çš„BeanDefinitionéƒ½æ›´æ”¹ä¸ºäº†MapperFactoryBeanç±»å‹ï¼Œè¿™æ ·ï¼ŒSpringå®¹å™¨åœ¨åˆ›å»ºBeanå¯¹è±¡æ—¶å°±ä¼šè°ƒç”¨getObject()æ–¹æ³•æ¥è¿”å›æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡(å³Mapperæ¥å£çš„ä»£ç†å¯¹è±¡)ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹MapperFactoryBeançš„getObjectæ–¹æ³•ï¼š 1234@Overridepublic T getObject() throws Exception { return getSqlSession().getMapper(this.mapperInterface);} æˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç ï¼Œåˆ©ç”¨SqlSessionæ¥è·å–Mapperæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±çŸ¥é“äº†Mybatis-Springåœ¨Springå®¹å™¨åˆå§‹åŒ–æ—¶å¦‚ä½•æ³¨å…¥Mapperæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æœ‰ä¸€ä¸ªç–‘é—®ï¼šMapperä»£ç†å¯¹è±¡åœ¨Springä¸­æ˜¯å•ä¾‹çš„ï¼Œæˆ‘ä»¬çœ‹åˆ°Mapperä»£ç†å¯¹è±¡æ˜¯åœ¨Springå®¹å™¨åˆå§‹åŒ–æ—¶é€šè¿‡SqlSessionæ³¨å…¥çš„ï¼Œè”ç³»æˆ‘ä»¬å‰é¢å•çº¯ä½¿ç”¨Mybatisæ—¶ï¼Œä¸€ä¸ªSqlSessionå¯¹åº”ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆå²‚ä¸æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æˆ‘ä»¬ä¸€ç›´éƒ½æ˜¯ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè¿™æ€ä¹ˆåˆç†å‘¢ï¼Ÿå¯ä»¥è‚¯å®šçš„æ˜¯ï¼ŒMybatis-Springåœ¨å¤šçº¿ç¨‹ä¸‹å½“ç„¶ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹Mybatis-Springæ˜¯æ€ä¹ˆåšåˆ°çš„å§ã€‚ Mybatis-Springä¸­çš„SqlSessionæˆ‘ä»¬ä¸Šé¢çœ‹åˆ°äº†Mapperä»£ç†å¯¹è±¡æ˜¯é€šè¿‡getSqlSession().getMapper(this.mapperInterface)æ¥è·å–çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹getSqlSession()ï¼Œå‘ç°å…¶è¿”å›çš„æ˜¯SqlSessionTemplateç±»å‹ï¼Œè¿™å¥½åƒä¸æˆ‘ä»¬å•çº¯ä½¿ç”¨Mybatisæ—¶çš„SqlSessionç±»å‹DefaultSqlSessionä¸ä¸€æ ·ï¼ŒSqlSessionTemplateå°±æ˜¯Mybatis-Springè·å–ä¸åŒæ•°æ®åº“è¿æ¥çš„å…³é”®æ‰€åœ¨ï¼Œæˆ‘ä»¬è·Ÿè¸ªåˆ°SqlSessionTemplateçš„æ„é€ å‡½æ•°ï¼š 1234567891011121314// class SqlSessionTemplatepublic SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator) { notNull(sqlSessionFactory, &quot;Property 'sqlSessionFactory' is required&quot;); notNull(executorType, &quot;Property 'executorType' is required&quot;); this.sqlSessionFactory = sqlSessionFactory; this.executorType = executorType; this.exceptionTranslator = exceptionTranslator; // åˆ›å»ºSqlSessionçš„ä»£ç†å¯¹è±¡ this.sqlSessionProxy = (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(), new Class[] { SqlSession.class }, new SqlSessionInterceptor());} çœ‹åˆ°è¿™é‡Œï¼ŒåŸæ¥SqlSessionTemplateä¸­æœ‰ä¸€ä¸ªSqlSessionçš„ä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬æŸ¥çœ‹SqlSessionTemplateä¸­çš„selectOneç­‰æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ä¹Ÿå¯ä»¥å‘ç°å…¶å®éƒ½æ˜¯åœ¨è°ƒç”¨SqlSessionä»£ç†å¯¹è±¡çš„æ“ä½œæ•°æ®åº“æ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬åº”è¯¥ç»§ç»­è·Ÿè¸ªSqlSessionInterceptorçš„invokeæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435// class SqlSessionTemplate$SqlSessionInterceptor@Overridepublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable { // è·å–ä¸€ä¸ªæ–°çš„SqlSession SqlSession sqlSession = getSqlSession(SqlSessionTemplate.this.sqlSessionFactory, SqlSessionTemplate.this.executorType, SqlSessionTemplate.this.exceptionTranslator); try { // åˆ©ç”¨è¿™ä¸ªæ–°çš„SqlSessionæ¥æ‰§è¡Œå¯¹åº”çš„æ•°æ®åº“æ“ä½œ Object result = method.invoke(sqlSession, args); if (!isSqlSessionTransactional(sqlSession, SqlSessionTemplate.this.sqlSessionFactory)) { // force commit even on non-dirty sessions because some databases require // a commit/rollback before calling close() sqlSession.commit(true); } return result; } catch (Throwable t) { Throwable unwrapped = unwrapThrowable(t); if (SqlSessionTemplate.this.exceptionTranslator != null &amp;&amp; unwrapped instanceof PersistenceException) { // release the connection to avoid a deadlock if the translator is no loaded. See issue #22 closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory); sqlSession = null; Throwable translated = SqlSessionTemplate.this.exceptionTranslator .translateExceptionIfPossible((PersistenceException) unwrapped); if (translated != null) { unwrapped = translated; } } throw unwrapped; } finally { if (sqlSession != null) { // å…³é—­SqlSession closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory); } }} çœ‹è¿‡è¿™ä¸ªæ–¹æ³•åå°±çœŸç›¸å¤§ç™½äº†ï¼ŒåŸæ¥ï¼šSpringå®¹å™¨ä¸­çš„Mapperä»£ç†å¯¹è±¡æ˜¯é€šè¿‡SqlSessionTemplateè·å–çš„å•ä¾‹å¯¹è±¡ï¼Œè€ŒSqlSessionTemplateå†…éƒ¨ä¿å­˜äº†ä¸€ä¸ªSqlSessionçš„ä»£ç†å¯¹è±¡ï¼Œå½“Mapperå¯¹è±¡æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„æ–¹æ³•æ—¶ï¼Œè¿˜æ˜¯ä¸MybatisåŸæ¥ä¸€æ ·å»è°ƒç”¨Mapperå†…éƒ¨ä¿å­˜çš„SqlSessionå¯¹è±¡çš„å¯¹æ•°æ®åº“å¢åˆ æ”¹æŸ¥çš„æ–¹æ³•ï¼Œåªä¸è¿‡åœ¨ä¸Springæ•´åˆåï¼ŒMapperä»£ç†å¯¹è±¡ä¸­çš„SqlSessionç±»å‹ä¸ºSqlSessionTemplateã€‚æ¯æ¬¡è°ƒç”¨SqlSessionTemplateçš„æ“ä½œæ•°æ®åº“çš„æ–¹æ³•éƒ½æ˜¯è°ƒç”¨å…¶å†…éƒ¨çš„SqlSessionçš„ä»£ç†å¯¹è±¡çš„ç›¸åŒæ–¹æ³•ï¼Œè€Œè¿™ä¸ªä»£ç†å¯¹è±¡çš„æ–¹æ³•æ¯æ¬¡éƒ½ä¼šå…ˆä»é‡æ–°ç”Ÿæˆä¸€ä¸ªDefaultSqlSessionå¯¹è±¡æ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚è¿™æ ·ä¸€æ¥å°±åšåˆ°äº†SqlSessionä¸Mapperä»£ç†å¯¹è±¡çš„è§£è€¦ï¼Œæ¯æ¬¡è°ƒç”¨æ–¹æ³•éƒ½æ˜¯ä¸åŒçš„SqlSessionå¯¹è±¡ã€‚","link":"/2020/06/02/spring-yu-mybatis-zheng-he-yuan-li-er/"},{"title":"NIO","text":"NIOï¼ˆJDK1.4ï¼‰æ¨¡å‹æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡IOï¼Œä¸»è¦æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼šChannel(é€šé“)ï¼ŒBuffer(ç¼“å†²åŒº), Selectorï¼ˆå¤šè·¯å¤ç”¨å™¨ï¼‰ã€‚ 1 Buffer1.1 åŸºæœ¬ä½¿ç”¨Bufferçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå­˜æ”¾æ•°æ®å†…å­˜å—ï¼Œå¯ä»¥çœ‹æˆä¸€ä¸ªå®¹å™¨å¯¹è±¡(å†…éƒ¨å«æœ‰æ•°ç»„)ï¼Œè¯¥å¯¹è±¡æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œèƒ½è®©æˆ‘ä»¬è½»æ¾çš„ä½¿ç”¨å†…å­˜å—(æ•°ç»„)ï¼Œç¼“å†²åŒºå¯¹è±¡å†…ç½®äº†ä¸€äº›æœºåˆ¶ï¼Œèƒ½å¤Ÿè·Ÿè¸ªå’Œè®°å½•ç¼“å†²åŒºçš„çŠ¶æ€å˜åŒ–æƒ…å†µã€‚ JDKä¸­Bufferçš„å­ç±»å¦‚ä¸‹ï¼š é¦–å…ˆï¼ŒBufferéƒ½å…·æœ‰4ä¸ªé‡è¦å±æ€§ï¼š 12345// Invariants: mark &lt;= position &lt;= limit &lt;= capacityprivate int mark = -1;private int position = 0;private int limit;private int capacity; Bufferåˆ†ä¸ºè¯»æ¨¡å¼å’Œå†™æ¨¡å¼ï¼Œä¸€æ¬¡è¯»æ“ä½œæˆ–å†™æ“ä½œéƒ½å¯èƒ½ä¼šå¯¼è‡´positionåç§»(å¯èƒ½å³ä¸ºJDKæä¾›äº†ä¸åŒçš„æ–¹æ³•ï¼Œæœ‰è¯»æ“ä½œåpositionåç§»çš„æ–¹æ³•ï¼Œä¹Ÿæœ‰è¯»æ“ä½œåpositionä¸åç§»çš„æ–¹æ³•)ï¼š Bufferçš„ä½¿ç”¨ï¼š 1234567891011121314151617public class LearnBuffer { public static void main(String[] args) { IntBuffer buffer = IntBuffer.allocate(5); // postion=0, capacity=5, limit=5, mark=-1 for (int i = 0; i &lt; buffer.capacity(); i++) { buffer.put(i*2); // æ¯æ¬¡putåpositionå±æ€§+1 } buffer.flip(); // å°†positioné‡ç½®åˆ°0 buffer.position(1); // å°†positionç½®ä¸º1 buffer.limit(3); // å°†limitç½®ä¸º3 while (buffer.hasRemaining()){ System.out.println(buffer.get()); // æ¯æ¬¡get()éƒ½ä¼šå¯¼è‡´postion+1 } }} 1.2 HeapBufferå’ŒDirectByteBufferâ€‹ HeapBufferè¢«ç§°ä¸ºNo-DirectBufferï¼Œè¿™ä¸€ç¼“å†²åŒºåˆ›å»ºåœ¨JVMå†…å­˜çš„å †åŒºä¸­ï¼Œå—åˆ°JVMçš„å†…å­˜ç®¡ç†ï¼Œåˆ›å»ºå’Œé‡Šæ”¾éƒ½æ˜¯ç”±JVMæ“ä½œçš„ã€‚ä¸Šé¢é€šè¿‡allocateæ–¹æ³•åˆ›å»ºçš„Bufferå°±æ˜¯HeapBufferã€‚ â€‹ åˆ©ç”¨HeapBufferè¯»å–æ•°æ®çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š â€‹ Javaç¨‹åºå‘æ“ä½œç³»ç»Ÿå‘èµ·read()çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ“ä½œç³»ç»Ÿè®©CPUå¯åŠ¨DMAæ¥å°†ç‰©ç†ç£ç›˜ä¸­çš„æ•°æ®è¯»å–åˆ°å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„ç¼“å†²åŒºï¼Œç„¶åå†å°†ç¼“å†²åŒºä¸­çš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·åœ°å€ç©ºé—´çš„Bufferå¯¹è±¡ä¸­ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸€æ¬¡ä»å†…æ ¸åœ°å€ç©ºé—´åˆ°ç”¨æˆ·åœ°å€ç©ºé—´çš„æ‹·è´ã€‚ç”±äºHeapBufferéœ€è¦ç»è¿‡ä¸€æ¬¡æ‹·è´ï¼Œå…¶ä¸BIOçš„æ–‡ä»¶æ“ä½œä»£ä»·ç›¸åŒï¼Œæ•ˆç‡ç›¸å·®ä¸å¤šï¼Œä½†ä¸‹é¢ä»‹ç»çš„DirectByteBufferæ•ˆç‡æ›´é«˜ã€‚ â€‹ é’ˆå¯¹å¦‚ä¸ŠHeapBufferçš„ä¸€æ¬¡æ‹·è´è¿›è¡Œä¼˜åŒ–ï¼ŒDirectByteBufferæ˜¯åˆ›å»ºåœ¨å †å¤–å†…å­˜åŒºçš„ï¼Œå³ä¸å—JVMçš„å†…å­˜ç®¡ç†æœºåˆ¶æ‰€æ§åˆ¶ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆDirectByteBufferå¯ä»¥å‡å°‘è¿™ä¸€æ¬¡æ‹·è´å‘¢ï¼Ÿ â€‹ è¿™è¦å½’åŠŸäºmmap()çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ç§æ–¹å¼çš„I/OåŸç†å°±æ˜¯å°†ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰çš„å†…å­˜åœ°å€å’Œå†…æ ¸ç¼“å†²åŒºï¼ˆkernel bufferï¼‰çš„å†…å­˜åœ°å€åšä¸€ä¸ªæ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿå°†å†…æ ¸åœ°å€ç©ºé—´çš„ç¼“å†²åŒºå’Œç”¨æˆ·åœ°å€ç©ºé—´çš„ç¼“å†²åŒºæ˜ å°„ç‰©ç†å†…å­˜ä¸Šçš„ç›¸åŒä½ç½®ï¼Œè¿™æ ·ä¸€æ¥å°±å¯é¿å…äº†ä»å†…æ ¸ç©ºé—´å‘åœ°å€ç©ºé—´çš„æ‹·è´æ¶ˆè€—ã€‚ åœ¨HeapBufferä¸­ï¼Œå†…æ ¸åœ°å€ç©ºé—´çš„ç¼“å†²é‡‡ç”¨çš„å°±æ˜¯DirectByteBufferï¼Œç„¶åå†æŠŠDirectBufferä¸­çš„æ•°æ®æ‹·è´åˆ°HeapBufferä¸­ã€‚é€šè¿‡è·Ÿè¸ªByteBufferçš„æºç å¯ä»¥æŸ¥çœ‹åˆ°å…¶read()æ–¹æ³•è°ƒç”¨åˆ°äº†IOUtilçš„read()æ–¹æ³•ï¼š 123456789101112131415161718192021static int read(FileDescriptor fd, ByteBuffer dst, long position, NativeDispatcher nd) throws IOException{ if (dst.isReadOnly()) throw new IllegalArgumentException(&quot;Read-only buffer&quot;); if (dst instanceof DirectBuffer) return readIntoNativeBuffer(fd, dst, position, nd); // Substitute a native buffer ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining()); // è·å¾—ä¸€ä¸ªä¸´æ—¶çš„DirectBuffer try { int n = readIntoNativeBuffer(fd, bb, position, nd); // ä½¿ç”¨nativeæ–¹æ³•åˆ©ç”¨DirectBufferè¿›è¡Œè¯»å– bb.flip(); if (n &gt; 0) dst.put(bb); // å°†DirectBufferè¯»å–åˆ°çš„æ•°æ®æ”¾å…¥åˆ°ByteBufferä¸­ return n; } finally { Util.offerFirstTemporaryDirectBuffer(bb); }} DirectBufferå¯ä»¥é€šè¿‡ByteBuffer.allocateDirect(int len)æ¥è¿›è¡Œç”³è¯·ã€‚ 1ByteBuffer byteBuffer = ByteBuffer.allocateDirect(1024); // ç”³è¯·å‡ºæ¥ä¸ºDirectByteBufferå¯¹è±¡ 1.3 DirectBufferè¯¦è§£è¯´æ˜ Javaä¸­ç”³è¯·çš„DirectBufferå­˜åœ¨çš„å†…å­˜åŒºåŸŸç©¶ç«Ÿæ˜¯å†…æ ¸åœ°å€ç©ºé—´è¿˜æ˜¯ç”¨æˆ·åœ°å€ç©ºé—´å‘¢ï¼Ÿ â€‹ DirectBuffer(ä»¥DirectByteBufferä¸ºä¾‹)å…¶å®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š 12345 Java | native |DirectByteBuffer | malloc'd[ address ] -+-&gt; [ data ] | ä¸€éƒ¨åˆ†ä¸ºJavaçš„å †å†…å¯¹è±¡ï¼ŒDirectByteBufferæ²¡æœ‰byteæ•°ç»„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªlong addressçš„å±æ€§ï¼Œè¯¥å±æ€§åœ¨Bufferç±»ä¸­æœ‰ï¼Œå®˜æ–¹æ³¨é‡Šè¯´æ˜åªç”¨äºDirectBufferæ‰æœ‰æ•ˆï¼š 12345public abstract class Buffer { // Used only by direct buffers // NOTE: hoisted here for speed in JNI GetDirectBufferAddress long address; â€‹ å¦ä¸€éƒ¨åˆ†ä¸ºåˆ©ç”¨cè¯­è¨€çš„mallocç”³è¯·çš„å­—èŠ‚æ•°ç»„ï¼Œè¯¥æ•°æ®å°±æ˜¯ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºæ˜¯ç”¨Cè¯­è¨€APIç”³è¯·çš„ï¼Œå±äºè¯¥è¿›ç¨‹ï¼Œä½äºç”¨æˆ·åœ°å€ç©ºé—´ï¼Œåªä¸è¿‡æ“ä½œç³»ç»Ÿè¯¥éƒ¨åˆ†å†…å­˜æœ‰è¯»å†™çš„æƒåˆ©ï¼Œä¸éœ€è¦ç»è¿‡å†…æ ¸åœ°å€ç©ºé—´çš„æ‹·è´ã€‚ â€‹ DirectBufferçš„ä¸»è¦ç¼“å†²åŒºå±äºå †å¤–å†…å­˜ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä¸å®Œå…¨è¢«JVMç®¡åˆ¶ï¼Œå› æ­¤ä½¿ç”¨éœ€è¦è°¨æ…ï¼Œå¿…é¡»ä½¿ç”¨Full GCæ‰èƒ½è¿›è¡Œå›æ”¶ï¼Œä½†æ˜¯Full GCçš„æ€§èƒ½æŸè€—å¾ˆå¤§ï¼Œå› æ­¤åˆç†ä½¿ç”¨DirectBufferæ‰èƒ½æœ‰æ›´é«˜çš„æ•ˆç‡ï¼ŒNettyå°è£…äº†DirectBufferæ¯”DirectBufferæ›´å¥½ç”¨ã€‚ ä¸ºä»€ä¹ˆDirectBufferè¦åœ¨å †å¤–ç”³è¯·ï¼Œä¸èƒ½ç”³è¯·åœ¨å †å†…æˆ–è€…ç›´æ¥ä½¿ç”¨HeapBufferè¿›è¡Œmmapå†…å­˜æ˜ å°„å—ï¼Ÿ â€‹ JVMå¹¶ä¸æ˜¯ä¸èƒ½ç›´æ¥ç”¨java HeapBufferæˆ–java byte[]ç›´æ¥åšIOè¯»å†™ï¼Œä½†JVMåœ¨GCè¿‡ç¨‹ä¸­ä¼šç§»åŠ¨å†…å­˜ï¼ŒJVMç§»åŠ¨å†…å­˜çš„æ“ä½œå¯¹æ“ä½œç³»ç»Ÿæ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤å¿…é¡»markæ­¤æ®µå†…å­˜ä¸èƒ½ç§»åŠ¨ï¼Œä»è€Œå½±å“GCæ•ˆç‡ï¼Œæ‰€æœ‰é‡‡ç”¨å †å¤–å†…å­˜æ›´ä¸ºåˆé€‚ã€‚ â€‹ Javaåˆ©ç”¨HeapBufferè¿›è¡ŒIOæ“ä½œæ—¶éƒ½ä¼šä½¿ç”¨åˆ°ä¸´æ—¶çš„DirectByteBufferç¼“å†²åŒºã€‚ æ€§èƒ½è¯´æ˜ â€‹ å¯¹äºæ–‡ä»¶çš„è¯»å†™ï¼Œä½¿ç”¨FileChannelçš„readæˆ–writeæ–¹æ³•æ— è®ºä¼ å…¥çš„æ˜¯HeapBufferè¿˜æ˜¯DirectBufferéƒ½æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„DirectBufferï¼Œæ‰€ä»¥æ•ˆç‡æ˜¯ç›¸åŒçš„ã€‚æƒ³è¦æœ‰æ›´é«˜çš„æ€§èƒ½ä½¿ç”¨MappedByteBufferå°±ä¸ä¼šè¿›è¡Œå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´äº†ã€‚ MappedByteBufferä½¿ç”¨ï¼š 1234567891011public static void main(String[] args) throws IOException { FileChannel inChannel = FileChannel.open(Paths.get(&quot;pom.xml&quot;), StandardOpenOption.READ); FileChannel outChannel = FileChannel.open(Paths.get(&quot;pom2.xml&quot;), StandardOpenOption.WRITE, StandardOpenOption.READ, StandardOpenOption.CREATE); // è¯»å–æ–‡ä»¶çš„ç¼“å†²ç©ºé—´ MappedByteBuffer mappedByteBuffer = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, inChannel.size()); outChannel.write(mappedByteBuffer); inChannel.close(); outChannel.close();} â€‹ ç”±äºJDKæ²¡æœ‰æä¾›ç›´æ¥å°†DirectBufferå†™åˆ°æ–‡ä»¶ä¸­çš„æ–¹æ³•ï¼Œå› æ­¤è¿˜æ˜¯éœ€è¦ä¸€æ¬¡æ‹·è´çš„ã€‚ æ™®é€šNIOæ–‡ä»¶æ‹·è´ï¼š 1234567891011public static void nioFileCopy() throws IOException { FileChannel inChannel = FileChannel.open(Paths.get(&quot;pom.xml&quot;), StandardOpenOption.READ); FileChannel outChannel = FileChannel.open(Paths.get(&quot;pom2.xml&quot;), StandardOpenOption.WRITE, StandardOpenOption.READ, StandardOpenOption.CREATE); ByteBuffer buf = ByteBuffer.allocate((int) inChannel.size()); buf.flip(); outChannel.write(buf); inChannel.close(); outChannel.close();} â€‹ ç›¸æ¯”MappedByyeBufferå¤šäº†ä¸€æ¬¡æ‹·è´ã€‚ 2 ChannelNIOçš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«å¦‚ä¸‹ï¼š é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™ é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ® é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†² JDKæä¾›çš„Channelç±»å‹æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„æœ‰FileChannel(æ–‡ä»¶è¯»å†™é€šé“)ã€DatagramChannel(UDPæ•°æ®ä¼ è¾“é€šé“)ã€ServerSocketChannel å’Œ SocketChannel (ServerSocketChanne ç±»ä¼¼ ServerSocket , SocketChannel ç±»ä¼¼ Socketï¼ŒTCPSæ•°æ®ä¼ è¾“)ã€‚ FileChannelç±»ï¼š ç”¨äºå¯¹æœ¬åœ°æ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œä¸»è¦çš„æ–¹æ³•æœ‰ï¼š 1234public int read(ByteBuffer dst) //ä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­public int write(ByteBuffer src) //æŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­public long transferFrom(ReadableByteChannel src, long position, long count) //ä»ç›®æ ‡é€šé“ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“public long transferTo(long position, long count, WritableByteChannel target) //æŠŠæ•°æ®ä»å½“å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“ å®ä¾‹â€“ä½¿ç”¨FileChannelå®ç°æ–‡æœ¬çš„æ‹·è´ 123456789101112131415161718192021222324252627public class LearnChannel { public static void main(String[] args) throws IOException { // åˆ›å»ºæ–‡ä»¶å¯¹è±¡ File file = new File(&quot;/Users/zhanglei/java/IdeaProjects/netty/src/main/java/com/tomcode/nio/LearnChannel.java&quot;); File target = new File(&quot;j.txt&quot;); // åˆ›å»ºæµå¯¹è±¡ FileInputStream fileInputStream = new FileInputStream(file); FileOutputStream fileOutputStream = new FileOutputStream(target); // è·å–channelï¼Œchanneléœ€è¦ä»æµå¯¹è±¡ä¸­è·å–ï¼Œæµå¯¹è±¡ä¸­å…·æœ‰channelå±æ€§ä½†æ˜¯ä¸ºç©ºï¼Œå½“è°ƒç”¨getChannelæ—¶ä¼šåˆ›å»ºchannelå¯¹è±¡ FileChannel inputChannel = fileInputStream.getChannel(); FileChannel outputChannel = fileOutputStream.getChannel(); // åˆ›å»ºç¼“å†²åŒº ByteBuffer buffer = ByteBuffer.allocate(512); // æŠŠinputchannelä¸­çš„æ•°æ®å†™åˆ°bufferä¸­ç„¶åæŠŠbufferå†™åˆ°outputchannel int len = -1; while((len = inputChannel.read(buffer)) != -1){ buffer.flip(); outputChannel.write(buffer); buffer.clear(); // å¿…é¡»clear()ï¼Œå¦åˆ™postion=limitæ— æ³•å†è¯»å…¥æ•°æ®ï¼Œæ¯æ¬¡len=0é™·å…¥æ­»å¾ªç¯ } // æµå¯¹è±¡å…³é—­channelå°±ä¼šå…³é—­ fileInputStream.close(); fileOutputStream.close(); }} åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨transferFromå°±å¯ä»¥ç›´æ¥å®Œæˆæ‹·è´è€Œä¸éœ€è¦ä½¿ç”¨ç¼“å†²åŒºäº†(å…¶å®åº•å±‚ä¹Ÿæ˜¯åˆ©ç”¨äº†ç¼“å†²åŒº)ã€‚ 1outputChannel.transferFrom(inputStream); ä½¿ç”¨Channelå’ŒBufferçš„æ³¨æ„äº‹é¡¹ ByteBuffer æ”¯æŒç±»å‹åŒ–çš„put å’Œ get, putæ”¾å…¥çš„æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œgetå°±åº”è¯¥ä½¿ç”¨ç›¸åº”çš„æ•°æ®ç±»å‹æ¥å–å‡ºï¼Œå¦åˆ™å¯èƒ½æœ‰BufferUnderflow-Exception å¼‚å¸¸ã€‚(putIntâ€“getIntï¼ŒputCharâ€“getChar) NIO è¿˜æä¾›äº† MappedByteBufferï¼Œ å¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–çš„å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œæ•ˆç‡å¾ˆé«˜ã€‚ å‰é¢æˆ‘ä»¬è®²çš„è¯»å†™æ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªBuffer å®Œæˆçš„ï¼ŒNIO è¿˜æ”¯æŒ é€šè¿‡å¤šä¸ªBuffer (å³ Buffer æ•°ç»„) å®Œæˆè¯»å†™æ“ä½œï¼Œå³ Scattering å’Œ Gathering 3 SelectorSelectoré€‰æ‹©å™¨ï¼Œä½œç”¨æ˜¯ç”¨äºç®¡ç†å¤šä¸ªChannelï¼Œä½¿ç”¨Selectorå®ç°IOå¤šè·¯å¤ç”¨ï¼Œé€šå¸¸ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªSelectorï¼Œè€Œä¸€ä¸ªSelectorå¯¹åº”å¤šä¸ªChannelè´Ÿè´£I/Oï¼Œå…¶å·¥ä½œçš„ä¸»è¦æ­¥éª¤ï¼š (1) åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œåˆ›å»ºServerSocketChannelå¹¶åˆ©ç”¨SelectionKey register(Selector sel, int ops)æ–¹æ³•æ³¨å†Œåˆ°Selectorä¸­ï¼Œæ¯ä¸ªchannelåœ¨ä¸€ä¸ªSelectorä¸­å¯¹åº”ä¸€ä¸ªçš„SelectionKeyã€‚ (2) åœ¨å¾ªç¯ä¸­è°ƒç”¨Selectorçš„int select()æ–¹æ³•æ¥åˆ¤æ–­æ˜¯Selectorä¸­æ˜¯å¦æœ‰Channeléœ€è¦å¤„ç†(è¿”å›å€¼ä¸ºéœ€è¦å¤„ç†çš„channelæ•°é‡)ï¼Œæ³¨æ„select()æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œæƒ³è¦éé˜»å¡å¯ä»¥è°ƒç”¨select(int timeout)æˆ–selectNow()ã€‚ (3) æ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦è¿æ¥æœåŠ¡å™¨æ—¶ï¼ŒSelectorçš„selectæ–¹æ³•ä¼šè¿”å›1ï¼Œæ­¤æ—¶è¡¨æ˜æœ‰channelå‘ç”Ÿäº†äº‹ä»¶éœ€è¦å¤„ç†ï¼Œé‚£ä¹ˆå°±é€šè¿‡Selectorçš„selectKeys()æ–¹æ³•è·å–åˆ°æ‰€æœ‰äº‹ä»¶çš„SelectionKeyï¼Œå¯ä»¥é€šè¿‡SelectionKeyåˆ¤æ–­å…¶å¯¹åº”çš„æ˜¯å¦ä¸ºServerSocketChannelï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨å…¶accept()æ–¹æ³•(ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºå·²ç»åˆ¤æ–­å‡ºæœ‰å®¢æˆ·ç«¯è¦è¿æ¥)ã€‚ (4) é€šè¿‡ServerSocketChannelçš„acceptæ–¹æ³•éƒ½èƒ½è·å–åˆ°ä¸€ä¸ªSocketChannelï¼Œå°†è¿™ä¸ªSocketChannelæ³¨å†Œåˆ°Selectorä¸­ã€‚ (5) å›åˆ°(2)çš„å¾ªç¯ï¼Œå»åˆ¤æ–­å„ä¸ªchannelæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæœ‰çš„è¯é€šè¿‡SocketChannelå’ŒServerSocketChannelåˆ†å¼€å¤„ç†ï¼ŒServerSocketChannelæœ‰äº‹ä»¶å°±è·å–SocketChannelæ³¨å†Œåˆ°Selectorï¼ŒSocketChannelæœ‰æ—¶é—´å°±è¯»å†™ã€‚ å®ä¾‹â€“ä½¿ç”¨Selectoræ¥å®ç°æœåŠ¡ç«¯ï¼š serverç«¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public class SelectorLearn { public static void main(String[] args) throws IOException { // åˆ›å»ºServerSocketChannel ServerSocketChannel server = ServerSocketChannel.open(); server.socket().bind(new InetSocketAddress(8888)); // åˆ›å»ºSelector Selector selector = Selector.open(); // è®¾ç½®Channelä¸ºéé˜»å¡çš„ server.configureBlocking(false); // å°†serveræ³¨å†Œåˆ°selectorï¼Œä¸ºACCEPTæ“ä½œï¼ŒServerSocketChannelæ‰ä¸ºè¯¥æ–¹å¼ server.register(selector, SelectionKey.OP_ACCEPT); while (true) { if(selector.select(1000) == 0){ // ç­‰å¾…è·å–200msï¼Œæ²¡æœ‰äº‹ä»¶ System.out.println(&quot;1sæ²¡æœ‰äº‹ä»¶&quot;); continue; } System.out.println(&quot;event!&quot;); // è·å–å¹¶éå†æœ‰äº‹ä»¶å‘ç”Ÿçš„SelectionKey Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys(); Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator(); while(iterator.hasNext()){ SelectionKey key = iterator.next(); if(key.isAcceptable()){ // è¯æ˜æ˜¯ServerSocketChannelï¼Œè·å–å¯¹åº”çš„SocketChannel SocketChannel socket = server.accept(); socket.configureBlocking(false); // å‘selectoræ³¨å†Œsocketï¼Œä¸ºè¯»æ“ä½œäº‹ä»¶(å› ä¸ºå»ºç«‹è¿æ¥ä¸ä¸€å®šé©¬ä¸Šæœ‰æ•°æ®ä¼ è¾“) socket.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024)); } if(key.isReadable()){ // è¯æ˜æ˜¯SocketChannel SocketChannel socket = (SocketChannel) key.channel(); ByteBuffer buf = (ByteBuffer) key.attachment(); socket.read(buf); String content = new String(buf.array()); System.out.println(&quot;æ”¶åˆ°:&quot; + content); } // å¤„ç†å¿…é¡»ä»é›†åˆä¸­ç§»é™¤ï¼Œå¦åˆ™ä¼šé‡å¤å¤„ç† iterator.remove(); } } }} è¯´æ˜ï¼š ä¸€ä¸ªSelectorå¯ä»¥æ³¨å†Œå¤šä¸ªChannelï¼Œä¹Ÿå¯ä»¥æ³¨å†Œä¸åŒç§ç±»çš„Channelï¼ˆSocketChannel/ServerSocketChannelï¼‰ï¼Œæ¯ä¸ªChannelåœ¨æ³¨å†Œåˆ°æŸä¸ªSelectorä¸Šæ—¶ä¼šç”Ÿæˆä¸€ä¸ªSelectionKeyå¯¹è±¡ï¼Œé‡Œé¢ä¿å­˜äº†Channelï¼ŒSelectorä»¥åé€‰æ‹©çš„å°±æ˜¯SelectionKeyå¯¹è±¡ï¼ŒSelectionKeyä¸Channelä¸€ä¸€å¯¹åº”ã€‚ å½“è°ƒç”¨äº†Selectorçš„selectKeysæ–¹æ³•åï¼Œå¦‚æœæ­¤æ—¶ServerSocketChannelæœ‰å¤šä¸ªè¿æ¥è¯·æ±‚ï¼Œåœ¨è°ƒç”¨acceptåä¹Ÿåªä¼šè¿æ¥ä¸€ä¸ªï¼Œç„¶åå†å¾ªç¯æ—¶å› ä¸ºè¿˜æœ‰è¿æ¥æœªå¤„ç†åˆ™ServerSocketChannelè¿˜æ˜¯æœ‰äº‹ä»¶ï¼Œæ¥ç€å°±å¯ä»¥å¤„ç†ä¸‹ä¸€ä¸ªè¿æ¥ã€‚é‚£ä¹ˆè¿˜æœªè¢«acceptçš„è¿æ¥éƒ½ä¼šå­˜å‚¨åœ¨æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ä¸­ç­‰å¾…åº”ç”¨ç¨‹åºå¤„ç†ã€‚ Selectorï¼š 1234567selector.select(); //é˜»å¡selector.select(1000); //é˜»å¡1000æ¯«ç§’ï¼Œåœ¨1000æ¯«ç§’åè¿”å›selector.wakeup(); //å”¤é†’selectorselector.selectNow(); //ä¸é˜»å¡ï¼Œç«‹é©¬è¿”è¿˜selector.selectedKeys(); // å½“å‰æœ‰äº‹ä»¶å‘ç”Ÿçš„SelectionKeyselector.keys(); // selectorä¸­æ³¨å†Œçš„æ‰€æœ‰SelectionKey SelectionKeyï¼š 123456789101112int OP_ACCEPTï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥ acceptï¼Œå€¼ä¸º 16int OP_CONNECTï¼šä»£è¡¨è¿æ¥å·²ç»å»ºç«‹ï¼Œå€¼ä¸º 8int OP_READï¼šä»£è¡¨è¯»æ“ä½œï¼Œå€¼ä¸º 1 int OP_WRITEï¼šä»£è¡¨å†™æ“ä½œï¼Œå€¼ä¸º 4 public abstract Selector selector(); //å¾—åˆ°ä¸ä¹‹å…³è”çš„ Selector å¯¹è±¡public abstract SelectableChannel channel(); //å¾—åˆ°ä¸ä¹‹å…³è”çš„é€šé“public final Object attachment(); //å¾—åˆ°ä¸ä¹‹å…³è”çš„å…±äº«æ•°æ®public abstract SelectionKey interestOps(int ops); //è®¾ç½®æˆ–æ”¹å˜ç›‘å¬äº‹ä»¶public final boolean isAcceptable(); //æ˜¯å¦å¯ä»¥ acceptpublic final boolean isReadable(); //æ˜¯å¦å¯ä»¥è¯»public final boolean isWritable(); //æ˜¯å¦å¯ä»¥å†™ ServerSocketChannelï¼š ServerSocketChannel åœ¨æœåŠ¡å™¨ç«¯ç›‘å¬æ–°çš„å®¢æˆ·ç«¯ Socket è¿æ¥ 12345public static ServerSocketChannel open(); // å¾—åˆ°ä¸€ä¸ª ServerSocketChannel é€šé“public final ServerSocketChannel bind(SocketAddress local); // è®¾ç½®æœåŠ¡å™¨ç«¯ç«¯å£å·public final SelectableChannel configureBlocking(boolean block); // è®¾ç½®é˜»å¡æˆ–éé˜»å¡æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼public SocketChannel accept(); // æ¥å—ä¸€ä¸ªè¿æ¥ï¼Œè¿”å›ä»£è¡¨è¿™ä¸ªè¿æ¥çš„é€šé“å¯¹è±¡public final SelectionKey register(Selector sel, int ops); // æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶è®¾ç½®ç›‘å¬äº‹ä»¶ SocketChannelï¼š SocketChannelï¼Œç½‘ç»œ IO é€šé“ï¼Œå…·ä½“è´Ÿè´£è¿›è¡Œè¯»å†™æ“ä½œã€‚NIO æŠŠç¼“å†²åŒºçš„æ•°æ®å†™å…¥é€šé“ï¼Œæˆ–è€…æŠŠé€šé“é‡Œçš„æ•°æ®è¯»åˆ°ç¼“å†²åŒºã€‚ 12345678public static SocketChannel open();//å¾—åˆ°ä¸€ä¸ª SocketChannel é€šé“public final SelectableChannel configureBlocking(boolean block);//è®¾ç½®é˜»å¡æˆ–éé˜»å¡æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼public boolean connect(SocketAddress remote);//è¿æ¥æœåŠ¡å™¨public boolean finishConnect();//å¦‚æœä¸Šé¢çš„æ–¹æ³•è¿æ¥å¤±è´¥ï¼Œæ¥ä¸‹æ¥å°±è¦é€šè¿‡è¯¥æ–¹æ³•å®Œæˆè¿æ¥æ“ä½œpublic int write(ByteBuffer src);//å¾€é€šé“é‡Œå†™æ•°æ®public int read(ByteBuffer dst);//ä»é€šé“é‡Œè¯»æ•°æ®public final SelectionKey register(Selector sel, int ops, Object att);//æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶è®¾ç½®ç›‘å¬äº‹ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°å¯ä»¥è®¾ç½®å…±äº«æ•°æ®public final void close();//å…³é—­é€šé“","link":"/2020/08/31/NIO/"},{"title":"Nettyæ ¸å¿ƒç»„ä»¶-ChannelFuture","text":"Nettyçš„ç‰¹ç‚¹å°±æ˜¯å¼‚æ­¥éé˜»å¡çš„ç½‘ç»œæ¡†æ¶ï¼Œåœ¨Nettyä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬è°ƒç”¨IOæ“ä½œçš„æ–¹æ³•åï¼Œæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªFutureç±»å‹çš„å¯¹è±¡(ä¸€èˆ¬ä¸ºChannelFuture)ï¼ŒChannelFutureç»§æ‰¿äºJDKçš„Futureå¯¹è±¡ï¼Œå¯¹Futureè¿›è¡Œäº†æ‰©å……ã€‚ JDKä¸­çš„Futureâ€‹ ä»JDK1.5å¼€å§‹å®˜æ–¹æä¾›äº†Callableå’ŒFutureæ¥å£ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªæ¥å£ï¼Œå¯ä»¥ä½¿å¾—çˆ¶çº¿ç¨‹åœ¨å­çº¿ç¨‹æ‰§è¡Œå®Œåå¾—åˆ°ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚ â€‹ å½“ä¸€ä¸ªæ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œè€Œåé¢å°†è¦æ‰§è¡Œçš„å‡ ä¸ªä»»åŠ¡ä¸è¿™ä¸ªæ“ä½œçš„ç»“æœæ— å…³ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œï¼Œè¿™ä¸å‰ç«¯jsä¸­çš„ajaxæ˜¯ç›¸åŒçš„åŸç†ã€‚åœ¨æ‰§è¡Œè¯¥å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬é©¬ä¸Šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå°†è€—æ—¶çš„æ“ä½œæ”¾åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ ·æˆ‘ä»¬åœ¨çˆ¶çº¿ç¨‹ä¸­å°±å¯ä»¥è¿›è¡Œå…¶ä»–çš„æ“ä½œï¼ŒçœŸæ­£çš„æ•°æ®å¯ä»¥ç­‰åˆ°æˆ‘ä»¬éœ€è¦å®ƒçš„æ—¶å€™å†ä»å‡½æ•°çš„è¿”å›å¯¹è±¡ä¸­è·å–å‡ºæ¥ã€‚ Callableä¸RunnableJDKçš„çº¿ç¨‹æ± ä¸­å¯ä»¥æäº¤ä¸¤ç§ç±»å‹çš„æ¥å£ï¼Œå³Callableä¸Runnableã€‚ â€‹ java.lang.Runnableæ˜¯JDKæ—©æœŸæä¾›çš„çº¿ç¨‹ç›¸å…³çš„ç±»ï¼Œå½“åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶æˆ–è€…æƒ³çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œéœ€è¦å°†Runnableæ¥å£çš„å¯¹è±¡ä¼ é€’è¿›å»ï¼Œé‚£ä¹ˆåœ¨çº¿ç¨‹åˆ†åˆ°æ—¶é—´ç‰‡æ—¶å°±ä¼šè‡ªåŠ¨çš„è°ƒç”¨Runnableä¸­å”¯ä¸€çš„runæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ã€‚ 123public interface Runnable { public abstract void run();} â€‹ â€‹ è€Œjava.util.concurrent.Callableæ˜¯JDKåç»­æä¾›çš„ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒæ ·å‘çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œä¹Ÿå¯ä¼ é€’ä»¥ä¸ªCallableå¯¹è±¡(è‡ªå·±åˆ›å»ºçº¿ç¨‹æ—¶ä¸èƒ½ä¼ é€’Callableå¯¹è±¡ï¼Œå› ä¸ºThreadæ²¡æœ‰æä¾›Callableçš„æ„é€ å‡½æ•°)ï¼ŒCallableæ¥å£æœ‰ä¸€ä¸ªæ–¹æ³•call()ï¼Œåœ¨çº¿ç¨‹åˆ†é…åˆ°æ—¶é—´ç‰‡æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨call()æ–¹æ³•ï¼Œä¸Runnbaleä¸åŒçš„æ˜¯ï¼Œcall()æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ã€‚ 123public interface Callable&lt;V&gt; { V call() throws Exception;} FutureJDKä¸­å®ç°å¼‚æ­¥æ“ä½œéœ€è¦Callableé…åˆFutureä½¿ç”¨ï¼ŒFutureå°±æ˜¯å¯¹äºå…·ä½“çš„Runnableæˆ–è€…Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœã€‚å¿…è¦æ—¶å¯ä»¥é€šè¿‡getæ–¹æ³•è·å–æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡è¿”å›ç»“æœã€‚ 12345678public interface Future&lt;V&gt; { boolean cancel(boolean mayInterruptIfRunning); // å–æ¶ˆä»»åŠ¡ boolean isCancelled(); // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å–æ¶ˆ boolean isDone(); // ä»»åŠ¡æ˜¯å¦å®Œæˆ V get() throws InterruptedException, ExecutionException; // é˜»å¡è·å–ä»»åŠ¡çš„ç»“æœ V get(long timeout, TimeUnit unit) // å¸¦è¶…æ—¶çš„è·å–ä»»åŠ¡ç»“æœ throws InterruptedException, ExecutionException, TimeoutException;} é‚£ä¹ˆå¦‚ä½•é€šè¿‡Callableä¸Futureæ¥å®ç°å¼‚æ­¥æ“ä½œå‘¢ï¼Ÿåœ¨JDKæä¾›çš„çº¿ç¨‹æ± ExecutorServiceä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°submitæ–¹æ³•æœ‰ä¸åŒçš„é‡è½½ç‰ˆæœ¬ 123&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);Future&lt;?&gt; submit(Runnable task); è¿™æ„å‘³ç€æˆ‘ä»¬æƒ³çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªCallableæ–¹æ³•å¯ä»¥å¾—åˆ°ä¸€ä¸ªFutureå¯¹è±¡ï¼Œåœ¨æœªæ¥çš„æŸä¸ªåœ°æ–¹æˆ‘ä»¬å¯ä»¥è°ƒç”¨Futureå¯¹è±¡çš„get()æ–¹æ³•æ¥è·å–åˆ°è¯¥ä»»åŠ¡è¿”å›çš„ç»“æœã€‚ 12345678910111213141516171819202122232425@Slf4jpublic class SchedulePool { public static void main(String[] args) throws ExecutionException, InterruptedException { ExecutorService executorService = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors()*2); log.debug(&quot;submit other task&quot;); Future&lt;Integer&gt; hello = executorService.submit(() -&gt; { try { sleep(1500); } catch (InterruptedException e) { e.printStackTrace(); } log.debug(&quot;hello&quot;); return 2; }); log.debug(&quot;main task start&quot;); Thread.sleep(1000); log.debug(&quot;main task end&quot;); Integer i = hello.get(); log.debug(&quot;{}&quot;,i); executorService.shutdown(); }} è¾“å‡ºï¼š 1234510:35:57.249 com.zl.threadpool.SchedulePool [main] - submit other task10:35:57.284 com.zl.threadpool.SchedulePool [main] - main task start10:35:58.289 com.zl.threadpool.SchedulePool [main] - main task end10:35:58.789 com.zl.threadpool.SchedulePool [pool-1-thread-1] - hello10:35:58.789 com.zl.threadpool.SchedulePool [main] - 2 â€‹ ä»æ‰“å°ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æäº¤ä»»åŠ¡åæˆ‘ä»¬é©¬ä¸Šæ‹¿åˆ°ä¸€ä¸ªFutureå¯¹è±¡(æ­¤æ—¶ä»»åŠ¡è¿˜æœªæ‰§è¡Œå®Œè¿”å›)ï¼Œæˆ‘ä»¬æ¥ç€æ‰§è¡Œäº†æ‰“å°æ“ä½œï¼Œç„¶åé€šè¿‡Futureå¯¹è±¡çš„getæ–¹æ³•é˜»å¡è·å–äº†å…ˆå‰æäº¤ä»»åŠ¡çš„è¿”å›ç»“æœï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆåæ‰æ‹¿åˆ°äº†ç»“æœæ‰“å°ã€‚ â€‹ æœ¬æ¥ä¸¤ä¸ªä»»åŠ¡éœ€è¦1s+1.5s=2.5sæ‰èƒ½å¤Ÿå®Œæˆï¼Œç°åœ¨åªéœ€è¦1.5så°±èƒ½å¤Ÿå®Œæˆã€‚ â€‹ æäº¤Runnableå¯¹è±¡å°±æ— æ³•æ‹¿åˆ°è¿”å›çš„ç»“æœï¼Œä¸è¿‡ä¹Ÿä¼šè¿”å›ä¸€ä¸ªFutureå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œå³è°ƒç”¨Futureçš„getæ–¹æ³•è¿”å›çš„æ˜¯nullï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡Futureçš„isDoneæ–¹æ³•åˆ¤æ–­runæ–¹æ³•æ˜¯å¦æ‰§è¡Œå®Œæˆã€‚ FutureTaskâ€‹ ä¸é€šè¿‡çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œæƒ³è¦é€šè¿‡Threadç±»æ¥å®ç°å¼‚æ­¥è°ƒç”¨åè¿”å›ç»“æœå¯ä»¥ä½¿ç”¨FutureTaskç±»ï¼ŒFutureTaskç±»å…¶å®ä¹Ÿæ˜¯å®ç°äº†Runableæ¥å£ï¼Œå’ŒRunableåˆ›å»ºæ–¹æ³•ç±»ä¼¼ï¼Œæ­¤å¤–ï¼ŒFutureTaskè¿˜å®ç°äº†Futureæ¥å£ï¼Œå¯é€šè¿‡FutureTaskè·å–æ‰§è¡Œç»“æœã€‚ â€‹ FutureTaskçš„æ„é€ å‡½æ•°å¿…é¡»ä¼ å…¥Callableå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»FutureTaskä¸­getåˆ°Callableçš„æ‰§è¡Œç»“æœã€‚ 123456789101112131415161718public class CreateThread_FutureTask { public static void main(String[] args) throws ExecutionException, InterruptedException { FutureTask&lt;Integer&gt; task = new FutureTask&lt;&gt;(new Callable&lt;Integer&gt;() { @Override public Integer call() throws Exception { Thread.sleep(1000); System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œäº†&quot;); return 1; } }); Thread thread = new Thread(task, &quot;thread1&quot;); thread.start(); Integer integer = task.get(); // é˜»å¡ï¼Œç­‰å¾…taskä»»åŠ¡çš„è¿”å›ç»“æœ System.out.println(integer); // æ‰“å°1 }} Futureçš„ç¼ºç‚¹åªèƒ½ç”¨ä»¥ä¸‹æ–¹å¼è·å–ç»“æœï¼š V get()é˜»å¡ç­‰å¾… è½®è¯¢boolean isDone(); æœ‰é™ç­‰å¾…V get(long timeout, TimeUnit unit) æ‰§è¡ŒçŠ¶æ€åªæœ‰ä¸¤ç§ï¼š boolean isDone(); boolean isCancelled(); é—®é¢˜ï¼š æ¥å£ä¸­åªæœ‰isDone()æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªå¼‚æ­¥æ“ä½œæ˜¯å¦å®Œæˆï¼Œä½†æ˜¯å¯¹äºå®Œæˆçš„å®šä¹‰è¿‡äºæ¨¡ç³Šï¼ŒJDKæ–‡æ¡£æŒ‡å‡ºæ­£å¸¸ç»ˆæ­¢ã€æŠ›å‡ºå¼‚å¸¸ã€ç”¨æˆ·å–æ¶ˆéƒ½ä¼šä½¿isDone()æ–¹æ³•è¿”å›çœŸã€‚åœ¨æˆ‘ä»¬çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ææœ‰å¯èƒ½æ˜¯å¯¹è¿™ä¸‰ç§æƒ…å†µåˆ†åˆ«å¤„ç†ï¼Œè€ŒJDKè¿™æ ·çš„è®¾è®¡ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ å¯¹äºä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬æ›´å…³å¿ƒçš„æ˜¯è¿™ä¸ªå¼‚æ­¥æ“ä½œè§¦å‘æˆ–è€…ç»“æŸåèƒ½å¦å†æ‰§è¡Œä¸€ç³»åˆ—åŠ¨ä½œã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æµè§ˆç½‘é¡µæ—¶ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®åå®ç°ç”¨æˆ·ç™»å½•ã€‚åœ¨javascriptä¸­ï¼Œå¤„ç†ä»£ç å¦‚ä¸‹ï¼š 123$(&quot;#login&quot;).click(function(){ login(); }); Nettyä¸­çš„Futureâ€‹ é‰´äºJDKæä¾›çš„Futureå¯¹è±¡çš„ç¼ºç‚¹ï¼ŒNettyå¯¹JDKçš„Futureè¿›è¡Œäº†æ‰©å±•ï¼ŒåŒæ ·ä¹Ÿå‘½åä¸ºFutureï¼Œä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415// å¼‚æ­¥æ“ä½œå®Œæˆä¸”æ­£å¸¸ç»ˆæ­¢boolean isSuccess();// å¼‚æ­¥æ“ä½œæ˜¯å¦å¯ä»¥å–æ¶ˆboolean isCancellable();// å¼‚æ­¥æ“ä½œå¤±è´¥çš„åŸå› Throwable cause();// æ·»åŠ ä¸€ä¸ªç›‘å¬è€…ï¼Œå¼‚æ­¥æ“ä½œå®Œæˆæ—¶å›è°ƒï¼Œç±»æ¯”javascriptçš„å›è°ƒå‡½æ•°Future&lt;V&gt; addListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener);Future&lt;V&gt; removeListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener);// é˜»å¡ç›´åˆ°å¼‚æ­¥æ“ä½œå®ŒæˆFuture&lt;V&gt; await() throws InterruptedException;// åŒä¸Šï¼Œä½†å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸Future&lt;V&gt; sync() throws InterruptedException;// éé˜»å¡åœ°è¿”å›å¼‚æ­¥ç»“æœï¼Œå¦‚æœå°šæœªå®Œæˆè¿”å›nullV getNow(); ä»Futureå¯¹è±¡ä¸­å¯ä»¥è·å–ä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€ï¼š æœªæ‰§è¡Œå®Œæˆæ—¶ï¼ŒisDoneè¿”å›falseï¼Œå…¶ä»–çš„è‡ªç„¶è¿”å›falseã€‚è€Œå½“ä»»åŠ¡å®Œæˆåï¼ŒisDoneä¸ºtrueï¼Œä½†æ˜¯å®Œæˆçš„çŠ¶æ€å¯èƒ½æ˜¯æˆåŠŸå®Œæˆäº†ï¼Œä¹Ÿå¯èƒ½æ˜¯å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¿˜å¯èƒ½æ˜¯è¢«å–æ¶ˆå¯¹åº”äºå³è¾¹ä¸‰ä¸ªçŠ¶æ€ã€‚ 12345678910111213141516* +---------------------------+* | Completed successfully |* +---------------------------+* +----&gt; isDone() = true |* +--------------------------+ | | isSuccess() = true |* | Uncompleted | | +===========================+* +--------------------------+ | | Completed with failure |* | isDone() = false | | +---------------------------+* | isSuccess() = false |----+----&gt; isDone() = true |* | isCancelled() = false | | | cause() = non-null |* | cause() = null | | +===========================+* +--------------------------+ | | Completed by cancellation |* | +---------------------------+* +----&gt; isDone() = true |* | isCancelled() = true |* +---------------------------+ åœ¨JDKä¸­ï¼Œæˆ‘ä»¬ä»Futureä¸­è·å–çš„æ•°æ®æ˜¯ä»Callableæ¥å£çš„callæ–¹æ³•è¿”å›å€¼è·å–çš„ï¼ŒJDKçš„å¼‚æ­¥å®ç°æ–¹å¼æ˜¯Future+Callableã€‚è€Œåœ¨Nettyä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨Callableæ¥å£ï¼Œè€Œæ˜¯è‡ªå·±æä¾›äº†Promiseæ¥å£ç»§æ‰¿Futureæ¥å£æä¾›æ•°æ®ã€‚ 123456789101112public interface Promise&lt;V&gt; extends Future&lt;V&gt; { // æ ‡è®°å¼‚æ­¥æ“ä½œç»“æœä¸ºæˆåŠŸï¼Œå¦‚æœå·²è¢«è®¾ç½®ï¼ˆä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰åˆ™æŠ›å‡ºå¼‚å¸¸IllegalStateException Promise&lt;V&gt; setSuccess(V result); // åŒä¸Šï¼Œåªæ˜¯ç»“æœå·²è¢«è®¾ç½®æ—¶è¿”å›False boolean trySuccess(V result); // è®¾ç½®å¤±è´¥ Promise&lt;V&gt; setFailure(Throwable cause); boolean tryFailure(Throwable cause); // è®¾ç½®ä¸å¯å–æ¶ˆ boolean setUncancellable();} éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒsetSucessä¸setFailureåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä»»ä½•ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨è¿‡äº†éƒ½ä¸èƒ½å†è°ƒç”¨äº†ï¼Œå†æ¬¡è°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¸¤ä¸ªæ–¹æ³•ä¼šé€šçŸ¥æ·»åŠ åˆ°å…¶å†…éƒ¨çš„Listeneræ‰§è¡Œå¯¹åº”çš„è¡Œä¸ºã€‚ GenericFutureListener GenericFutureListeneræ˜¯Futureå¯¹è±¡çš„ç›‘å¬è€…ï¼Œåœ¨Futureå¯¹è±¡å®Œæˆä»»åŠ¡åï¼Œå›è°ƒå…¶ä¸­çš„operationCompleteæ–¹æ³•ã€‚ 123456789public interface GenericFutureListener&lt;F extends Future&lt;?&gt;&gt; extends EventListener { /** * Invoked when the operation associated with the {@link Future} has been completed. * * @param future the source {@link Future} which called this callback */ void operationComplete(F future) throws Exception;} å…³äºNettyå¼‚æ­¥è°ƒç”¨çš„éƒ¨åˆ†ç±»ç»“æ„å›¾å¦‚ä¸‹: â€‹ AbstractFuture è¯¥æŠ½è±¡ç±»å®ç°äº†ä¸¤ä¸ªget()æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœï¼Œä¸‹é¢ç»™å‡ºå…¶ä¸­ä¸€ä¸ªï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å¸¦è¶…æ—¶çš„getã€‚ 123456789101112131415public abstract class AbstractFuture&lt;V&gt; implements Future&lt;V&gt; { @Override public V get() throws InterruptedException, ExecutionException { await(); // é˜»å¡ç­‰å¾…å”¤é†’ Throwable cause = cause(); // è·å–æ˜¯å¦æœ‰å¼‚å¸¸ if (cause == null) { return getNow(); // æ— å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœï¼Œæœ‰å¯èƒ½è¿˜æœªæ‰§è¡Œå®Œ(è¢«æ‰“æ–­çš„æƒ…å†µ) } if (cause instanceof CancellationException) { throw (CancellationException) cause; } throw new ExecutionException(cause); } ChannelFuture ChannelFutureä¸»è¦æ·»åŠ äº†ä¸¤ä¸ªæ–¹æ³• 123456public interface ChannelFuture extends Future&lt;Void&gt; { // è¿”å›å…³è”æ­¤Futureå¯¹è±¡çš„channel Channel channel(); // è¯¥Futureæ˜¯å¦æœ‰è¿”å›æ•°æ® boolean isVoid(); DefaultPromise DefaultPromiseå®ç°äº†å¤§å¤šçš„Promiseæ¥å£å’ŒFutureæ¥å£çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738@Overridepublic Promise&lt;V&gt; setSuccess(V result) { if (setSuccess0(result)) { // è®¾ç½®ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå¹¶å°†ç»“æœæ”¾å…¥ notifyListeners(); // é€šçŸ¥ç›‘å¬è€…ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œåšå‡ºç›¸åº”åŠ¨ä½œ return this; } throw new IllegalStateException(&quot;complete already: &quot; + this);}@Overridepublic Promise&lt;V&gt; setFailure(Throwable cause) { if (setFailure0(cause)) { // è®¾ç½®ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå¹¶å°†åŸå› æ”¾å…¥ notifyListeners(); // é€šçŸ¥ç›‘å¬è€…ä»»åŠ¡å®Œæˆï¼Œåšå‡ºç›¸åº”çš„åŠ¨ä½œ return this; } throw new IllegalStateException(&quot;complete already: &quot; + this, cause);}@Overridepublic boolean isSuccess() { Object result = this.result; // æ‰§è¡Œç»“æœ return result != null &amp;&amp; result != UNCANCELLABLE &amp;&amp; !(result instanceof CauseHolder);}@Overridepublic Promise&lt;V&gt; addListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener) { checkNotNull(listener, &quot;listener&quot;); synchronized (this) { addListener0(listener); // æ·»åŠ ç›‘å¬è€… } if (isDone()) { notifyListeners(); // å¦‚æœä»»åŠ¡æ˜¯å®Œæˆäº†çš„ï¼Œå°±é€šçŸ¥æ‰€æœ‰çš„Listener } return this;} è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹é€šçŸ¥ç›‘å¬è€…çš„ç»†èŠ‚ï¼š 1234567891011121314151617181920212223private void notifyListeners() { EventExecutor executor = executor(); // è·å–executor()æ‰§è¡Œçº¿ç¨‹ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥ if (executor.inEventLoop()) { // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºexecutor final InternalThreadLocalMap threadLocals = InternalThreadLocalMap.get(); final int stackDepth = threadLocals.futureListenerStackDepth(); if (stackDepth &lt; MAX_LISTENER_STACK_DEPTH) { threadLocals.setFutureListenerStackDepth(stackDepth + 1); try { notifyListenersNow(); // é€šçŸ¥æ‰§è¡ŒoperationComplete } finally { threadLocals.setFutureListenerStackDepth(stackDepth); } return; } } safeExecute(executor, new Runnable() { @Override public void run() { notifyListenersNow(); } });} é¦–å…ˆï¼Œè·å–åˆ°è¯¥ç±»ä¸­ä¿å­˜çš„executorï¼Œå³æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œè¯¥executorä¸€å®šæ˜¯eventLoopä¸­çš„çº¿ç¨‹ã€‚è·Ÿç€ä½¿ç”¨executor.inEventLoop()åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯excutorçº¿ç¨‹ï¼Œæ˜¯çš„çš„è¯ç›´æ¥æ‰§è¡Œé€šçŸ¥ç›‘å¬è€…ï¼Œä¸æ˜¯çš„è¯åˆ™ä½¿ç”¨excutorçº¿ç¨‹æ‰§è¡Œé€šçŸ¥ç›‘å¬è€…operationCompleteæ–¹æ³•ã€‚ ChannelFutureçš„ä½¿ç”¨åœ¨æœåŠ¡ç«¯æˆ‘ä»¬ä½¿ç”¨ChannelFutureï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class HServer { public static void main(String[] args) throws InterruptedException { EventLoopGroup bossGroup = new NioEventLoopGroup(1); EventLoopGroup workerGroup = new NioEventLoopGroup(); ServerBootstrap bootstrap = new ServerBootstrap(); HashSet&lt;Integer&gt; set = new HashSet&lt;&gt;(); set.remove(1); try { bootstrap.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ChannelPipeline pipeline = ch.pipeline(); pipeline.addLast(&quot;http&quot;, new HttpServerCodec()); pipeline.addLast(&quot;httpA&quot;, new HttpObjectAggregator(5*1024*1024)); pipeline.addLast(&quot;myHandler&quot;, new SimpleChannelInboundHandler&lt;HttpObject&gt;() { @Override protected void channelRead0(ChannelHandlerContext ctx, HttpObject msg) throws Exception { // è®¾ç½®å“åº”å†…å®¹ ByteBuf content = Unpooled.copiedBuffer(&quot;helloï¼Œæˆ‘æ˜¯æœåŠ¡å™¨&quot;, CharsetUtil.UTF_8); DefaultFullHttpResponse re = new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, content); re.headers().add(HttpHeaderNames.CONTENT_TYPE, &quot;text/plain;charset=utf-8&quot;) .add(HttpHeaderNames.CONTENT_LENGTH, content.readableBytes()); // å†™å‡ºå“åº” ChannelFuture channelFuture = ctx.write(re); // æ·»åŠ å†™å‡ºåçš„ç›‘å¬å™¨ï¼Œå†™å‡ºæˆåŠŸåï¼Œå³invokeåæ‰§è¡Œ channelFuture.addListener((future)-&gt;{ if(future.isSuccess()) { System.out.println(&quot;æˆåŠŸ&quot;); } else { System.out.println(&quot;å¤±è´¥&quot;); } }); } }); } }); ChannelFuture sync = bootstrap.bind(8888).sync(); sync.channel().closeFuture().sync(); } finally { bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully(); } }} å¦‚ä¸Šç¨‹åºå®ç°æœåŠ¡ç«¯å¯ä»¥æ¥å—Httpè¯·æ±‚ç„¶åå›å¤å®¢æˆ·ç«¯ï¼Œè°ƒç”¨ctx.write(re)æ–¹æ³•ä¸ä¼šé©¬ä¸Šé©¬ä¸ŠæŠŠæ¶ˆæ¯å†™å‡ºç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯æ”¾åœ¨ç¼“å†²ä¸­ï¼Œç­‰åˆ°ç¼“å†²åŒºæ»¡äº†æˆ–è€…è°ƒç”¨invoke()æ–¹æ³•åæ‰ä¼šå†™å‡ºã€‚åœ¨åé¢æ·»åŠ çš„ç›‘å¬å™¨éœ€è¦åœ¨invokeçœŸæ­£å†™å‡ºåæ‰ä¼šæ‰§è¡Œã€‚ æ³¨æ„ï¼š å¦‚æœæŠŠctx.write(re)å˜æˆctx.writeAndFlush(re)ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œctx.writeAndFlush(re)æ•°æ®å°±å·²ç»è¢«å†™å‡ºäº†ï¼Œé‚£ä¹ˆæ‰§è¡ŒaddListenerä¼šé©¬ä¸Šæ‰§è¡Œå›è°ƒã€‚","link":"/2020/09/08/Netty%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-ChannelFuture/"},{"title":"Nettyæ ¸å¿ƒç»„ä»¶-EventLoopGroup","text":"Nettyé«˜æ€§èƒ½æ¶æ„â€“çº¿ç¨‹æ¨¡å‹ï¼šNettyä¹‹æ‰€ä»¥æ€§èƒ½å¾ˆé«˜ï¼Œé™¤äº†ä¾èµ–äºNioçš„ç‰¹æ€§å¤–ï¼Œè¿˜å®ç°äº†ä¸€å¥—é«˜æ•ˆçš„çº¿ç¨‹æ¨¡å‹ã€‚ Nettyçº¿ç¨‹æ¨¡å‹ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹â€‹ å³é˜»å¡IOæ¨¡å‹ï¼Œä¸€ä¸ªç½‘ç»œè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ã€‚ æ¨¡å‹ç‰¹ç‚¹ï¼š é‡‡ç”¨é˜»å¡IOæ¨¡å¼è·å–è¾“å…¥çš„æ•°æ® æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å› æ¨¡å‹ç¼ºç‚¹ï¼š å½“å¹¶å‘è¿‡å¤šï¼Œåˆ›å»ºå¤§é‡çº¿ç¨‹ä¼šé€ æˆèµ„æºçš„å¤§é‡å ç”¨ è¿æ¥å»ºç«‹åï¼Œå¾ˆå¯èƒ½ä¸€ç›´é˜»å¡åœ¨ç­‰å¾…è¯»å’Œå†™çš„çŠ¶æ€ Reactor/Dispatcheræ¨¡å‹ç‰¹ç‚¹ï¼š åŸºäºIOå¤ç”¨æ¨¡å‹ â€‹ å¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚ åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æº â€‹ ä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå°†è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚ è¯´æ˜ï¼š Reactor æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„æ¨¡å¼(åŸºäºäº‹ä»¶é©±åŠ¨) æœåŠ¡å™¨ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šä¸ªè¯·æ±‚,å¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾åˆ°ç›¸åº”çš„å¤„ç†çº¿ç¨‹ï¼Œ å› æ­¤Reactoræ¨¡å¼ä¹Ÿå« Dispatcheræ¨¡å¼ Reactor æ¨¡å¼ä½¿ç”¨IOå¤ç”¨ç›‘å¬äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œåˆ†å‘ç»™æŸä¸ªçº¿ç¨‹(è¿›ç¨‹), è¿™ç‚¹å°±æ˜¯ç½‘ç»œæœåŠ¡å™¨é«˜å¹¶å‘å¤„ç†å…³é”® (1) å•Reactorå•çº¿ç¨‹ â€‹ åªæœ‰å•ä¸ªçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹é‡Œæœ‰ä¸€ä¸ªReactoræ¥è´Ÿè´£æ¥æ”¶è¿æ¥ï¼Œæ¥æ”¶åˆ°è¿æ¥åç»Ÿä¸€è¿˜æ˜¯ç”¨è¿™ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç† â€‹ ä¼˜ç‚¹ï¼šç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ï¼Œæ²¡æœ‰è¿›ç¨‹é€šä¿¡â€‹ ç¼ºç‚¹ï¼šæ€§èƒ½ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸çš„æè‡´ï¼Œä¸€ä¸ªhandlerå¡æ­»ï¼Œå¯¼è‡´å½“å‰è¿›ç¨‹æ— æ³•ä½¿ç”¨ï¼ŒIOå’ŒCPUä¸åŒ¹é…â€‹ åœºæ™¯ï¼šå®¢æˆ·ç«¯æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†å¿«ï¼Œæ¯”å¦‚redisï¼Œå› ä¸ºredisçš„åŠŸèƒ½éå¸¸ç®€å•ï¼Œå°±æ˜¯ä»å†…å­˜ä¸­è·å–ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ²¡æœ‰æ–‡ä»¶IOç­‰å¤æ‚æ“ä½œï¼Œå•æ¬¡è¯·æ±‚å¤„ç†æ—¶é—´å¾ˆçŸ­ï¼Œé¿å…äº†å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œæ€§èƒ½æ¯”å¤šçº¿ç¨‹æ›´é«˜ã€‚ â€‹ â€‹ åœ¨æˆ‘ä»¬ä¹‹å‰çš„1.2.3çš„ç¨‹åºä»£ç ä¸­ï¼ŒåŒæ ·æ˜¯åŸºäºè¯¥æ¨¡å‹çš„ï¼ŒSelectorè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿå°±ä¼šé€šè¿‡è¿™ä¸ªçº¿ç¨‹æ¥å¤„ç†å“åº”çš„è¯·æ±‚ã€‚å¦‚æœæ˜¯ServerSocketChannelå‘ç”Ÿäº‹ä»¶ï¼Œè°ƒç”¨accept()å»ºç«‹è¿æ¥ï¼Œå¦‚æœæ˜¯SocketChannelå°±è¿›è¡Œå“åº”çš„å¤„ç†ã€‚ (2) å•Reactorå¤šçº¿ç¨‹æ¨¡å‹ è¯´æ˜ï¼š Reactor å¯¹è±¡é€šè¿‡select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚ äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡dispatchè¿›è¡Œåˆ†å‘ å¦‚æœæ˜¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼Œåˆ™é€šè¿‡Acceptorçš„acceptæ–¹æ³•å»ºç«‹è¿æ¥ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡æ¥è´Ÿè´£å®Œæˆå¯¹åº”çš„å®¢æˆ·ç«¯çš„åç»­è¯·æ±‚å¤„ç† å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±reactoråˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„handler æ¥å¤„ç† handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†, é€šè¿‡read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„workerçº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡ worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™client ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸cpu çš„å¤„ç†èƒ½åŠ›ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œ reactor å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œ åœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆ. (3) ä¸»ä»Reactorå¤šçº¿ç¨‹ è¯´æ˜ï¼š ä¸€ä¸ª(æˆ–å¤šä¸ª)Reactorç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå¦‚æœæ˜¯å»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œåˆ™åœ¨æœ¬çº¿ç¨‹çš„Acceptorå®Œæˆacceptï¼Œå†å°†è¿æ¥åˆ†é…ç»™å­çº¿ç¨‹Reactor å¦‚æœæ˜¯å…¶ä»–è¯·æ±‚ï¼Œåˆ™è½¬åˆ°å­çº¿ç¨‹çš„Reactorä¸­è¿›è¡Œåˆ†å‘å¤„ç†ï¼Œå­çº¿ç¨‹Reactoråˆ†å‘åå†äº¤ç”±çº¿ç¨‹æ± å¤„ç†ä¸šåŠ¡ã€‚ Reactorå­çº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªï¼ŒåŒæ ·ä¸»çº¿ç¨‹Reactorä¹Ÿå¯ä»¥æœ‰å¤šä¸ª ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®ã€‚Nettyä¸»è¦ä½¿ç”¨çš„å°±æ˜¯è¯¥æ¨¡å‹ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜ Nettyçº¿ç¨‹æ¨¡å‹Nettyä½¿ç”¨çš„å°±æ˜¯ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ï¼Œåœ¨æœåŠ¡å™¨ç«¯ï¼Œå®šä¹‰äº†ä¸¤ä¸ªçº¿ç¨‹æ± BossGroupå’ŒWorker Groupï¼š BossGroupå¯¹åº”äº†Reactorä¸»çº¿ç¨‹(å¯ä»¥æœ‰å¤šä¸ªï¼Œä½†æ˜¯ä¸€èˆ¬éƒ½ä¸º1ä¸ª)ï¼Œæ¯ä¸€ä¸ªReactorä¸»çº¿ç¨‹éƒ½å¾ªç¯çš„è¿›è¡Œ1.selecté€‰æ‹©â€”ã€‹2.å¤„ç†è¿æ¥è¯·æ±‚ï¼Œå»ºç«‹è¿æ¥å¹¶å°†è¿æ¥æ³¨å†Œåˆ°WorkerGroupä¸­-ã€‹3.å¤„ç†ä¸€äº›ä»»åŠ¡ Worker Groupå¯¹åº”äº†Workerçº¿ç¨‹æ± ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ä¹Ÿéƒ½æ˜¯ä¸€ä¸ªSelectoræ¥ç›‘å¬æœ‰å“ªäº›æ³¨å†Œåˆ°è‡ªå·±ä¸Šçš„å®¢æˆ·ç«¯æœ‰è¯»æ—¶é—´å‘ç”Ÿï¼ŒåŒæ ·å¾ªç¯è¿›è¡Œ1.selecté€‰æ‹©-ã€‹2.å¤„ç†æ‰€æœ‰è¯»å†™äº‹ä»¶å¹¶æ‰§è¡Œå¯¹åº”ä¸šåŠ¡-ã€‹3.æ‰§è¡Œä¸€äº›å…¶ä»–ä»»åŠ¡ ä¸‹é¢ç¼–å†™ä¸€ä¸ªNettyé€šè®¯çš„ç¨‹åºæ¥é…åˆè§£é‡Šï¼š æœåŠ¡ç«¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960public class NettyServer { public static void main(String[] args) throws InterruptedException { // åˆ›å»ºå¾ªç¯äº‹ä»¶ç»„ï¼Œçº¿ç¨‹æ± ï¼ŒåŸç†å›¾ä¸­çš„BossGroupï¼Œç”¨äºç›‘å¬ç”¨æˆ·çš„è¯·æ±‚ // è‹¥ä¸æŒ‡å®šçº¿ç¨‹æ•°é‡ï¼Œä¼šé»˜è®¤è®¾ç½®ä¸ºå½“å‰æœºå™¨çš„é€»è¾‘å¤„ç†å™¨âœ–2 EventLoopGroup eventExecutors = new NioEventLoopGroup(1); // åˆ›å»ºå·¥ä½œçº¿ç¨‹ç»„ï¼ŒåŸç†å›¾ä¸­çš„WorkerGroup // è‹¥ä¸æŒ‡å®šçº¿ç¨‹æ•°é‡ï¼Œä¼šé»˜è®¤è®¾ç½®ä¸ºå½“å‰æœºå™¨çš„é€»è¾‘å¤„ç†å™¨âœ–2 EventLoopGroup workExecutors = new NioEventLoopGroup(); try{ // æœåŠ¡ç«¯é…ç½® ServerBootstrap bootstrap = new ServerBootstrap(); bootstrap.group(eventExecutors, workExecutors) // å°†ä¸¤ä¸ªGroupåŠ å…¥ .channel(NioServerSocketChannel.class) // æŒ‡å®šchannelçš„ç±»å‹ï¼Œæ³¨æ„è¿™ä¸æ˜¯java NIOä¸‹çš„ï¼Œæ˜¯Nettyæä¾›çš„ .option(ChannelOption.SO_BACKLOG, 128) // è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—çš„è¿æ¥ä¸ªæ•° .childOption(ChannelOption.SO_KEEPALIVE, true) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast(new ServerHandler()); // æ¯ä¸ªæ³¨å†Œè¿›æ¥çš„channeléƒ½æ·»åŠ ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¯ä»¥æ·»åŠ å¤šä¸ª } }); // è®¾ç½®å­å¤„ç†å™¨ï¼Œå½“æ¥å—åˆ°è¯»è¯·æ±‚æ˜¯ä¼šæ‰§è¡Œå¤„ç†å™¨ä¸­çš„æ–¹æ³•ã€‚å½“æ˜¯å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æ—¶ä¸ä¼šèµ°è¯¥å¤„ç†å™¨ï¼Œè€Œæ˜¯æ³¨å†Œåˆ°workExecutorsä¸­ // ç»‘å®šç«¯å£ ChannelFuture sync = bootstrap.bind(8888).sync(); // å°†æ¥åœ¨æ¥æ”¶åˆ°å…³é—­äº‹ä»¶æ˜¯å…³é—­é€šé“ï¼ŒcloseFutureæœ¬èº«æ˜¯å¼‚æ­¥è°ƒç”¨ï¼ŒåŠ ä¸ŠsyncåŒæ­¥ç­‰å¾…è¿”å›ç»“æœ sync.channel().closeFuture().sync(); } finally { // å…³é—­çº¿ç¨‹æ±  eventExecutors.shutdownGracefully(); workExecutors.shutdownGracefully(); } }}public class ServerHandler extends ChannelInboundHandlerAdapter { /** * å½“æœ‰è¯»å–äº‹ä»¶å‘ç”Ÿä¼šè§¦å‘è¯¥æ–¹æ³• * ChannelHandlerContextä¸ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå†…éƒ¨åŒ…å«äº†pipelineã€channelç­‰ */ @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { ByteBuf buf = (ByteBuf) msg; System.out.println(&quot;å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ä¸º:&quot; + buf.toString(CharsetUtil.UTF_8)); System.out.println(&quot;å®¢æˆ·ç«¯çš„åœ°å€ä¸º:&quot; + ctx.channel().remoteAddress()); } /** * å½“è¯»å–å®Œæ¯•åä¼šè§¦å‘è¯¥æ–¹æ³• */ @Override public void channelReadComplete(ChannelHandlerContext ctx) throws Exception { System.out.println(&quot;æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚&quot;); ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;å®¢æˆ·ç«¯ä½ å¥½,(*^â–½^*)&quot;, CharsetUtil.UTF_8)); }} å®¢æˆ·ç«¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class NettyClient { public static void main(String[] args) throws InterruptedException { // åˆ›å»ºä¸€ä¸ªæ—¶é—´å¾ªç¯ç»„ EventLoopGroup eventExecutors = new NioEventLoopGroup(); try { // å®¢æˆ·ç«¯åˆ›å»ºBootStrapå¯¹è±¡æ¥åˆå§‹åŒ– Bootstrap bootstrap = new Bootstrap(); // è®¾ç½®ç›¸å…³å‚æ•° bootstrap.group(eventExecutors) // è®¾ç½®æ—¶é—´å¾ªç¯ç»„ .channel(NioSocketChannel.class) // è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„ç§ç±» .handler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast(new ClientHandler()); // æ·»åŠ ä¸€ä¸ªå¤„ç†å™¨ } }); ChannelFuture sync = bootstrap.connect(&quot;0.0.0.0&quot;, 8888).sync(); sync.channel().closeFuture(); } finally { // å…³é—­çº¿ç¨‹æ±  eventExecutors.shutdownGracefully(); } }}public class ClientHandler extends ChannelInboundHandlerAdapter { /** * å½“é€šé“è§¦å‘å°±ä¼šè§¦å‘è¯¥æ–¹æ³• */ @Override public void channelActive(ChannelHandlerContext ctx) throws Exception { System.out.println(&quot;client: &quot; + ctx); ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;è¿™æ˜¯å®¢æˆ·ç«¯ï¼Œ(*^â–½^*)&quot;, CharsetUtil.UTF_8)); } /** * å½“æœ‰è¯»å–äº‹ä»¶å‘ç”Ÿä¼šè§¦å‘è¯¥æ–¹æ³• */ @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { //super.channelRead(ctx, msg); ByteBuf buf = (ByteBuf) msg; System.out.println(&quot;æœåŠ¡å™¨å›å¤:&quot; + buf.toString(CharsetUtil.UTF_8)); System.out.println(ctx.channel().remoteAddress()); }} Nettyçº¿ç¨‹æ¨¡å‹è¯´æ˜ï¼š å¯¹äºæœåŠ¡ç«¯ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼ŒbossGroupä¸workerGroupï¼š bossGroupå¯¹åº”ä¸»ä»Reactoræ¨¡å‹ä¸­çš„çš„mainReactorï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œæˆ‘ä»¬åº”è¯¥ä¼ å…¥å‚æ•°1ï¼Œè¡¨ç¤ºåªå»ºç«‹ä¸€ä¸ªçº¿ç¨‹ã€‚åœ¨Nettyä¸­ï¼Œæ‰§è¡ŒServerBootsrapçš„bindæ–¹æ³•ä¼šç»‘å®šç«¯å£å¾—åˆ°ä¸€ä¸ªSeverSocketChannelå¯¹è±¡ï¼Œä¹‹åä¼šæŠŠè¯¥å¯¹è±¡æ”¾ç½®åœ¨bossGroupä¸€ä¸ªEventLoopï¼ˆä¸€èˆ¬ä¸ºä¸€ä¸ªçº¿ç¨‹ï¼‰ä¸­ï¼Œæ³¨å†Œåˆ°è¯¥çº¿ç¨‹çš„Selectorä¸Šæ¥ç›‘å¬æœ‰æ²¡æœ‰è¿æ¥äº‹ä»¶ï¼Œå¦‚æœæœ‰è¿æ¥è¯·æ±‚ï¼Œå°±å¾—åˆ°SocketChannelæ³¨å†Œåˆ°workerGroupä¸Šï¼Œåç»­çš„ä¸šåŠ¡äº¤ç»™äº†workerGroupçš„çº¿ç¨‹ï¼Œæ€»ä½“æ¥è¯´æ¥æ”¶è¯·æ±‚çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œå•çº¿ç¨‹ä¹Ÿèƒ½æœ‰è¾ƒé«˜çš„ååé‡ï¼Œä¸éœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹å¼•å…¥çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œå¹¶ä¸”Selectoræ“ä½œä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚bossGroupå¯ä»¥åˆå§‹åŒ–å¤šä¸ªEventLoopï¼ˆä¸€èˆ¬ä¸ºä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯bindä¸€ä¸ªç«¯å£åªä¼šç”Ÿæˆä¸€ä¸ªEventLoopï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬åˆå§‹åŒ–ä¸º1ä¸ªçº¿ç¨‹ã€‚ç½‘ä¸Šå¯¹äºbossGroupå¯ä»¥ç»™å¤šä¸ªçº¿ç¨‹çš„ç†ç”±æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ç»‘å®šå¤šä¸ªç«¯å£ï¼Œå°±å¯ä»¥åˆå§‹åŒ–å¤šä¸ªçº¿ç¨‹æ¯”è¾ƒåˆç†ã€‚ workerGroup å¯¹åº” Reactor æ¨¡å‹çš„ subReactor ï¼Œç”¨äºè¿›è¡Œ SocketChannel çš„æ•°æ®è¯»å†™ã€‚å¯¹äº EventLoopGroup ï¼Œå¦‚æœæœªä¼ é€’æ–¹æ³•å‚æ•° nThreads ï¼Œè¡¨ç¤ºä½¿ç”¨ CPUçº¿ç¨‹æ•°*2 ä¸ª Reactor ã€‚è¿™ä¸ªä¹Ÿç¬¦åˆæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œé€šå¸¸ï¼ŒsubReactor çš„ä¸ªæ•°ä¸ºCPUé€»è¾‘å¤„ç†å™¨ä¸ªæ•°*2ï¼Œæ¯ä¸ª subReactor ç‹¬å ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ åœ¨ä¸Šå›¾è™šçº¿æ¡†ä¸­ï¼Œæœ‰ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„ä¸šåŠ¡çº¿ç¨‹æ± ï¼Œè™½ç„¶Nettyæä¾›äº†workerGroupçº¿ç¨‹æ± æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œä½†æ˜¯æ›´å¤šçš„æƒ…å†µä¸‹çº¿ç¨‹æ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ç”¨äºå¤šä¸ªChannelç½‘ç»œI/Oçš„ï¼Œè€Œæ¯ä¸ªchannelå¯¹åº”äºä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå¦‚æœåœ¨channelä¸­æœ‰è¯»å–æ•°æ®åº“ç­‰I/Oæ“ä½œï¼Œä¼šé€ æˆchannelçš„é˜»å¡ï¼Œå¦‚æœæŸä¸€ä¸ªå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€äº†å¤šä¸ªè¯·æ±‚ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚æ²¡æ‰§è¡Œå®Œå°±ä¸€ç›´é˜»å¡ä¸ä¼šæ¥æ”¶åˆ°ç¬¬äºŒä¸ªè¯·æ±‚ï¼Œå› æ­¤åœ¨æœ‰é•¿æ—¶é—´I/Oæ“ä½œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æŠŠè¿™äº›ä¸šåŠ¡äº¤ç»™ä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹æ± æ›´å¥½ï¼Œæ‰§è¡Œå®Œä¸šåŠ¡åï¼Œè°ƒç”¨channelçš„writeæ–¹æ³•Nettyä¼šå°†ä¸šåŠ¡çº¿ç¨‹åˆ‡æ¢åˆ°workerGroupçº¿ç¨‹è¿›è¡Œç½‘ç»œI/Oã€‚ EventLoopGroupEventLoopç›¸å…³ç±»å›¾ï¼š EventLoopä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œé€šå¸¸ä¸ä¸€ä¸ªSelectorç»‘å®šï¼Œä½†æ˜¯åœ¨Nettyä¸­éƒ½æ˜¯å°†EventLoopä½œä¸ºå•ä¸ªçº¿ç¨‹ï¼Œå³NioEventLoopï¼ŒNioEventLoopè´Ÿè´£äº†è¯¥çº¿ç¨‹çš„å„ä¸ªæ³¨å†Œåœ¨Selectorä¸Šchannelçš„è¯·æ±‚å¤„ç†ï¼ŒEventLoopè¿˜æœ‰å…¶ä»–çš„å®ç°ç±»ï¼Œä½†æ˜¯åŸºæœ¬ä¸Šéƒ½æ˜¯SingleThreadEventLoopæŠ½è±¡ç±»çš„å­ç±»ï¼Œå…¶ä½™çš„å‡ ä¹ä¸æ€ä¹ˆä½¿ç”¨ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªåˆ†æNioEventLoopã€‚ EventLoopGroupå¯ä»¥ç®¡ç†äº†å¤šä¸ªEventLoopã€‚ EventLoopGroupç”¨äºç®¡ç†å¤šä¸ªEventLoopï¼Œè¯¥æ¥å£æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š 12345678910111213141516171819202122232425public interface EventLoopGroup extends EventExecutorGroup { /** * Return the next {@link EventLoop} to use */ @Override EventLoop next(); /** * Register a {@link Channel} with this {@link EventLoop}. The returned {@link ChannelFuture} * will get notified once the registration was complete. */ ChannelFuture register(Channel channel); /** * Register a {@link Channel} with this {@link EventLoop} using a {@link ChannelFuture}. The passed * {@link ChannelFuture} will get notified once the registration was complete and also will get returned. */ ChannelFuture register(ChannelPromise promise); /** * Register a {@link Channel} with this {@link EventLoop}. The passed {@link ChannelFuture} * will get notified once the registration was complete and also will get returned. * * @deprecated Use {@link #register(ChannelPromise)} instead. */ @Deprecated ChannelFuture register(Channel channel, ChannelPromise promise);} ä¸»è¦å°±æ˜¯nextæ–¹æ³•ä¸registeræ–¹æ³•ï¼š next()ï¼šè·å–ä¸€ä¸ªEventLoopï¼Œå¦‚æœæœ‰å¤šä¸ªEventLoopï¼Œå¯ä»¥å®šä¹‰è·å–çš„ç­–ç•¥ã€‚ register(Channel)ï¼šå°†Channelæ³¨å†Œåœ¨EventLoopGroupä¸­ï¼Œå³ç»‘å®šåœ¨ä¸€ä¸ªSelectorä¸Šã€‚ EventLoopGroupçš„åˆå§‹åŒ–ä»æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºNioEventLoopGroupæ—¶æœ‰ï¼šNioEventLoopGroup workerGroup = new NioEventLoopGroup(8)ï¼Œæˆ‘ä»¬ä¼ å…¥çš„8ä¸ºçº¿ç¨‹æ•°é‡ã€‚æˆ‘ä»¬å‘ä¸Šæ‰¾æ„é€ å‡½æ•°ï¼ŒAbstractEventExecutorGroupæ²¡æœ‰å®šä¹‰æ„é€ ï¼ŒMultithreadEventExecutorGroupå®šä¹‰äº†æ„é€ ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172// class MultithreadEventExecutorGroup/** * Create a new instance. * * @param nThreads the number of threads that will be used by this instance.çº¿ç¨‹ç»„çš„çº¿ç¨‹æ•° * @param executor the Executor to use, or {@code null} if the default should be used.å¯ä»¥è‡ªå·±ä¼ å…¥ä¸€ä¸ªçº¿ç¨‹æ±  * @param chooserFactory the {@link EventExecutorChooserFactory} to use. * @param args arguments which will passed to each {@link #newChild(Executor, Object...)} call */protected MultithreadEventExecutorGroup(int nThreads, Executor executor, EventExecutorChooserFactory chooserFactory, Object... args) { if (nThreads &lt;= 0) { throw new IllegalArgumentException(String.format(&quot;nThreads: %d (expected: &gt; 0)&quot;, nThreads)); } // å¦‚æœæ²¡æœ‰ä¼ å…¥çº¿ç¨‹æ± ï¼Œå°±é»˜è®¤åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ±  if (executor == null) { executor = new ThreadPerTaskExecutor(newDefaultThreadFactory()); } // ä¸çº¿ç¨‹æ•°é‡ç›¸åŒçš„EventLoop children = new EventExecutor[nThreads]; for (int i = 0; i &lt; nThreads; i ++) { boolean success = false; try { // åˆ›å»ºEventLoopå¯¹è±¡çš„æ•°ç»„ï¼ŒNioEventLoop children[i] = newChild(executor, args); success = true; } catch (Exception e) { // TODO: Think about if this is a good exception type throw new IllegalStateException(&quot;failed to create a child event loop&quot;, e); } finally { if (!success) { for (int j = 0; j &lt; i; j ++) { children[j].shutdownGracefully(); } for (int j = 0; j &lt; i; j ++) { EventExecutor e = children[j]; try { while (!e.isTerminated()) { e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS); } } catch (InterruptedException interrupted) { // Let the caller handle the interruption. Thread.currentThread().interrupt(); break; } } } } } // EventLoopçš„é€‰æ‹©å™¨ chooser = chooserFactory.newChooser(children); // ç›‘å¬EventLoopå…³é—­äº‹ä»¶ final FutureListener&lt;Object&gt; terminationListener = new FutureListener&lt;Object&gt;() { @Override public void operationComplete(Future&lt;Object&gt; future) throws Exception { if (terminatedChildren.incrementAndGet() == children.length) { terminationFuture.setSuccess(null); } } }; for (EventExecutor e: children) { e.terminationFuture().addListener(terminationListener); } Set&lt;EventExecutor&gt; childrenSet = new LinkedHashSet&lt;EventExecutor&gt;(children.length); Collections.addAll(childrenSet, children); readonlyChildren = Collections.unmodifiableSet(childrenSet);} ç”±ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºEventLoopGroupåœ¨åˆå§‹åŒ–æ—¶ï¼š 1 - ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± é‚£å°±åˆ›å»ºä¸€ä¸ªæŒ‡å®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ±  2 - åˆ›å»ºä¸æŒ‡å®šçº¿ç¨‹æ•°ç›¸åŒæ•°é‡çš„EventExecutorï¼ˆå³EventLoopï¼‰ 3 - åˆ›å»ºä¸€ä¸ªEventLoopçš„é€‰æ‹©å™¨ï¼Œåœ¨éœ€è¦æä¾›EventLoopæ—¶é€‰æ‹©EventLoopGroupä¸­çš„ä¸€ä¸ªEventLoop 4 - æ·»åŠ æ¯ä¸ªEventLoopå…³é—­äº‹ä»¶çš„ç›‘å¬å™¨ EventLoopGroupçš„åˆå§‹åŒ–å°±è¿™äº›ï¼Œåœ¨è¿™é‡Œé¢ä¸»è¦æœ‰EventLoopçš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬æ”¾åˆ°åé¢å†è®²ã€‚ EventLoopGroupæ¥å£çš„æ–¹æ³•æˆ‘ä»¬å†æ¥çœ‹çœ‹EventLoopGroupæ¥å£å®šä¹‰çš„ä¸¤ç±»æ–¹æ³•ï¼š 1234567891011// è¯¥æ–¹æ³•åœ¨MultithreadEventExecutorGroupä¸­å®šä¹‰@Overridepublic EventExecutor next() { return chooser.next();} // è¯¥æ–¹æ³•åœ¨MultithreadEventLoopGroupä¸­å®šä¹‰@Overridepublic ChannelFuture register(Channel channel) { return next().register(channel);} å¯ä»¥çœ‹åˆ°registerçš„é€»è¾‘ä¸ºé€šè¿‡chooseré€‰æ‹©å™¨ä»EventLoopGroupä¸­é€‰å‡ºä¸€ä¸ªEventLoopæ¥è¿›è¡Œæ³¨å†Œã€‚ä¸‹é¢ä¸ºä¸€ä¸ªé€‰æ‹©å™¨çš„ç±» 12345678910111213private static final class GenericEventExecutorChooser implements EventExecutorChooser { private final AtomicInteger idx = new AtomicInteger(); private final EventExecutor[] executors; GenericEventExecutorChooser(EventExecutor[] executors) { this.executors = executors; } @Override public EventExecutor next() { return executors[Math.abs(idx.getAndIncrement() % executors.length)]; // ç›´æ¥ç”¨é€’å¢çš„idå»å¯¹EventLoopçš„æ•°é‡å–ä½™å¾—åˆ°ä¸‹æ ‡ }} ä¸Šè¿°çš„é€‰æ‹©å™¨å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªè½®è¯¢çš„å¤æ‚å‡è¡¡ç­–ç•¥ã€‚ åç»­å°†ç»§ç»­ä»‹ç»EventLoopã€‚","link":"/2020/09/09/Netty%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-EventLoopGroup/"},{"title":"Nettyæ ¸å¿ƒç»„ä»¶-EventLoopä¸BootStrap","text":"ä¸Šä¸€æ¬¡æˆ‘ä»¬è®²åˆ°äº†EventLoopGroupï¼ŒEventLoopçš„åˆå§‹åŒ–è·³è¿‡äº†ï¼Œç°åœ¨æ¥æ·±å…¥ç ”ç©¶EventLoopç»„ä»¶ï¼ŒEventLoopæ˜¯Nettyéå¸¸é‡è¦çš„ç»„ä»¶ï¼Œå®ƒæ˜¯ç½‘ç»œè¯·æ±‚å¤„ç†çš„æ ¸å¿ƒï¼Œé€šè¿‡Selectorä¸æ–­å¾ªç¯ç›‘å¬Channelçš„äº‹ä»¶ï¼Œå¤„ç†ç›¸åº”çš„è¯·æ±‚ã€‚ EventLoop EventLoopåˆå§‹åŒ–ä¹‹å‰æˆ‘ä»¬è®²åˆ°äº†MultithreadEventExecutorGroupç±»ä¸­EventLoopGroupçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å‡ºç°äº†ä¸‹é¢ä¸¤å¥è¯ï¼š 1234// ä¸çº¿ç¨‹æ•°é‡ç›¸åŒçš„EventLoopchildren = new EventExecutor[nThreads];// åˆ›å»ºEventLoopå¯¹è±¡çš„æ•°ç»„ï¼ŒNioEventLoopchildren[i] = newChild(executor, args); è¿™å°±æ˜¯EventLoopGroupä¸­åˆå§‹åŒ–å…¶ä¸­çš„EventLoopï¼Œå…¶ä¸­newChildä¸ºä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¢«å­ç±»NioEventLoopGroupå®ç°ï¼š 1234567// class NioEventLoopGroup@Overrideprotected EventLoop newChild(Executor executor, Object... args) throws Exception { EventLoopTaskQueueFactory queueFactory = args.length == 4 ? (EventLoopTaskQueueFactory) args[3] : null; return new NioEventLoop(this, executor, (SelectorProvider) args[0], ((SelectStrategyFactory) args[1]).newSelectStrategy(), (RejectedExecutionHandler) args[2], queueFactory);} æˆ‘ä»¬åœ¨ç»“åˆEventLoopçš„æ„é€ å‡½æ•°çœ‹ä¸€ä¸‹ï¼š 1234567891011121314151617NioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider, SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler, EventLoopTaskQueueFactory queueFactory) { super(parent, executor, false, newTaskQueue(queueFactory), newTaskQueue(queueFactory), rejectedExecutionHandler); if (selectorProvider == null) { throw new NullPointerException(&quot;selectorProvider&quot;); } if (strategy == null) { throw new NullPointerException(&quot;selectStrategy&quot;); } provider = selectorProvider; final SelectorTuple selectorTuple = openSelector(); // ä½¿ç”¨SelectorProviderå¯¹è±¡ç”Ÿæˆä¸€ä¸ªSelectorå¯¹è±¡ selector = selectorTuple.selector; unwrappedSelector = selectorTuple.unwrappedSelector; selectStrategy = strategy;} å¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºï¼š NioEventLoopä¸­ä¿å­˜äº†è‡ªå·±å±äºå“ªä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œå³NioEventLoopGroup. NioEventLoopä¸­ä¿å­˜äº†ä¸€ä¸ªçº¿ç¨‹æ± executorï¼Œè¿™ä¸ªçº¿ç¨‹æ± æ˜¯NioEventLoopGroupåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªçº¿ç¨‹æ± è¢«å…¶ä¸­çš„æ‰€æœ‰NioEventLoopå…±äº«. NioEventLoopä¸­ä¿å­˜äº†ä¸€ä¸ªSelectorProviderï¼Œç”¨äºäº§ç”ŸSelectoré€‰æ‹©å™¨å¯¹è±¡ï¼ŒåŒæ ·ä¹Ÿä¿å­˜äº†é€‰æ‹©å™¨å¯¹è±¡selector NioEventLoopä¸­ä¿å­˜äº†ä¸€ä¸ªSelectStrategyï¼Œç”¨äºå®šä¹‰é€‰æ‹©ç­–ç•¥çš„ï¼Œå³åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚æˆ‘ä»¬ä¸»è¦ç”¨çš„NioEventLoopä½¿ç”¨çš„æ˜¯Nioæä¾›çš„Selectorçš„selectNowæ–¹æ³•ï¼ŒNettyä¸­è¿˜æä¾›äº†EpollEventLoopä½¿ç”¨çš„æ˜¯è‡ªå·±å®ç°çš„nativeæ–¹æ³•æ¥è¿›è¡Œselectï¼Œä¸åŒçš„selectæ–¹å¼æ•ˆç‡ä¸åŒï¼Œä¸è¿‡Nioçš„selectçš„æ•ˆç‡ä¹Ÿå¾ˆé«˜ã€‚ NioEventLoopçˆ¶ç±»çš„é‡è¦æ–¹æ³•æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹NioEventLoopçš„çˆ¶ç±»ä¸­æœ‰å“ªäº›æ¯”è¾ƒé‡è¦çš„æ–¹æ³•ã€‚ (1) inEventLoop è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»SingleThreadEventExecutorä¸­å®ç°ï¼Œè¯¥æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºå¯¹åº”EventLoopçš„çº¿ç¨‹ã€‚åœ¨Nettyä¸­ï¼Œchannelçš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨å…¶å¯¹åº”çš„EventLoopçš„çº¿ç¨‹ä¸­å®Œæˆçš„ï¼Œchannelæ¯æ¬¡è¿›è¡Œè¯»å†™æ“ä½œï¼Œéƒ½å…ˆä¼šæ£€æŸ¥æ˜¯å¦åœ¨å¯¹åº”EventLoopçº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°†ä¼šæäº¤ç»™å¯¹åº”çš„EventLoopçº¿ç¨‹æ¥æ‰§è¡Œï¼Œè¯¥æ–¹æ³•å°±æ˜¯ç”¨äºåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨channelå¯¹åº”çš„EventLoopçš„çº¿ç¨‹ä¸­ã€‚ 1234@Overridepublic boolean inEventLoop(Thread thread) { return thread == this.thread;} (2) addTask/removeTask/hasTaskâ€¦ è¯¥æ–¹æ³•æ˜¯ç»™EventLoopä¸­æ·»åŠ ä»»åŠ¡ï¼Œåœ¨çˆ¶ç±»SingleThreadEventExecutorä¸­å®ç°ã€‚å°±åƒä¹‹å‰çš„Nettyæ¶æ„å›¾ä¸­ï¼ŒEventLoopä¸­å…·æœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—TaskQueueï¼Œåœ¨EventLoopçº¿ç¨‹å¾ªç¯ä¸­ï¼Œé™¤äº†æ‰§è¡Œselectç„¶åå¤„ç†è¯»å†™äº‹ä»¶ä¹‹å¤–ï¼Œè¿˜ä¼šæ‰§è¡ŒTaskQueueä¸­çš„ä»»åŠ¡ï¼Œè¿™äº›æ–¹æ³•å°±æ˜¯ç»™TaskQueueä¸­æ·»åŠ ä»»åŠ¡ç­‰å¯¹ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œæ“ä½œã€‚ 12345678910protected void addTask(Runnable task) { if (task == null) { throw new NullPointerException(&quot;task&quot;); } // æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ— if (!offerTask(task)) { // æ·»åŠ å¤±è´¥ï¼Œåˆ™æ‹’ç»ä»»åŠ¡ reject(task); }} (3) register register(Channel channel)æ–¹æ³•æ˜¯å°†Channelæ³¨å†Œåˆ°è¯¥EventLoopä¸Šï¼Œä¹Ÿå°±æ˜¯æŠŠChannelæ³¨å†Œåˆ°å¯¹åº”çš„Selectorä¸Š 1234@Overridepublic ChannelFuture register(Channel channel) { return register(new DefaultChannelPromise(channel, this));} NioEventLoopçš„è¿è¡ŒåŸç†run()æ–¹æ³•NioEventLoopä¸ºäº‹ä»¶å¾ªç¯ï¼Œå…¶ä¸­çš„runæ–¹æ³•ä¸€æ—¦è¿è¡Œèµ·æ¥å°±ä¸€ç›´å¾ªç¯ï¼Œæ¥çœ‹çœ‹runæ–¹æ³•çš„æºä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364@Overrideprotected void run() { for (;;) { // æ­»å¾ªç¯ï¼Œä¸€ç›´ç›‘å¬Selectorä¸Šçš„channelæ˜¯å¦æœ‰è¯»å†™äº‹ä»¶ try { try { switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) { case SelectStrategy.CONTINUE: // ä¸ä¼šå‡ºç°è¯¥æƒ…å†µ continue; case SelectStrategy.BUSY_WAIT: // fall-through to SELECT since the busy-wait is not supported with NIO case SelectStrategy.SELECT: select(wakenUp.getAndSet(false)); // &lt;1&gt; é˜»å¡/å¾ªç¯åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæœ‰äº‹ä»¶å‘ç”Ÿåˆ™è¿”å› // æ˜¯å¦éœ€è¦å”¤é†’Selector if (wakenUp.get()) { selector.wakeup(); } // fall through default: } } catch (IOException e) { // If we receive an IOException here its because the Selector is messed up. Let's rebuild // the selector and retry. https://github.com/netty/netty/issues/8566 rebuildSelector0(); // é‡å»ºä¸€ä¸ªSelectorï¼Œå°†åŸæ¥Selectorä¸Šçš„Channeléƒ½æ³¨å†Œåˆ°æ–°çš„Selectorä¸Šï¼Œå…³é—­åŸæ¥çš„Channel handleLoopException(e); continue; } cancelledKeys = 0; needsToSelectAgain = false; final int ioRatio = this.ioRatio; if (ioRatio == 100) { try { processSelectedKeys(); // &lt;2&gt; å¤„ç†æ‰€æœ‰çš„è¢«é€‰æ‹©çš„Keyï¼Œå³æœ‰äº‹ä»¶å‘ç”Ÿçš„channel } finally { // Ensure we always run tasks. runAllTasks(); // &lt;3&gt; æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ } } else { // åŒæ—¶å¤„ç†æ‰€æœ‰æœ‰äº‹ä»¶å‘ç”Ÿçš„channelï¼Œç„¶åæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½†æ˜¯æ‰§è¡Œä»»åŠ¡æœ‰æ—¶é—´é™åˆ¶ï¼Œä¸èƒ½æ‰§è¡Œå¤ªä¹… final long ioStartTime = System.nanoTime(); try { processSelectedKeys(); } finally { // Ensure we always run tasks. final long ioTime = System.nanoTime() - ioStartTime; runAllTasks(ioTime * (100 - ioRatio) / ioRatio); } } } catch (Throwable t) { handleLoopException(t); } // Always handle shutdown even if the loop processing threw an exception. try { if (isShuttingDown()) { closeAll(); if (confirmShutdown()) { return; } } } catch (Throwable t) { handleLoopException(t); } }} ä»ä¸Šè¿°çš„æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œäº‹ä»¶å¾ªç¯çš„æµç¨‹ï¼š &lt;1&gt;é€šè¿‡selectæ–¹æ³•åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚åœ¨è¯¥æ–¹æ³•ä¸­è¿˜å¤„ç†äº†JDKçš„NIOå­˜åœ¨ç©ºè½®è¯¢çš„bugï¼Œåç»­å†ä»‹ç»ã€‚ &lt;2&gt;å½“å·²ç»ç›‘å¬åˆ°æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¤„ç†æ‰€æœ‰çš„SelectedKeysï¼Œå®Œæˆå¯¹åº”channelçš„è¯»å†™äº‹ä»¶ &lt;3&gt;æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ˆå¯èƒ½æ˜¯æ‰€æœ‰ä»»åŠ¡ï¼Œä¹Ÿå¯èƒ½æ˜¯éƒ¨åˆ†ï¼‰ select(boolean)æ–¹æ³•é¦–å…ˆï¼ŒJDKæä¾›çš„NIOå…·æœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„bugï¼Œæˆ‘ä»¬çŸ¥é“Selectorç›‘å¬äº‹ä»¶å‘ç”Ÿæœ‰int select()ã€int selectNow()ã€int select(long timeout)ä¸‰ç§æ–¹æ³•ï¼š select()ï¼šé˜»å¡ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ selectNow()ï¼šåˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡ï¼Œä¼šé©¬ä¸Šè¿”å›ç»“æœï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿå°±è¿”å›0 select(long timeout)ï¼šå¸¦è¶…æ—¶çš„é˜»å¡ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šé˜»å¡ï¼Œè¶…è¿‡æŒ‡å®šäº‹ä»¶åä¼šè‡ªåŠ¨å”¤é†’ï¼Œè¿”å›0ã€‚ åœ¨Linuxå¹³å°ä¸‹ï¼Œselect()ä¼šå‡ºç°æ²¡æœ‰äº‹ä»¶å‘ç”Ÿä½†æ˜¯è¿˜æ˜¯ä¼šç›´æ¥è¿”å›0ï¼Œè€Œä¸æ˜¯è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç„¶åå»processKeysä½†æ˜¯æ²¡æœ‰keyï¼Œä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ²¡æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œè¿™æ ·çš„æƒ…å†µä¸‹ä¼šä¸€ç›´å‘ç”Ÿç©ºè½®è¯¢ï¼Œå¯¼è‡´CPUå ç”¨100%ï¼Œå¯¹æ€§èƒ½é€ æˆä¸¥é‡çš„æŸè€—ï¼ŒNettyé’ˆå¯¹è¯¥bugè¿›è¡Œäº†å¤„ç†ï¼Œå°±åœ¨NioEventLoopä¸‹çš„select(boolean)æ–¹æ³•ä¸­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100private void select(boolean oldWakenUp) throws IOException { Selector selector = this.selector; try { int selectCnt = 0; // è½®è¯¢è®¡æ•°å™¨ // è®¡ç®—è½®è¯¢è¶…æ—¶çš„æ—¶é—´ long currentTimeNanos = System.nanoTime(); long selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos); long normalizedDeadlineNanos = selectDeadLineNanos - initialNanoTime(); if (nextWakeupTime != normalizedDeadlineNanos) { nextWakeupTime = normalizedDeadlineNanos; } // å¾ªç¯åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå°½ç®¡Selectorçš„select()æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯åœ¨Linuxä¸‹ä¼šæœ‰bugå¯èƒ½ä¸é˜»å¡ï¼Œæ‰€ä»¥ç”¨å¾ªç¯ for (;;) { long timeoutMillis = (selectDeadLineNanos - currentTimeNanos + 500000L) / 1000000L; // å¦‚æœç©ºè½®è¯¢è¶…æ—¶ï¼Œåˆ™é€€å‡ºå¾ªç¯ if (timeoutMillis &lt;= 0) { if (selectCnt == 0) { selector.selectNow(); selectCnt = 1; } break; } // If a task was submitted when wakenUp value was true, the task didn't get a chance to call // Selector#wakeup. So we need to check task queue again before executing select operation. // If we don't, the task might be pended until select operation was timed out. // It might be pended until idle timeout if IdleStateHandler existed in pipeline. // å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå°±æŠŠSelectorçš„å”¤é†’æ ‡å¿—ç½®ä½trueå¹¶é€€å‡ºå¾ªç¯å»æ‰§è¡Œä»»åŠ¡ if (hasTasks() &amp;&amp; wakenUp.compareAndSet(false, true)) { selector.selectNow(); selectCnt = 1; break; } // å¸¦è¶…æ—¶çš„select(long timeout)æ–¹æ³•ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿ int selectedKeys = selector.select(timeoutMillis); selectCnt ++; // å¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿäº†selectedKeys!=0ï¼Œ // æˆ–è€…è°ƒç”¨select(boolean)æ–¹æ³•å‰å”¤é†’æ ‡å¿—ä¸ºtrueï¼Œ // æˆ–è€…ç›®å‰çš„å”¤é†’æ ‡å¿—ä½ä¸ºtrueï¼Œ // æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œ // æˆ–è€…æœ‰å‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ã€‚ // ä»¥ä¸Šè¿™äº›æƒ…å†µéƒ½é€€å‡ºæ­¤æ¬¡ç›‘å¬ if (selectedKeys != 0 || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) { // - Selected something, // - waken up by user, or // - the task queue has a pending task. // - a scheduled task is ready for processing break; } // å¦‚æœçº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯ if (Thread.interrupted()) { // Thread was interrupted so reset selected keys and break so we not run into a busy loop. // As this is most likely a bug in the handler of the user or it's client library we will // also log it. // // See https://github.com/netty/netty/issues/2426 if (logger.isDebugEnabled()) { logger.debug(&quot;Selector.select() returned prematurely because &quot; + &quot;Thread.currentThread().interrupt() was called. Use &quot; + &quot;NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop.&quot;); } selectCnt = 1; break; } // åˆ¤æ–­æ˜¯å¦è¶…æ—¶ long time = System.nanoTime(); if (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) { // timeoutMillis elapsed without anything selected. selectCnt = 1; } else if (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; 0 &amp;&amp; selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) { // åœ¨æŒ‡å®šæ—¶é—´å†…(å› ä¸ºè¶…æ—¶ä¼šé€€å‡ºå¾ªç¯é‡æ–°è®¡æ—¶)è¶…è¿‡ç©ºè½®è¯¢çš„æ¬¡æ•°ï¼Œè¯¥Selectorå‡ºç°äº†bugï¼Œé‡å»ºSelector // The code exists in an extra method to ensure the method is not too big to inline as this // branch is not very likely to get hit very frequently. selector = selectRebuildSelector(selectCnt); selectCnt = 1; break; } currentTimeNanos = time; } if (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) { if (logger.isDebugEnabled()) { logger.debug(&quot;Selector.select() returned prematurely {} times in a row for Selector {}.&quot;, selectCnt - 1, selector); } } } catch (CancelledKeyException e) { if (logger.isDebugEnabled()) { logger.debug(CancelledKeyException.class.getSimpleName() + &quot; raised by a Selector {} - JDK bug?&quot;, selector, e); } // Harmless exception - log anyway }} ç¬¬ 4 è¡Œï¼šè·å¾— select æ“ä½œçš„è®¡æ•°å™¨ã€‚ä¸»è¦ç”¨äºè®°å½• Selector ç©ºè½®è¯¢æ¬¡æ•°ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ­£åœ¨è½®è¯¢å®Œæˆ( ä¾‹å¦‚ï¼šè½®è¯¢è¶…æ—¶ )ï¼Œåˆ™é‡ç½® selectCnt ä¸º 1 ã€‚ ç¬¬ 8 è¡Œï¼šè®¡ç®— select æ“ä½œçš„æˆªæ­¢æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚ #delayNanos(currentTimeNanos) æ–¹æ³•è¿”å›çš„ä¸ºä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è·ç¦»ç°åœ¨çš„æ—¶é—´ï¼Œå¦‚æœä¸å­˜åœ¨å®šæ—¶ä»»åŠ¡ï¼Œåˆ™é»˜è®¤è¿”å› 1000 ms ã€‚ æ­»å¾ªç¯è°ƒç”¨Selectorçš„select(long timeout)æ–¹æ³•ï¼Œç›´åˆ°æ»¡è¶³ä¸‹é¢çš„æƒ…å†µæ‰é€€å‡ºå¾ªç¯ï¼š å¾ªç¯æ—¶é—´è¶…æ—¶ï¼Œ18è¡Œ ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œæˆ–è€…æœ‰å‘¨æœŸä»»åŠ¡æ‰§è¡Œï¼Œ31è¡Œä¸46è¡Œ æœ‰channelå‘ç”Ÿäº†å¯¹åº”çš„è¯»å†™äº‹ä»¶ï¼Œ46è¡Œ è¢«å”¤é†’ï¼Œwakeupä¸ºtrueï¼Œæˆ–è°ƒç”¨select(boolean)ä¹‹å‰ä¼ å…¥çš„å°±æ˜¯trueï¼Œ46è¡Œ çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¸€èˆ¬ä¸å…è®¸æ‰“æ–­ï¼Œæ‰“æ–­äº†æ˜¯å‡ºç°bugæˆ–è€…é”™è¯¯ä½¿ç”¨ï¼Œ54è¡Œ åœ¨æŒ‡å®šæ—¶é—´å†…å‘ç”Ÿäº†å¾ˆå¤šæ¬¡ç©ºè½®è¯¢ï¼Œè¯¥Selectorå‡ºç°äº†bugï¼Œé‡å»ºSelectoråé€€å‡ºå¾ªç¯ï¼Œ74è¡Œ~81è¡Œ processSelectedKeyæ–¹æ³•void processSelectedKey(SelectionKey k, AbstractNioChannel ch) è¯¥æ–¹æ³•æ˜¯å¤„ç†æ¯ä¸€ä¸ªæœ‰äº‹ä»¶å‘ç”Ÿçš„channelï¼Œåœ¨run()æ–¹æ³•ä¸­è°ƒç”¨processSelectedKeysæ–¹æ³•ä¼šå¯¹æ‰€æœ‰å‘ç”Ÿäº‹ä»¶çš„keyè°ƒç”¨åˆ°è¯¥æ–¹æ³•æ¥ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) { final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe(); if (!k.isValid()) { final EventLoop eventLoop; try { eventLoop = ch.eventLoop(); } catch (Throwable ignored) { // If the channel implementation throws an exception because there is no event loop, we ignore this // because we are only trying to determine if ch is registered to this event loop and thus has authority // to close ch. return; } // è¿™ä¸ªchannelçš„EventLoopä¸æ˜¯å½“å‰çš„EventLoopæˆ–è¯¥channelæ²¡æœ‰å¯¹åº”çš„EventLoop if (eventLoop != this || eventLoop == null) { return; } // å…³é—­è¯¥é€šé“ï¼Œå› ä¸ºå¯¹åº”çš„kä¹Ÿä¸å­˜åœ¨äº† unsafe.close(unsafe.voidPromise()); return; } try { int readyOps = k.readyOps(); // è·å–è¯¥keyå‘ç”Ÿäº†ä»€ä¹ˆæ ·çš„äº‹ä»¶ // We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise // the NIO JDK channel implementation may throw a NotYetConnectedException. if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) { // æ–­å¼€è¿æ¥æ“ä½œ // remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking // See https://github.com/netty/netty/issues/924 int ops = k.interestOps(); ops &amp;= ~SelectionKey.OP_CONNECT; k.interestOps(ops); unsafe.finishConnect(); } // Process OP_WRITE first as we may be able to write some queued buffers and so free memory. if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) { // å†™å‡ºæ“ä½œ // Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write ch.unsafe().forceFlush(); } // Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead // to a spin loop if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) { // è¯»å–æ“ä½œ unsafe.read(); } } catch (CancelledKeyException ignored) { unsafe.close(unsafe.voidPromise()); }} åœ¨è¿™é‡Œï¼Œä¸»è¦æ˜¯èµ°è¯»å–æ“ä½œï¼Œå³48è¡Œï¼Œå¯¹äºæœåŠ¡ç«¯è€Œè¨€ï¼Œæ— è®ºæ˜¯è¯·æ±‚è¿æ¥è¿˜æ˜¯è¯»å–æ•°æ®éƒ½æ˜¯èµ°è¿™é‡Œã€‚ BootStrapNettyä¸­çš„BootStrapç±»ä¸»è¦æ˜¯ç”¨äºè¿›è¡Œä¸€äº›åˆå§‹åŒ–è®¾ç½®ï¼Œä¸»è¦æœ‰SeverBootStrapå’ŒBootStrapä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«ç”¨äºæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„åˆå§‹åŒ–è®¾ç½®ï¼Œä»¥æœåŠ¡ç«¯çš„ServerBootStrapä¸ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536public class NServer { public static void main(String[] args) throws InterruptedException { // åˆ›å»ºå¾ªç¯äº‹ä»¶ç»„ï¼Œçº¿ç¨‹æ± ï¼ŒåŸç†å›¾ä¸­çš„BossGroupï¼Œç”¨äºç›‘å¬ç”¨æˆ·çš„è¯·æ±‚ // è‹¥ä¸æŒ‡å®šçº¿ç¨‹æ•°é‡ï¼Œä¼šé»˜è®¤è®¾ç½®ä¸ºå½“å‰æœºå™¨çš„é€»è¾‘å¤„ç†å™¨âœ–2 EventLoopGroup eventExecutors = new NioEventLoopGroup(1); // åˆ›å»ºå·¥ä½œçº¿ç¨‹ç»„ï¼ŒåŸç†å›¾ä¸­çš„WorkerGroup // è‹¥ä¸æŒ‡å®šçº¿ç¨‹æ•°é‡ï¼Œä¼šé»˜è®¤è®¾ç½®ä¸ºå½“å‰æœºå™¨çš„é€»è¾‘å¤„ç†å™¨âœ–2 EventLoopGroup workExecutors = new NioEventLoopGroup(); try{ // æœåŠ¡ç«¯é…ç½® ServerBootstrap bootstrap = new ServerBootstrap(); bootstrap.group(eventExecutors, workExecutors) // å°†ä¸¤ä¸ªGroupåŠ å…¥ .channel(NioServerSocketChannel.class) // æŒ‡å®šchannelçš„ç±»å‹ï¼Œæ³¨æ„è¿™ä¸æ˜¯java NIOä¸‹çš„ï¼Œæ˜¯Nettyæä¾›çš„ .option(ChannelOption.SO_BACKLOG, 128) // è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—çš„è¿æ¥ä¸ªæ•° .childOption(ChannelOption.SO_KEEPALIVE, true) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast(new ServerHandler()); // æ¯ä¸ªæ³¨å†Œè¿›æ¥çš„channeléƒ½æ·»åŠ ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¯ä»¥æ·»åŠ å¤šä¸ª } }); // è®¾ç½®å­å¤„ç†å™¨ï¼Œå½“æ¥å—åˆ°è¯»è¯·æ±‚æ˜¯ä¼šæ‰§è¡Œå¤„ç†å™¨ä¸­çš„æ–¹æ³•ã€‚å½“æ˜¯å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æ—¶ä¸ä¼šèµ°è¯¥å¤„ç†å™¨ï¼Œè€Œæ˜¯æ³¨å†Œåˆ°workExecutorsä¸­ // ç»‘å®šç«¯å£ ChannelFuture sync = bootstrap.bind(8888).sync(); // å°†æ¥åœ¨æ¥æ”¶åˆ°å…³é—­äº‹ä»¶æ˜¯å…³é—­é€šé“ï¼ŒcloseFutureæœ¬èº«æ˜¯å¼‚æ­¥è°ƒç”¨ï¼ŒåŠ ä¸ŠsyncåŒæ­¥ç­‰å¾…è¿”å›ç»“æœ sync.channel().closeFuture().sync(); } finally { // å…³é—­çº¿ç¨‹æ±  eventExecutors.shutdownGracefully(); workExecutors.shutdownGracefully(); } }} æˆ‘ä»¬å¯ä»¥çœ‹åˆ°NettyæœåŠ¡ç«¯çš„å¯åŠ¨éƒ½æ˜¯ç”±ServerBootStrapè¿›è¡Œé…ç½®çš„ï¼Œåœ¨æ‰§è¡Œbootstrap.bind(8888).sync();æœåŠ¡ç«¯æ­£å¼å¯åŠ¨èµ·æ¥ã€‚ ä¸»è¦é…ç½®æ–¹æ³•(1) group()æ–¹æ³• è¯¥æ–¹æ³•ç”¨äºæŒ‡å®šäº‹ä»¶å¾ªç¯ç»„ï¼Œä¼ å…¥äº†æˆ‘ä»¬åˆå§‹åŒ–å¥½çš„bossGroupä¸workerGroupä¸¤ä¸ªNioEventLoopGroupã€‚ (2) channel()æ–¹æ³• ç”¨äºæŒ‡å®šæœåŠ¡ç«¯æ¥æ”¶è¿æ¥è¯·æ±‚çš„channelç±»å‹ï¼Œå¯¹åº”äºNIOä¸­çš„ServerSocketChannelï¼Œæ˜¯NettyåŒ…è£…è¿‡çš„ï¼Œä¸€ä¸‹ä¸ºNIOå¯¹åº”çš„ä¸€äº›channelçš„ç±»å‹ã€‚ å…¶ä¸­æˆ‘ä»¬å¸¸ç”¨çš„å°±æ˜¯NioServerSocketChannelç”¨äºtcpåè®®(å¯¹åº”äºNIOçš„ServerSocketChannel)ï¼Œè€ŒNioDatagramChannelå¯¹åº”äºUDPåè®®(å¯¹åº”äºNIOçš„DatagramChannel)ã€‚ (3) option()/childOption()æ–¹æ³• ç”¨äºé…ç½®TCPè¿æ¥çš„å‚æ•°ï¼Œoption()é…ç½®SeverSocketChannelçš„TCPå‚æ•°ï¼ŒchildOption()é…ç½®SocketChannelçš„TCPå‚æ•°ï¼Œå…·ä½“çš„é…ç½®å‚æ•°åœ¨Nettyä¸­çš„ChannelOptioné…ç½®ä¸­æœ‰éƒ¨åˆ†è¯´æ˜ã€‚ (4) handler()/childHandler()æ–¹æ³• ç”¨äºé…ç½®channelçš„å¤„ç†å™¨ï¼Œhanlder()ç”¨äºé…ç½®ServerSocketChannelçš„Handlerï¼ŒchildHandler()ç”¨äºé…ç½®socketChannelçš„Handlerã€‚ bind()å¯åŠ¨æœåŠ¡å™¨åœ¨ç»è¿‡é…ç½®åï¼Œè°ƒç”¨bind()å°†å¯åŠ¨æœåŠ¡å™¨ï¼Œå¼€å¯ä¸¤ä¸ªEventLoopGroupä¸­çš„eventLoopï¼Œè°ƒç”¨bind()æ–¹æ³•ä¼šè°ƒç”¨åˆ°å¦‚ä¸‹æ–¹æ³•AbstractBootstrapçš„doBindæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738// class AbstractBootstrapprivate ChannelFuture doBind(final SocketAddress localAddress) { // &lt;1&gt;åˆ›å»ºå¹¶åˆå§‹åŒ–ServerSocketChannel final ChannelFuture regFuture = initAndRegister(); final Channel channel = regFuture.channel(); if (regFuture.cause() != null) { return regFuture; } if (regFuture.isDone()) { // At this point we know that the registration was complete and successful. ChannelPromise promise = channel.newPromise(); // &lt;2&gt;ç»‘å®šå¥½äº†åï¼Œå¤„ç†ç»‘å®šå®Œæˆçš„å‡ºç«™äº‹ä»¶ doBind0(regFuture, channel, localAddress, promise); return promise; } else { // Registration future is almost always fulfilled already, but just in case it's not. final PendingRegistrationPromise promise = new PendingRegistrationPromise(channel); regFuture.addListener(new ChannelFutureListener() { @Override public void operationComplete(ChannelFuture future) throws Exception { Throwable cause = future.cause(); if (cause != null) { // Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an // IllegalStateException once we try to access the EventLoop of the Channel. promise.setFailure(cause); } else { // Registration was successful, so set the correct executor to use. // See https://github.com/netty/netty/issues/2586 promise.registered(); doBind0(regFuture, channel, localAddress, promise); } } }); return promise; }} ä¸»è¦æ‰§è¡Œäº†ä¸¤ä¸ªæ­¥éª¤ï¼š &lt;1&gt;åˆ›å»ºå¹¶åˆå§‹åŒ–ServerSocketChannelï¼šåŒ…æ‹¬å¯¹è±¡çš„åˆ›å»ºã€å…ˆå‰é…ç½®å‚æ•°çš„åˆå§‹åŒ–ã€Handleré“¾çš„åˆå§‹åŒ–ä»¥åŠå°†channelæ³¨å†Œåˆ°bossGroupç­‰ã€‚ &lt;2&gt;ç»‘å®šå¥½äº†åï¼Œå¤„ç†ç»‘å®šå®Œæˆçš„å‡ºç«™äº‹ä»¶ åˆå§‹åŒ–ä¸»è¦ä¸&lt;1&gt;ç›¸å…³ï¼Œè¿›å…¥initAndRegister()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839final ChannelFuture initAndRegister() { Channel channel = null; try { // &lt;1&gt;é€šè¿‡å·¥å‚åˆ›å»ºä¸€ä¸ªServerSocketChannel channel = channelFactory.newChannel(); // &lt;2&gt;åˆå§‹åŒ–channel init(channel); } catch (Throwable t) { if (channel != null) { // channel can be null if newChannel crashed (eg SocketException(&quot;too many open files&quot;)) channel.unsafe().closeForcibly(); // as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t); } // as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor return new DefaultChannelPromise(new FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t); } // &lt;3&gt;å°†channelæ³¨å†Œåˆ°boosGroupä¸Š ChannelFuture regFuture = config().group().register(channel); if (regFuture.cause() != null) { if (channel.isRegistered()) { channel.close(); } else { channel.unsafe().closeForcibly(); } } // If we are here and the promise is not failed, it's one of the following cases: // 1) If we attempted registration from the event loop, the registration has been completed at this point. // i.e. It's safe to attempt bind() or connect() now because the channel has been registered. // 2) If we attempted registration from the other thread, the registration request has been successfully // added to the event loop's task queue for later execution. // i.e. It's safe to attempt bind() or connect() now: // because bind() or connect() will be executed *after* the scheduled registration task is executed // because register(), bind(), and connect() are all bound to the same thread. return regFuture;} &lt;1&gt; é€šè¿‡å·¥å‚åˆ›å»ºä¸€ä¸ªServerSocketChannelï¼ŒchannelFactoryä¼šæ ¹æ®ä¹‹å‰é…ç½®çš„channelç±»å‹ä¸ºNioServerSocketChannelç”Ÿæˆè¯¥ç±»çš„channelå¯¹è±¡ &lt;2&gt; åˆå§‹åŒ–channelï¼Œè®¾ç½®é…ç½®å‚æ•°ï¼Œå¹¶å°†HandleråŠ å…¥channelçš„pipelineä¸­ï¼Œå…¶ä¸­å›ºå®šä¼šåŠ å…¥ä¸€ä¸ªç”¨äºå¤„ç†è¿æ¥è¯·æ±‚çš„å¤„ç†å™¨ï¼Œç”¨äºå°†æ¥æ”¶åˆ°SocketChannelæ³¨å†Œåˆ°workerGroupä¸Šçš„eventLoopä¸Šï¼š 12345678910111213141516171819202122232425262728293031323334void init(Channel channel) { setChannelOptions(channel, options0().entrySet().toArray(newOptionArray(0)), logger); setAttributes(channel, attrs0().entrySet().toArray(newAttrArray(0))); ChannelPipeline p = channel.pipeline(); final EventLoopGroup currentChildGroup = childGroup; final ChannelHandler currentChildHandler = childHandler; // é…ç½®å‚æ•° final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions = childOptions.entrySet().toArray(newOptionArray(0)); final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(0)); p.addLast(new ChannelInitializer&lt;Channel&gt;() { @Override public void initChannel(final Channel ch) { final ChannelPipeline pipeline = ch.pipeline(); ChannelHandler handler = config.handler(); // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„Handler if (handler != null) { pipeline.addLast(handler); } // æ·»åŠ ServerBootstrapAcceptorçš„å¤„ç†å™¨ï¼Œè¯¥å¤„ç†å™¨ç”¨äºå°†æ¥æ”¶åˆ°çš„è¿æ¥è¯·æ±‚å°è£…ä¸ºSocketChannelæ³¨å†Œåˆ°workerGroupä¸Š ch.eventLoop().execute(new Runnable() { @Override public void run() { pipeline.addLast(new ServerBootstrapAcceptor( ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs)); } }); } });} &lt;3&gt; å°†channelæ³¨å†Œåˆ°bossGroupï¼Œæ˜¯é€šè¿‡Channelæ¥å£ä¸­çš„unsafeæ¥å£çš„æ–¹æ³•çš„void register(EventLoop eventLoop, ChannelPromise promise)","link":"/2020/09/10/Netty%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-EventLoop%E4%B8%8EBootStrap/"},{"title":"ç¼“å­˜ä¸åˆ†å¸ƒå¼é”","text":"åœ¨é¡¹ç›®ä¸­ï¼Œä¸ºåŠ å¿«æŸä¸ªæ¥å£çš„è®¿é—®é€Ÿåº¦ï¼Œå¢å¤§ååé‡ï¼Œå¦‚æœæˆ‘ä»¬æ£€æŸ¥å‡ºè¯¥æ¥å£è®¿é—®é€Ÿåº¦æ…¢æ˜¯å› ä¸ºæ•°æ®åº“æ“ä½œæ¯”è¾ƒè€—æ—¶çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé‡è¦çš„æ–¹å¼å°±æ˜¯å°†æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œç¼“å­˜æ˜¯åŸºäºå†…å­˜çš„ï¼Œæ“ä½œçš„é€Ÿåº¦è¿œå¿«äºMysqlç­‰å…³ç³»å‹æ•°æ®åº“ã€‚ å“ªäº›æ•°æ®é€‚åˆæ”¾å…¥ç¼“å­˜ä¸­ï¼š å¯¹åŠæ—¶æ€§ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„æ•°æ® è®¿é—®é‡å¤§ä½†æ˜¯æ›´æ–°é¢‘ç‡ä¸é«˜çš„æ•°æ® ä¾‹å¦‚åœ¨ç”µå•†ç³»ç»Ÿä¸­ï¼Œå•†å“çš„åˆ†ç±»ä¿¡æ¯ã€å•†å“åˆ—è¡¨ç­‰è·å–éƒ½æ˜¯éå¸¸è€—æ—¶çš„ï¼Œä½†æ˜¯è¿™äº›æ•°æ®éƒ½æ˜¯ä¸å¸¸æ›´æ–°çš„æ•°æ®ï¼Œé€‚åˆåŠ å…¥ç¼“å­˜ã€‚ ä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªæŸ¥è¯¢å•†å“åˆ†ç±»çš„æ¥å£ï¼š controllerå±‚ï¼š 12345@RequestMapping(&quot;/list/tree&quot;)public R list() throws InterruptedException { List&lt;CategoryEntity&gt; entities = categoryService.listWithTree(); // æŸ¥è¯¢ä¸‰çº§åˆ†ç±» return R.ok().put(&quot;data&quot;, entities);} serviceå±‚ï¼š 1234567891011121314151617181920212223242526@Overridepublic List&lt;CategoryEntity&gt; listWithTree() { List&lt;CategoryEntity&gt; list = baseMapper.selectList(null); // baseMapperä¸ºçˆ¶ç±»æ³¨å…¥çš„ï¼Œä¸€æ¬¡æ€§æŸ¥å‡ºæ‰€æœ‰çš„åˆ†ç±»æ•°æ® List&lt;CategoryEntity&gt; roots = list.stream().filter(m -&gt; m.getParentCid().equals(0L)).collect(Collectors.toList()); // æŸ¥è¯¢æ‰€æœ‰çš„ä¸€çº§åˆ†ç±» roots.stream().forEach( (m)-&gt;m.setChildren(list.stream().filter(s-&gt;s.getParentCid().equals(m.getCatId())) .sorted((m1, m2)-&gt; (m1.getSort()==null? 0:m1.getSort()) - (m2.getSort()==null? 0:m2.getSort())) .map((s)-&gt; { setChildren(list, s); return s; }) .collect(Collectors.toList()))); // é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†æ„å»ºåˆ†ç±»æ ‘ return roots;}private void setChildren(List&lt;CategoryEntity&gt; nodes, CategoryEntity node) { node.setChildren(nodes.stream().filter(m-&gt;m.getParentCid().equals(node.getCatId())) .sorted((m1, m2)-&gt; (m1.getSort()==null? 0:m1.getSort()) - (m2.getSort()==null? 0:m2.getSort())) .map((s)-&gt; { setChildren(nodes, s); return s; }) .collect(Collectors.toList()));} Serviceå±‚æ„å»ºåˆ†ç±»æ ‘æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œè€Œä¸”å¯¹äºå•†å“çš„åˆ†ç±»ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¿®æ”¹æ¯”è¾ƒå°‘çš„ï¼Œè¿™äº›æ•°æ®é€‚åˆæ”¾å…¥ç¼“å­˜ä¸­æ¥åŠ å¿«è®¿é—®é€Ÿåº¦ã€‚ ä½¿ç”¨ç¼“å­˜è¯»å–æ•°æ® åœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆå»ç¼“å­˜ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢çš„æ•°æ®å­˜åœ¨ï¼Œå°±å¯ä»¥ç›´æ¥æŸ¥å¤„æ•°æ®äº†ï¼Œå¦‚æœä¸å­˜åœ¨(ç¬¬ä¸€æ¬¡æŸ¥è¯¢æˆ–ç¼“å­˜è¿‡æœŸ)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å»æ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥æ•°æ®ç„¶åå°†ç»“æœæ”¾å…¥ç¼“å­˜ä¸­ï¼Œè¿™æ ·ç¬¬äºŒæ¬¡æ¥æŸ¥è¯¥æ•°æ®æ—¶ç¼“å­˜ä¸­å°±ä¼šå­˜åœ¨è¯¥æ•°æ®äº†ã€‚ æœ¬åœ°ç¼“å­˜åœ¨å•æœºåº”ç”¨ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æœ¬åœ°ç¼“å­˜çš„æ–¹å¼æ¥åœ¨å†…å­˜ä¸­å­˜å‚¨æ•°æ®ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰HashMapæ¥å®ç°ç¼“å­˜çš„åŠŸèƒ½ï¼Œä¹Ÿèƒ½å¤Ÿé€šè¿‡Mybatiså¼€å¯äºŒçº§ç¼“å­˜åŠŸèƒ½æ¥å¯¹æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œä½†ä¸æ¨èä½¿ç”¨Mybatisçš„äºŒçº§ç¼“å­˜ï¼ŒMybatisçš„ç¼“å­˜æœ‰æ•ˆèŒƒå›´æ˜¯åŸºäºnamespaceçš„ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰namespaceï¼Œå½“åœ¨ä¸€ä¸ªnamespaceä¸‹æ‰§è¡ŒæŸ¥è¯¢æ“ä½œå°±ç›´æ¥ä»namespaceçš„ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœåœ¨ä¸€ä¸ªnamespaceä¸‹æ‰§è¡Œäº†å¢åˆ æ”¹çš„æ“ä½œå°±ä¼šæ¸…é™¤ç¼“å­˜ï¼Œå› æ­¤å¼€é”€æ¯”è¾ƒå¤§ï¼Œè€Œä¸”å¦‚æœä¸€ä¸ªæ“ä½œæ¶‰åŠäº†å¤šä¸ªnamespaceå°±ä¸å®‰å…¨ï¼Œä¸å¦‚ç›´æ¥ä½¿ç”¨HashMapæ¥çš„é«˜æ•ˆçµæ´»ï¼Œåªæ˜¯è¦æ³¨æ„ç¼“å­˜çš„æ›´æ–°ã€‚ ä½†æ˜¯åœ¨é›†ç¾¤æˆ–åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œæœ¬åœ°ç¼“å­˜å°±ä¸å†é€‚ç”¨ï¼Œå› ä¸ºæœ¬åœ°ç¼“å­˜æ˜¯æ¯å°æœºå™¨æ‰€ç‹¬è‡ªæ‹¥æœ‰çš„ã€‚å¦‚æœä¸¤å°æœºå™¨(è¿›ç¨‹)éƒ½æœ‰å¯¹åº”çš„æœ¬åœ°ç¼“å­˜ï¼Œä½†æ˜¯ä¸€å°æœºå™¨æŠŠæ•°æ®åº“çš„æ•°æ®ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆåªä¼šæ›´æ–°æœ¬å°æœºå™¨çš„æœ¬åœ°ç¼“å­˜ï¼Œå¦å¤–ä¸€å°æœºå™¨è¿˜åœ¨ä½¿ç”¨æ—§çš„ç¼“å­˜ï¼Œè¿™æ ·æ•°æ®ä¸€è‡´æ€§å¤ªå·®ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæœ‰ä¸‰å°å•†å“æœåŠ¡çš„é›†ç¾¤ï¼Œæ¯ä¸ªå•†å“æœåŠ¡éƒ½ç¼“å­˜äº†å½“å‰å•†å“åˆ†ç±»çš„æ•°æ®ã€‚ç°åœ¨å¯¹å•†å“çš„åˆ†ç±»è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¿®æ”¹è¯·æ±‚è¢«è´Ÿè½½å‡è¡¡åˆ°äº†å•†å“æœåŠ¡çš„1å·æœºå™¨ï¼Œç”±1å·æœºå™¨å‘æ•°æ®åº“å‘å‡ºä¿®æ”¹çš„è¯·æ±‚ï¼Œç„¶åå†æŠŠä¿®æ”¹åçš„ç»“æœæ”¾å…¥1å·æœºå™¨çš„ç¼“å­˜ä¸­ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿®æ”¹2å·ä¸3å·æœºå™¨çš„ç¼“å­˜ã€‚ å½“æ–°çš„æŸ¥è¯¢è¯·æ±‚è¿‡æ¥ï¼Œè¢«è´Ÿè½½å‡è¡¡åˆ°2å·å’Œ3å·æœºå™¨ï¼Œé‚£ä¹ˆä¼šç›´æ¥æŸ¥è¯¢åˆ°ç¼“å­˜ä¸­çš„æ—§æ•°æ®ç„¶åè¿”å›ã€‚ä»¥ååªæœ‰è´Ÿè½½å‡è¡¡åˆ°1å·æœºå™¨ä¸Šæˆ–è€…ç­‰åˆ°ç¼“å­˜è¿‡æœŸæ‰èƒ½æŸ¥å‡ºæœ€æ–°æ•°æ®ï¼Œåœ¨ç¼“å­˜è¿‡æœŸå‰è¢«è´Ÿè½½å‡è¡¡åˆ°åˆ°2å·å’Œ3å·æœºå™¨ä¸Šçš„è¯·æ±‚éƒ½åªèƒ½æŸ¥åˆ°æ—§çš„æ•°æ®ã€‚ åˆ†å¸ƒå¼ç¼“å­˜ä¸ºäº†è§£å†³æœ¬åœ°ç¼“å­˜å­˜åœ¨çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥é›†ä¸­ç®¡ç†ç¼“å­˜ï¼Œå°†æ‰€æœ‰çš„ç¼“å­˜éƒ½æ”¾å…¥åˆ°ç¼“å­˜ä¸­é—´ä»¶ä¸­ï¼Œæ¯ä¸ªä¸šåŠ¡æœåŠ¡å™¨æŸ¥è¯¢ç¼“å­˜éƒ½åˆ°ç¼“å­˜ä¸­é—´ä»¶çš„æœåŠ¡å™¨ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒæŸä¸ªä¸šåŠ¡æœåŠ¡å™¨ä¿®æ”¹äº†ç¼“å­˜ï¼Œå…¶ä»–çš„æ‰€æœ‰ä¸šåŠ¡æœåŠ¡å™¨éƒ½èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚ å¯ä»¥ä½œä¸ºç¼“å­˜ä¸­é—´ä»¶çš„å¼€æºäº§å“æœ‰å¾ˆå¤šï¼Œç›®å‰æœ€ä¸ºå¸¸ç”¨çš„å°±æ˜¯Redisï¼Œä¸‹é¢æˆ‘ä»¬é‡‡ç”¨redisä½œä¸ºç¼“å­˜ä¸­é—´ä»¶æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜ã€‚ ä½¿ç”¨Redisæ”¹é€ æŸ¥è¯¢åˆ†ç±»æ ‘åœ¨controllerå±‚ä¸­ï¼š 123456789101112131415161718192021@RequestMapping(&quot;/list/tree&quot;)public R list() throws InterruptedException { ValueOperations&lt;String, String&gt; opsForValue = redisTemplate.opsForValue(); // æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ•°æ® String category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { // ç¼“å­˜ä¸­ä¸å­˜åœ¨ List&lt;CategoryEntity&gt; entities = categoryService.listWithTree(); System.out.println(&quot;æŸ¥è¯¢äº†æ•°æ®åº“&quot;); category = JSON.toJSONString(entities); opsForValue.set(&quot;category-tree&quot;, category, Duration.ofHours(2)); // å°†æ•°æ®æ”¾å…¥ç¼“å­˜ä¸­ï¼Œè¿‡æœŸæ—¶é—´ä¸º2å¤© return R.ok().put(&quot;data&quot;, entities); } // æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›æŸ¥è¯¢åˆ°çš„ç¼“å­˜å€¼ List&lt;CategoryEntity&gt; entities = JSON.parseObject(category, List.class); System.out.println(&quot;ç¼“å­˜å‘½ä¸­&quot;); return R.ok().put(&quot;data&quot;, entities);} é‡‡ç”¨springæä¾›çš„RedisTemplateå¯¹redisç¼“å­˜è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å®Œæˆäº†é‡‡ç”¨redisä½œä¸ºç¼“å­˜ä¸­é—´ä»¶æ¥è§£å†³æœ¬åœ°ç¼“å­˜å­˜åœ¨çš„é—®é¢˜ï¼Œä½†æ˜¯åˆ†å¸ƒå¼ç¼“å­˜ä¸ä»…ä»…è¿™ä¹ˆç®€å•ï¼Œä¸Šé¢çš„ä»£ç è™½ç„¶è§£å†³äº†æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œç³»ç»Ÿååé‡ä¹ŸæŒºé«˜ï¼Œä½†å…¶ä¸­éšè—äº†ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€ä¸ç¼“å­˜é›ªå´©ç­‰é—®é¢˜ã€‚ ç¼“å­˜ç©¿é€ã€å‡»ç©¿ä¸é›ªå´©ç¼“å­˜ç©¿é€ ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¦‚æœç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨æŸä¸ªæ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ä»æ•°æ®åº“ä¸­æŸ¥å‡ºäº†nullå€¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å°†nullæ”¾å…¥ç¼“å­˜ä¸­ï¼Œè¿™å°†å¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ä¼šå»æŸ¥è¯¢æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„é‚£ä¸ªæ•°æ®ï¼Œå¦‚æœå¹¶å‘é‡å¤ªå¤§ï¼Œå°†ä¼šå‹å®æ•°æ®åº“ï¼Œé€ æˆç¼“å­˜ç©¿é€ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†nullå­˜å…¥ç¼“å­˜ä¸­ã€‚ ç¼“å­˜å‡»ç©¿ ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡æŸä¸ªç¼“å­˜æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„è®¿é—®å¹¶å‘é‡éå¸¸å¤§ï¼Œè¿™æ—¶å€™ä¼šå¹¶å‘æŸ¥è¯¢æ•°æ®åº“ï¼Œè¿™æ ·ä¸€æ¥ä¼šå‹å®æ•°æ®åº“ï¼Œé€ æˆç¼“å­˜å‡»ç©¿ã€‚è§£å†³ç¼“å­˜å‡»ç©¿çš„æ–¹æ¡ˆå°±æ˜¯é‡‡ç”¨åˆ†å¸ƒå¼é”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ï¼Œåªæ”¾è¡Œä¸€ä¸ªè¯·æ±‚å»æŸ¥è¯¢æ•°æ®åº“ï¼ŒæŸ¥è¯¢åæ”¾å…¥ç¼“å­˜ï¼Œå…¶ä»–çš„çº¿ç¨‹å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æŸ¥è¯¢äº†ï¼Œç±»ä¼¼äºå•ä¾‹æ¨¡å¼ã€‚ ç¼“å­˜é›ªå´© ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­é—´ä»¶ä¸­ç¼“å­˜äº†éå¸¸å¤šçš„æ•°æ®ï¼Œç”±äºæ¯ä¸ªç¼“å­˜æ•°æ®éƒ½è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™äº›æ•°æ®éƒ½åŒæ—¶è¿‡æœŸï¼Œè¿™æ—¶éœ€è¦é«˜å¹¶å‘çš„å»æŸ¥è¯¢æ•°æ®åº“ï¼ŒåŒæ ·ä¹Ÿä¼šå‹å®æ•°æ®åº“ã€‚è§£å†³ç¼“å­˜é›ªå´©çš„ä¸€ä¸ªæ–¹æ³•å°±æ˜¯å°†æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºåœ¨åŸæ¥çš„åŸºç¡€ä¸ŠåŠ ä¸Šéšæœºæ•°ï¼Œè¿™æ ·å¯ä»¥é™ä½åŒæ—¶è¿‡æœŸçš„æ¦‚ç‡ï¼Œä½†æ˜¯ä¸èƒ½å®Œå…¨è§£å†³ç¼“å­˜é›ªå´©çš„é—®é¢˜ã€‚ ç¼“å­˜ç©¿é€çš„é—®é¢˜å¾ˆå¥½è§£å†³ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹åˆ†å¸ƒå¼é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ã€‚ åˆ†å¸ƒå¼é”Javaä¸­çš„Synchronizedæˆ–ReentrantLockç­‰JUCå¹¶å‘åŒ…éƒ½æ˜¯æœ¬åœ°é”ï¼Œå…¶ä½œç”¨èŒƒå›´æ˜¯å•ä¸ªJavaè¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒJDKæä¾›çš„é”åªèƒ½é”ä½å½“å‰çš„Javaè¿›ç¨‹ï¼Œé˜²æ­¢å•ä¸ªè¿›ç¨‹ä¸­å¯¹å…±äº«èµ„æºè¿›è¡ŒåŒæ—¶æ“ä½œè€Œäº§ç”Ÿçš„å®‰å…¨é—®é¢˜ã€‚è¿™ç§æ–¹å¼å¯¹äºè§£å†³ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ä¹Ÿæ˜¯è¶³å¤Ÿçš„ï¼Œå› ä¸ºè¿™äº›æœ¬åœ°é”ä¿è¯äº†ä¸€ä¸ªè¿›ç¨‹åªå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªæŸ¥è¯¢å¯¹åº”è¡¨çš„è¯·æ±‚ï¼Œè¯·æ±‚æ•°é‡è¾ƒå°‘ï¼Œä¸ä¼šå‹å®æ•°æ®åº“ã€‚ ä½†æ˜¯æ›´å¥½çš„æ–¹å¼æ˜¯é‡‡ç”¨åˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼é”å¯ä»¥ä¿è¯æ‰€æœ‰çº¿ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ“ä½œç¼“å­˜å’Œæ•°æ®åº“(è¿™é‡Œåªæ˜¯æŒ‡æŸä¸€ä¸ªè¯·æ±‚ï¼Œä¸å½±å“å…¶ä»–è¯·æ±‚)ã€‚åˆ†å¸ƒå¼é”ç›®å‰ä¸»æµå¯ä»¥ä½¿ç”¨Redisæˆ–zookeeperå®ç°ï¼Œä¸¤è€…å®ç°åˆ†å¸ƒå¼é”çš„åŸç†æœ‰æ‰€åŒºåˆ«ï¼ŒRedisçš„æ€§èƒ½æ›´é«˜ï¼Œè€Œzookeeperçš„å¯é æ€§æ›´é«˜ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨redisæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚ rediså®ç°åˆ†å¸ƒå¼é”rediså®ç°åˆ†å¸ƒå¼é”çš„åŸç†å¹¶ä¸å¤æ‚ï¼Œåªéœ€è¦åˆ©ç”¨ä¸€ä¸ªsetnxçš„å‘½ä»¤å³å¯ï¼Œåœ¨redisä¸­setnxå‘½ä»¤ä½œç”¨æ˜¯å‘redisä¸­å­˜å…¥ä¸€ä¸ªkey-valueï¼Œå¦‚æœè¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¾ç½®æˆåŠŸè¿”å›trueï¼Œå¦‚æœè¿™ä¸ªkeyå­˜åœ¨äº†ï¼Œé‚£ä¹ˆå°±ä¸èƒ½è®¾ç½®å¤±è´¥è¿”å›falseã€‚ å› æ­¤åˆ©ç”¨rediså®ç°åˆ†å¸ƒå¼é”çš„æ€è·¯æ˜¯ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå„ä¸ªçº¿ç¨‹åˆ©ç”¨setnxå‘½ä»¤å‘redisä¸­å­˜å…¥åŒä¸€ä¸ªkey(valueä¸å¤ªé‡è¦)ï¼Œå¦‚æœèƒ½å¤Ÿè®¾ç½®æˆåŠŸï¼Œè¯´æ˜è·å–åˆ°äº†åˆ†å¸ƒå¼é”ï¼Œä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸåï¼Œå…¶ä»–çº¿ç¨‹å¿…å®šä¼šè®¾ç½®å¤±è´¥è¿”å›false(å› ä¸ºredisæ“ä½œå†…å­˜æ•°æ®æ˜¯å•çº¿ç¨‹çš„)ï¼Œè¿”å›falseçš„çº¿ç¨‹éœ€è¦ç­‰åˆ°è·å–åˆ°é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åæ‰èƒ½è·å¾—é”ã€‚ ä¸šåŠ¡æ”¹é€ ï¼š 1234567891011121314151617181920212223242526272829303132333435@RequestMapping(&quot;/list/tree&quot;)public R list() throws InterruptedException { ValueOperations&lt;String, String&gt; opsForValue = redisTemplate.opsForValue(); // æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ•°æ® String category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { while (!opsForValue.setIfAbsent(&quot;category-lock&quot;, &quot;true&quot;)) { // ä¸Šé” Thread.sleep(200); } try { // å†æŸ¥è¯¢ä¸€æ¬¡ category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { List&lt;CategoryEntity&gt; entities = categoryService.listWithTree(); System.out.println(&quot;æŸ¥è¯¢äº†æ•°æ®åº“&quot;); category = JSON.toJSONString(entities); opsForValue.set(&quot;category-tree&quot;, category, Duration.ofHours(2)); return R.ok().put(&quot;data&quot;, entities); } } finally { // å·²ç»æœ‰äº†ç¼“å­˜ï¼Œé‡Šæ”¾é” if(opsForValue.get(&quot;category-lock&quot;) != null) { // æ­¤æ–¹æ³•ä¸å®‰å…¨ï¼Œåˆ¤æ–­å’Œåˆ é”ä¸æ˜¯åŸå­æ“ä½œ redisTemplate.delete(&quot;category-lock&quot;); } } } // æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›æŸ¥è¯¢åˆ°çš„ç¼“å­˜å€¼ List&lt;CategoryEntity&gt; entities = JSON.parseObject(category, List.class); System.out.println(&quot;ç¼“å­˜å‘½ä¸­&quot;); return R.ok().put(&quot;data&quot;, entities));} ä¸Šè¿°ä»£ç åˆæ­¥å®ç°äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œä¸å•ä¾‹æ¨¡å¼ç±»ä¼¼ï¼Œé‡‡ç”¨double-checkçš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®åº“çš„æŸ¥è¯¢ä»¥åŠç¼“å­˜æ•°æ®çš„æ·»åŠ ï¼Œåœ¨å®Œæˆä¸šåŠ¡åé‡Šæ”¾é”è®©å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°é”ç»§ç»­æ‰§è¡Œä»£ç ã€‚æœªè·å–åˆ°æ‰€çš„çº¿ç¨‹ç®€å•é‡‡ç”¨çŸ­æš‚ç¡çœ +è‡ªæ—‹çš„æ–¹å¼è¿›è¡Œé‡å¤å°è¯•ã€‚ è¿™ä»½ä»£ç å¹¶ä¸å®Œå–„ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥æ”¹è¿›æ¥æé«˜é”çš„å¯é æ€§ã€‚ redisåˆ†å¸ƒå¼é”çš„æ”¹è¿›(1) å®•æœºåé”æ— æ³•é‡Šæ”¾ ä¸Šè¿°åˆ†å¸ƒå¼é”çš„ä»£ç å­˜åœ¨å¾ˆå¤šä¸å¯é çš„å› ç´ ï¼Œè¿™äº›å› ç´ å¤šæ˜¯ç”±äºæœºå™¨æ•…éšœé€ æˆçš„ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼ŒæŸä¸ªçº¿ç¨‹åœ¨å‘redisä¸­è®¾ç½®äº†keyè·å–åˆ°äº†åˆ†å¸ƒå¼é”åï¼Œè¿˜æ²¡æœ‰é‡Šæ”¾é”ç»“æœæœºå™¨å®•æœºäº†ï¼Œé‚£ä¹ˆå°†ä¼šé€ æˆè¿™æŠŠåˆ†å¸ƒå¼é”æ°¸è¿œæ— æ³•é‡Šæ”¾ï¼Œæ²¡æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®åˆ°ç¼“å­˜çš„è¿™ä¸ªæ•°æ®ï¼Œè¿›è€Œæ²¡æœ‰çº¿ç¨‹èƒ½å¤Ÿè·³å‡ºè‡ªæ—‹å»æŸ¥è¯¢æ•°æ®ã€‚è¿™ç§æƒ…å†µè™½ç„¶å‘ç”Ÿçš„æ¦‚ç‡ä¸æ˜¯å¾ˆé«˜ï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿæ˜¯è‡´å‘½çš„ã€‚ ä¸€ä¸ªæ”¹è¿›çš„æ–¹æ³•å°±æ˜¯ç»™é”åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä¸€å°æœºå™¨å®•æœºäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”è¿‡äº†æ—¶é—´å°±ä¼šè‡ªåŠ¨çš„å¤±æ•ˆï¼Œå¹¶ä¸”ï¼Œæˆ‘ä»¬éœ€è¦å°†è®¾ç½®keyä¸è®¾ç½®è¿‡æœŸæ—¶é—´ä½œä¸ºåŸå­æ“ä½œï¼Œå¦‚æœä¸æ˜¯åŸå­æ“ä½œï¼Œé‚£ä¹ˆæœºå™¨åœ¨è®¾ç½®äº†keyä¹‹åå°±å®•æœºäº†ï¼Œæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆä¹Ÿä¼šå­˜åœ¨é”æ— æ³•é‡Šæ”¾çš„é—®é¢˜ã€‚redisæƒ³è¦å®ç°ä¸¤ä¸ªå‘½ä»¤çš„åŸå­æ“ä½œåªéœ€è¦ä¼ é€luaè„šæœ¬å³å¯ï¼Œåœ¨RedisTemplateä¸­å°è£…äº†setnxä¸expireçš„åŸå­æ“ä½œï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚ (2) ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ è™½ç„¶æˆ‘ä»¬è®¾ç½®äº†é”çš„è¿‡æœŸæ—¶é—´èƒ½å¤Ÿè§£å†³é”æ— æ³•é‡Šæ”¾çš„é—®é¢˜ï¼Œä½†å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸šåŠ¡æ‰§è¡Œè¿‡é•¿ä¼šå¯¼è‡´æœ¬æ¥è¿˜ä¸åº”è¯¥é‡Šæ”¾é”ä½†æ˜¯é”å·²ç»è‡ªåŠ¨å¤±æ•ˆäº†ï¼Œä¸€æ—¦ä¸šåŠ¡è¿˜æœªå®Œæˆå°±é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹å°±èƒ½å¤Ÿè¿›è¿›è¡ŒåŠ é”ï¼Œå½“æœ€å¼€å§‹çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•é‡Šæ”¾é”æ—¶ï¼Œé‡Šæ”¾çš„å°±æ˜¯å…¶ä»–çº¿ç¨‹æ‰€åŠ çš„é”ï¼Œè¿™æ ·ä¸€æ¥å°±éå¸¸çš„æ··ä¹±ã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹æ³•å°±æ˜¯ç»™æ¯ä¸ªçº¿ç¨‹çš„é”è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„uuidä½œä¸ºvalueå­˜åœ¨redisä¸­ï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±åŠ çš„é”ï¼Œæ˜¯è‡ªå·±åŠ çš„æ‰é‡Šæ”¾ã€‚ uuidçš„æ–¹æ³•åªæ˜¯è§£å†³äº†ä¸é‡Šæ”¾åˆ«äººçš„é”ï¼Œä»ç„¶æ²¡æœ‰è§£å†³çš„ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿è€Œé”æå‰å¤±æ•ˆçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„æŠŠé”å¤±æ•ˆçš„æ—¶é—´å˜é•¿ï¼Œå› ä¸ºä¸€èˆ¬ä¸ä¼šå…è®¸æŸä¸ªä¸šåŠ¡æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œä½†æ˜¯æ›´å®‰å…¨çš„åšæ³•æ˜¯è‡ªåŠ¨ç»™é”ç»­æœŸï¼Œæˆ‘ä»¬éœ€è¦æ–°å¼€ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹æ¥æ£€æµ‹ä¸šåŠ¡æ˜¯å¦è¿˜åœ¨è¿›è¡Œï¼Œå¦‚æœè¿˜åœ¨ï¼Œè‡ªåŠ¨ç»™é”è¿›è¡Œç»­æœŸã€‚ ä¸‹é¢çš„ä»£ç æ²¡æœ‰ç»™é”è¿›è¡Œè‡ªåŠ¨ç»­æœŸï¼Œé‡‡ç”¨é”è¿‡æœŸæ—¶é—´è®¾ç½®ç¨é•¿çš„æ–¹å¼ï¼š 1234567891011121314151617181920212223242526272829303132333435363738@RequestMapping(&quot;/list/tree&quot;)public R list() throws InterruptedException { ValueOperations&lt;String, String&gt; opsForValue = redisTemplate.opsForValue(); // æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ•°æ® String category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { String uuid = UUID.randomUUID().toString(); while (!opsForValue.setIfAbsent(&quot;category-lock&quot;, uuid, Duration.ofSeconds(15))) { // ä¸Šé” Thread.sleep(200); } try { // å†æŸ¥è¯¢ä¸€æ¬¡ category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { List&lt;CategoryEntity&gt; entities = categoryService.listWithTree(); System.out.println(&quot;æŸ¥è¯¢äº†æ•°æ®åº“&quot;); category = JSON.toJSONString(entities); opsForValue.set(&quot;category-tree&quot;, category, Duration.ofHours(2)); return R.ok().put(&quot;data&quot;, entities); } } finally { // å·²ç»æœ‰äº†ç¼“å­˜ï¼Œé‡Šæ”¾é” /*if(uuid.equals(opsForValue.get(&quot;category-lock&quot;))) { // æ­¤æ–¹æ³•ä¸å®‰å…¨ï¼Œåˆ¤æ–­å’Œåˆ é”ä¸æ˜¯åŸå­æ“ä½œ redisTemplate.delete(&quot;category-lock&quot;); }*/ // é‡‡ç”¨luaè„šæœ¬ä¿è¯åŸå­æ€§ String script = &quot;if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end&quot;; redisTemplate.execute(new DefaultRedisScript&lt;&gt;(script, Long.class), Arrays.asList(&quot;category-lock&quot;), uuid); } } // æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›æŸ¥è¯¢åˆ°çš„ç¼“å­˜å€¼ List&lt;CategoryEntity&gt; entities = JSON.parseObject(category, List.class); System.out.println(&quot;ç¼“å­˜å‘½ä¸­&quot;); return R.ok().put(&quot;data&quot;, entities).put(&quot;port&quot;, environment.getProperty(&quot;local.server.port&quot;));} é‡‡ç”¨redissonå°è£…çš„åˆ†å¸ƒå¼é”redissonæ˜¯åˆ©ç”¨javaç¼–å†™çš„ä¸€ä¸ªåŸºäºredisçš„å¼€æºçš„åˆ†å¸ƒå¼é”æ¡†æ¶ï¼Œredissonåˆ©ç”¨AQSå¯¹åˆ†å¸ƒå¼é”è¿›è¡Œäº†é«˜åº¦çš„å°è£…ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨ç”¨åˆ†å¸ƒå¼é”æ—¶å°±åƒåœ¨ä½¿ç”¨jdkçš„JUCåŒ…ä¸€æ ·ï¼Œredissonæä¾›RedissonLockæ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œå®ƒçš„ä½¿ç”¨ä¸ReentrantLockç±»ä¼¼ï¼š 12345678910111213141516171819202122232425262728293031@RequestMapping(&quot;/list/tree/redisson&quot;)public R listRedisson() { &lt;String, String&gt; opsForValue = redisTemplate.opsForValue(); // æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ•°æ® String category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { RLock lock = redisson.getLock(&quot;category-lock&quot;); // è·å¾—é”å¯¹è±¡ï¼Œéœ€è¦ä¼ å…¥é”çš„åç§°ï¼Œæ ¹æ®åç§°æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€æŠŠé” lock.lock(); try { // å†æŸ¥è¯¢ä¸€æ¬¡ category = opsForValue.get(&quot;category-tree&quot;); if(category == null) { List&lt;CategoryEntity&gt; entities = categoryService.listWithTree(); System.out.println(&quot;æŸ¥è¯¢äº†æ•°æ®åº“&quot;); category = JSON.toJSONString(entities); opsForValue.set(&quot;category-tree&quot;, category, Duration.ofHours(2)); return R.ok().put(&quot;data&quot;, entities); } } finally { lock.unlock(); } } // æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›æŸ¥è¯¢åˆ°çš„ç¼“å­˜å€¼ List&lt;CategoryEntity&gt; entities = JSON.parseObject(category, List.class); System.out.println(&quot;ç¼“å­˜å‘½ä¸­&quot;); return R.ok().put(&quot;data&quot;, entities);} Reddisonå®ç°çš„åˆ†å¸ƒå¼é”ä¸ä¹‹å‰è®²çš„åŸç†ç±»ä¼¼ï¼Œå®ƒåº•å±‚ä¼šè‡ªåŠ¨ç»™é”è¿›è¡Œç»­æœŸã€‚","link":"/2020/07/01/huan-cun-yu-fen-bu-shi-suo/"},{"title":"ç±»åŠ è½½å™¨","text":"ç±»åŠ è½½å™¨æ˜¯ Java è¯­è¨€çš„åŠ¨æ€æ€§çš„é‡è¦ç»„ä»¶ï¼Œä¹Ÿæ˜¯ Java è¯­è¨€æµè¡Œçš„é‡è¦åŸå› ä¹‹ä¸€ã€‚å®ƒä½¿å¾— Java ç±»å¯ä»¥è¢«åŠ¨æ€åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­å¹¶æ‰§è¡Œã€‚ 1 ä½œç”¨ ç±»åŠ è½½å™¨åœ¨JVMå¯åŠ¨æ—¶è¿›è¡ŒåŠ è½½ï¼Œè´Ÿè´£ä»æ–‡ä»¶æˆ–ç½‘ç»œä¸­åŠ è½½.classæ–‡ä»¶ã€‚ ç±»åŠ è½½å™¨åªè´Ÿè´£ç¬¦åˆè§„èŒƒçš„classæ–‡ä»¶ï¼Œè‡³äºè¯¥æ–‡ä»¶æ˜¯å¦èƒ½å¤Ÿè¿è¡Œï¼Œç”±æ‰§è¡Œå¼•æ“æ¥å†³å®šã€‚ ç±»çš„ä¿¡æ¯åŠ è½½åï¼Œç±»çš„å…ƒæ•°æ®(åŒ…å«å¸¸é‡æ± ã€å±æ€§è¡¨ã€æ–¹æ³•è¡¨ã€ç±»å˜é‡ç­‰)å­˜æ”¾äºå†…å­˜ç©ºé—´ä¸­çš„æ–¹æ³•åŒºï¼Œç”Ÿæˆçš„Classå¯¹è±¡å®ä¾‹å­˜å‚¨åœ¨å †åŒºï¼Œé™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºè¿˜ä¼šä¿å­˜ä¸€äº›ã€‚ 2 è¿‡ç¨‹ç±»åŠ è½½è¿‡ç¨‹ï¼šåŠ è½½-éªŒè¯-å‡†å¤‡-è§£æ-åˆå§‹åŒ– åŠ è½½é˜¶æ®µï¼š é€šè¿‡ç±»çš„å…¨é™å®šç±»åè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºè¿è¡Œæ—¶æ•°æ®ç»“æ„(classçš„å…ƒæ•°æ®ï¼ŒåŒ…å«å¸¸é‡æ± ã€å±æ€§è¡¨ã€æ–¹æ³•è¡¨ã€ç±»å˜é‡ç­‰)å­˜å‚¨åœ¨æ–¹æ³•åŒºã€‚ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªjava.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®è®¿é—®çš„å…¥å£ï¼Œ**Classå¯¹è±¡å­˜åœ¨äºå †åŒºï¼Œå…¶ä¸­çš„å¾ˆå¤šå±æ€§å­˜åœ¨äºæ–¹æ³•åŒº**ã€‚ éªŒè¯é˜¶æ®µï¼š ç¡®ä¿å­—èŠ‚ç æ–‡ä»¶ç¬¦å·è™šæ‹Ÿæœºçš„è§„èŒƒè¦æ±‚ï¼Œä¿è¯ç±»æ­£ç¡®è¢«åŠ è½½ï¼Œä¸å±å®³è™šæ‹Ÿæœºçš„å®‰å…¨ã€‚ å››ç§éªŒè¯æ–¹å¼ï¼šæ–‡ä»¶æ ¼å¼éªŒè¯(ä¾‹å¦‚æ–‡ä»¶å¼€å¤´éƒ½æ˜¯CA FE BA BE)ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚ å‡†å¤‡é˜¶æ®µï¼š ä¸ºç±»å˜é‡(å³staticä¿®é¥°çš„å˜é‡)åˆ†é…å†…å­˜å¹¶ä¸ºå˜é‡è®¾ç½®é»˜è®¤åˆå§‹å€¼ï¼Œå¯¹è±¡ä¸ºnullï¼Œæ•°å€¼åŸºæœ¬ç±»å‹ä¸º0ã€‚ è¿™é‡Œåˆ†é…å†…å­˜ä¸åŒ…æ‹¬finalä¿®é¥°çš„å˜é‡ï¼Œå¸¸é‡åœ¨ç¼–è¯‘æ—¶æœŸå°±å·²ç»åˆ†é…äº†ã€‚ è¿™é‡Œä¸ä¼šä¸ºç±»å®ä¾‹å˜é‡(å³ç±»æˆå‘˜ï¼Œä¸åŒstaticä¿®é¥°)åˆ†é…å†…å­˜åˆå§‹åŒ–ï¼Œç±»å˜é‡(static)ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºï¼Œè€Œå®ä¾‹å˜é‡(æ— static)ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°å †ä¸­ã€‚ æ³¨æ„ï¼š 1private static int a = 1; å³ä½¿æ˜¯å¦‚ä¸Šçš„ä»£ç ï¼Œåœ¨å‡†å¤‡é˜¶æ®µaåªä¼šèµ‹å€¼ä¸º0ï¼Œåªæœ‰åˆ°åé¢çš„ç±»åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«èµ‹å€¼ä¸º1ã€‚ è§£æé˜¶æ®µï¼š å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œå³å°†ç¬¦å·è½¬åŒ–ä¸ºå®é™…å¯¹è±¡çš„åœ°å€ã€‚ äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚ ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€Šjava è™šæ‹Ÿæœºè§„èŒƒã€‹çš„Classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT Class infoã€ CONSTANT Fieldref infoã€CONSTANT Methodref infoç­‰ ã€‚ åˆå§‹åŒ–é˜¶æ®µï¼š åˆå§‹åŒ–é˜¶æ®µæ˜¯è°ƒç”¨ç±»æ„é€ å™¨æ–¹æ³•&lt;clinit&gt;()çš„è¿‡ç¨‹ï¼Œæ³¨æ„å¿…é¡»è¦æœ‰staticå˜é‡æˆ–è€…staticä»£ç æ‰ä¼šæœ‰è¯¥æ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ–ç±»çš„é™æ€å˜é‡ã€‚ static{}ä»£ç å—å°±æ˜¯&lt;clinit&gt;()çš„ä¸€éƒ¨åˆ†ï¼Œè¯¥ç±»æ„é€ å™¨æ–¹æ³•&lt;clinit&gt;()ä¸æ˜¯ç±»çš„æ„é€ æ–¹æ³•(å‡½æ•°)ï¼Œæ­¤æ–¹æ³•ä¸éœ€è¦äººä¸ºå®šä¹‰ã€‚ æ³¨æ„ï¼šç±»è¢«åŠ è½½ä¸ä¸€å®šä¼šåˆå§‹åŒ– 3 ç±»åŠ è½½å™¨åˆ†ç±»JVMçš„ç±»åŠ è½½å™¨ä¸»è¦åˆ†ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬ä¸åŒçš„ç±»åŠ è½½å™¨è´Ÿè´£ä¸åŒçš„ç±»åŠ è½½çš„è·¯å¾„ã€‚ å¼•å¯¼ç±»åŠ è½½å™¨ä¸ºBootstrap Class Loaderï¼Œè¯¥ç±»æ˜¯ç”±c/c++è¯­è¨€ç¼–å†™çš„ï¼Œç”¨äºå¯åŠ¨ã€‚è€Œå…¶ä»–çš„éƒ½å±äºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ŒåŒ…æ‹¬Extension Class Loarderã€System Class Loarderä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›ç±»åŠ è½½å™¨ï¼Œæ³¨æ„ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿äºæŠ½è±¡ç±»Classloaderï¼Œè€Œå„ä¸ªç±»åŠ è½½å™¨ä¹‹é—´æ²¡æœ‰ç»§æ‰¿å…³ç³»ã€‚å³System Class Loarderä¸æ˜¯Extension Class Loarderå­ç±»ï¼Œä¸‹å›¾ä»…ä»…è¡¨ç¤ºæŸç§ç±»åŠ è½½å™¨æ˜¯ç”±å“ªä¸ªç±»åŠ è½½å™¨åŠ è½½çš„ã€‚ ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨(AppClassLoader)åŠ è½½çš„ï¼Œè€Œjavaçš„æ ¸å¿ƒç±»åº“æ˜¯ç”±å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚ ä¸Šå›¾ä¸ååº”ç»§æ‰¿å…³ç³»ï¼Œä¸‹å›¾æ˜¯ClassLoaderç±»çš„ç»§æ‰¿å…³ç³»ã€‚ Bootstrapç±»åŠ è½½å™¨ ï¼ˆ1ï¼‰è¿™ä¸ªç±»åŠ è½½ä½¿ç”¨C/C+ +è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ã€‚ ï¼ˆ2ï¼‰å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“(JAVA_ HOME/jre/ lib/rt.jarã€resources. jaræˆ–sun . boot.class .pathè·¯å¾„ä¸‹çš„å†…å®¹) ,ç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»ã€‚ ï¼ˆ3ï¼‰å¹¶ä¸ç»§æ‰¿è‡ªjava. lang. ClassLoaderï¼Œæ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨ã€‚ ï¼ˆ4ï¼‰å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸ºjavaã€javaxã€sunç­‰å¼€å¤´çš„ç±» Extensionç±»åŠ è½½å™¨ ï¼ˆ1ï¼‰Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun . misc. Launcher$ExtClassLoaderå®ç°ã€‚ ï¼ˆ2ï¼‰æ´¾ç”ŸäºClassLoaderç±» ï¼ˆ3ï¼‰çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ ï¼ˆ4ï¼‰ä»java. ext.dirsç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä»JDKçš„å®‰è£…ç›®å½•çš„jre/lib/extå­ç›®å½•(æ‰©å±•ç›®å½•)ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„JARæ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚ åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderç±») ï¼ˆ1ï¼‰javaè¯­è¨€ç¼–å†™ï¼Œç”±sun . misc. Launcher$AppClassLoaderå®ç° ï¼ˆ2ï¼‰æ´¾ç”ŸäºClassLoaderç±» ï¼ˆ3ï¼‰çˆ¶åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨ï¼ˆä¸æ˜¯çˆ¶ç±»çš„æ„æ€ï¼‰ ï¼ˆ4ï¼‰å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§java.class.path æŒ‡å®šè·¯å¾„â€œä¸‹çš„ç±»åº“è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»(æˆ‘ä»¬å†™åœ¨classpathä¸‹çš„ç±»)éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½ ï¼ˆ5ï¼‰é€šè¿‡ClassLoader# getSystemClassLoader ()æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨ ç”¨æˆ·è‡ªå®šä¹‰çš„åŠ è½½ç±» ç»§æ‰¿ClassLoaderæŠ½è±¡ç±»ï¼Œé‡å†™findClassæ–¹æ³•ã€‚å¯èƒ½ç§ç§åŸå› ï¼Œä¾‹å¦‚ç”±äºæˆ‘ä»¬éœ€è¦åŠ è½½çš„ç±»ä¸åœ¨classpathä¸‹ã€ä¹Ÿä¸åœ¨Bootstrapå’ŒExtensionç±»åŠ è½½å™¨æ‰€åŠ è½½çš„è·¯å¾„ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ã€‚ 4 ç±»è¢«åŠ è½½çš„æ¡ä»¶ç±»åŠ è½½çš„æ¡ä»¶ï¼š å½“ç±»è¢«ä¸»åŠ¨ä½¿ç”¨æ—¶ï¼Œç±»ä¼šè¢«åŠ è½½è¿›å†…å­˜ï¼Œä¸»åŠ¨ä½¿ç”¨åŒ…æ‹¬ï¼š â€‹ ï¼ˆ1ï¼‰åˆ›å»ºç±»çš„å®ä¾‹ â€‹ ï¼ˆ2ï¼‰è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼ â€‹ ï¼ˆ3ï¼‰è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• â€‹ ï¼ˆ4ï¼‰åå°„(æ¯”å¦‚: Class. forName (â€œcom. atguigu. Testâ€) ) â€‹ ï¼ˆ5ï¼‰åˆå§‹åŒ–ä¸€ä¸€ä¸ªç±»çš„å­ç±» â€‹ ï¼ˆ6ï¼‰Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±» â€‹ ï¼ˆ7ï¼‰JDK 7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒ:java. lang. invoke . MethodHandleå®ä¾‹çš„è§£æç»“æœREF_ getStaticã€REF_ putStaticã€REF_ invokeStaticå¥æŸ„ å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ– é™¤äº†ä»¥ä¸Šçš„ä¸»åŠ¨ä½¿ç”¨ï¼Œå…¶ä½™éƒ½ä¸ºè¢«åŠ¨ä½¿ç”¨ï¼Œè¢«åŠ¨ä½¿ç”¨ä¸ä¼šå¼•èµ·ç±»çš„åŠ è½½åˆå§‹åŒ–ã€‚ ç±»åŠ è½½çš„æ—¶æœºï¼š ä¸ç®¡ä½¿ç”¨ä»€ä¹ˆæ ·çš„ç±»åŠ è½½å™¨ï¼Œç±»éƒ½æ˜¯åœ¨ç¬¬ä¸€æ¬¡è¢«ç”¨åˆ°æ—¶ï¼ŒåŠ¨æ€åŠ è½½åˆ°JVMçš„ã€‚è¿™å¥è¯æœ‰ä¸¤å±‚å«ä¹‰ï¼š Javaç¨‹åºåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¸€å®šè¢«å®Œæ•´åŠ è½½ï¼Œåªæœ‰å½“å‘ç°è¯¥ç±»è¿˜æ²¡æœ‰åŠ è½½æ—¶ï¼Œæ‰å»æœ¬åœ°æˆ–è¿œç¨‹æŸ¥æ‰¾ç±»çš„.classæ–‡ä»¶å¹¶éªŒè¯å’ŒåŠ è½½ï¼ˆèµ–åŠ è½½ï¼‰ï¼› å½“ç¨‹åºåˆ›å»ºäº†ç¬¬ä¸€ä¸ªå¯¹ç±»çš„é™æ€æˆå‘˜çš„å¼•ç”¨ï¼ˆå¦‚ç±»çš„é™æ€å˜é‡ã€é™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•â€”â€”æ„é€ æ–¹æ³•ä¹Ÿæ˜¯é™æ€çš„ï¼‰æ—¶ï¼Œæ‰ä¼šåŠ è½½è¯¥ç±»ã€‚Javaçš„è¿™ä¸ªç‰¹æ€§å«åšï¼šåŠ¨æ€åŠ è½½ã€‚ ä¾‹å¦‚ï¼š 12345678910111213141516public class ClD { public static void main(String[] args) throws ClassNotFoundException { System.out.println(&quot;asd&quot;); A a = new A(); // æ‰§è¡Œè¿™å¥è¯æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­ç±»Aæ˜¯å¦åŠ è½½ï¼ŒæœªåŠ è½½åˆ™å…ˆåŠ è½½ A a2 = new A(); // ç±»Aå·²ç»åŠ è½½è¿‡äº†ï¼Œæ— éœ€å†åŠ è½½ }}public class A { static { System.out.println(&quot;A&quot;); }} 5 ç±»åŠ è½½çš„è§„åˆ™ï¼šåŒäº²å§”æ´¾æœºåˆ¶ï¼ˆ1ï¼‰å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œ; ï¼ˆ2ï¼‰å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¹å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨; ï¼ˆ3ï¼‰å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚ è¿™ä¸€é€»è¾‘æˆ‘ä»¬å¯ä»¥åœ¨ClassLoaderä¸­çš„æºç ä¸­çœ‹åˆ°ï¼š ClassLoaderç±»ä¸­çš„loadClassæ˜¯ç±»åŠ è½½çš„æ ¸å¿ƒä»£ç  1234567891011121314151617181920212223242526272829303132333435363738protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException{ synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded // è¯¥ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ï¼ŒåŠ è½½è¿‡äº†ç›´æ¥è¿”å› Class&lt;?&gt; c = findLoadedClass(name); if (c == null) { long t0 = System.nanoTime(); try { if (parent != null) { // åˆ¤æ–­æ˜¯å¦æœ‰çˆ¶åŠ è½½å™¨ c = parent.loadClass(name, false); // å§”æ‰˜çˆ¶åŠ è½½å™¨åŠ è½½ } else { c = findBootstrapClassOrNull(name); // æ— çˆ¶åŠ è½½å™¨ï¼Œä»£è¡¨çˆ¶åŠ è½½å™¨ä¸ºBootstrapåŠ è½½å™¨ï¼Œå§”æ‰˜BootstrapåŠ è½½å™¨åŠ è½½ } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader } if (c == null) { // çˆ¶åŠ è½½å™¨ä¸èƒ½åŠ è½½è¯¥ç±»ï¼Œç”±è‡ªå·±åŠ è½½ // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); } } if (resolve) { resolveClass(c); } return c; }} ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±é¡¹ç›®ä¸­è‡ªå®šä¹‰äº†ä¸€ä¸ªjava.lang.Stringï¼Œå½“æˆ‘ä»¬new Stringå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ˜¯javaåŸç”ŸAPIçš„Stringç±»å‹è¿˜æ˜¯è‡ªå®šä¹‰çš„Stringç±»å‹å‘¢ï¼Ÿæ ¹æ®åŒäº²å§”æ´¾æ¨¡å‹ï¼Œæ­¤æ—¶åŠ è½½çš„è¿˜æ˜¯javaåŸç”ŸAPIè€Œå¹¶æ²¡æœ‰åŠ è½½è‡ªå®šä¹‰çš„java.lang.String(æ³¨æ„åŒ…åä¹Ÿç›¸åŒ)ï¼Œå…¶åŸå› æ˜¯åŸç”ŸAPIçš„java.lang.Stringæ˜¯è¢«å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œè€Œç”¨æˆ·è‡ªå·±å®šä¹‰çš„ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œæ‰€ä»¥java.lang.Stringåœ¨çˆ¶åŠ è½½å™¨ä¸­å·²ç»åŠ è½½äº†ï¼Œå­åŠ è½½å™¨æ— éœ€å†è¿›è¡ŒåŠ è½½ã€‚ åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿ï¼š é‡‡ç”¨åŒäº²å§”æ´¾æ¨¡å¼çš„æ˜¯å¥½å¤„æ˜¯Javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œé€šè¿‡è¿™ç§å±‚çº§å…³å¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œå½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå†åŠ è½½ä¸€æ¬¡ã€‚ å…¶æ¬¡æ˜¯è€ƒè™‘åˆ°å®‰å…¨å› ç´ ï¼Œjavaæ ¸å¿ƒapiä¸­å®šä¹‰ç±»å‹ä¸ä¼šè¢«éšæ„æ›¿æ¢ï¼Œå‡è®¾é€šè¿‡ç½‘ç»œä¼ é€’ä¸€ä¸ªåä¸ºjava.lang.Integerçš„ç±»ï¼Œé€šè¿‡åŒäº²å§”æ‰˜æ¨¡å¼ä¼ é€’åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè€Œå¯åŠ¨ç±»åŠ è½½å™¨åœ¨æ ¸å¿ƒJava APIå‘ç°è¿™ä¸ªåå­—çš„ç±»ï¼Œå‘ç°è¯¥ç±»å·²è¢«åŠ è½½ï¼Œå¹¶ä¸ä¼šé‡æ–°åŠ è½½ç½‘ç»œä¼ é€’çš„è¿‡æ¥çš„java.lang.Integerï¼Œè€Œç›´æ¥è¿”å›å·²åŠ è½½è¿‡çš„Integer.classï¼Œè¿™æ ·ä¾¿å¯ä»¥é˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹ã€‚ 6 è‡ªå®šä¹‰ç±»åŠ è½½å™¨åœ¨ClassLoaderç±»æ–‡ä»¶æ³¨é‡Šä¸­ç»™äº†ä¸€ä¸ªæœ€ç®€å•çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ç¤ºä¾‹ï¼ŒæŒ‰ç…§ç¤ºä¾‹ï¼Œåªéœ€è¦è·å–classæ–‡ä»¶çš„byte[]æ•°ç»„ç„¶åé€šè¿‡ClassLoaderä¸­çš„defineClassæ–¹æ³•å³å¯è·å–Classå¯¹è±¡ï¼Œé‡å†™findClassæ–¹æ³•å³å¯ï¼ŒClassLoaderä¸­å·²ç»å®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657public class TomcodeClassLoader extends ClassLoader { // éªŒè¯ public static void main(String[] args) throws ClassNotFoundException { TomcodeClassLoader classLoader = new TomcodeClassLoader(); Class&lt;?&gt; aClass = classLoader.loadClass(&quot;classloader.A&quot;); System.out.println(aClass.getClassLoader()); } private static final String PRE_FIX = &quot;/Volumes/data/&quot;; // è¦åŠ è½½çš„ç±»æ‰€åœ¨çš„ç›®å½• public TomcodeClassLoader() { super(); } @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { try { byte[] b = loadClassData(name); return defineClass(name, b, 0, b.length); } catch (IOException e) { e.printStackTrace(); return null; } } private byte[] loadClassData(String name) throws IOException { String[] split = name.split(&quot;\\\\.&quot;); StringBuilder sb = new StringBuilder(PRE_FIX); for(int i = 0; i &lt; split.length-1; i++) { sb.append(split[i]); sb.append('/'); } String fullpath = sb.append(split[split.length - 1] + &quot;.class&quot;).toString(); FileInputStream is = null; ByteArrayOutputStream bo = null; try { is = new FileInputStream(fullpath); byte[] b = new byte[1024]; bo = new ByteArrayOutputStream(); int len = -1; while ((len = is.read(b)) != -1) { bo.write(b, 0, len); } return bo.toByteArray(); } finally { if(is != null) { is.close(); } if(bo != null) { bo.close(); } } }} é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç±»Açš„æ–‡ä»¶æ”¾åœ¨å½“å‰ç±»è·¯å¾„ï¼Œåœ¨æŒ‡å®šçš„/Volumes/data/ä¸‹æ”¾å…¥classloader/A.classï¼Œç”±äºåŒäº²å§”æ´¾æœºåˆ¶ï¼Œç±»Aä¼šç”±AppClassLoaderåŠ è½½ 1sun.misc.Launcher$AppClassLoader@18b4aac2 å½“æˆ‘ä»¬åˆ é™¤å½“å‰ç±»è·¯å¾„ä¸‹çš„ç±»Aæ–‡ä»¶ï¼Œåˆ™ç±»Aç”±è‡ªå®šä¹‰çš„TomcodeClassLoaderåŠ è½½ 1classloader.TomcodeClassLoader@1d44bcfa 7 ç±»åŠ è½½å™¨çš„å‘½åç©ºé—´ æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œç±»åŠ è½½å™¨çš„å‘½åç©ºé—´æ˜¯ç”±è‡ªèº«ä»¥åŠæ‰€æœ‰çˆ¶åŠ è½½å™¨æ‰€åŠ è½½å‡ºæ¥çš„å…¨ç±»åç»„æˆã€‚ ç”±äºåŒäº²å§”æ´¾æœºåˆ¶ï¼Œçˆ¶å­åŠ è½½å™¨ä¹‹é—´ä¸ä¼šå‡ºç°ç›¸åŒçš„å…¨ç±»åï¼Œä½†æ˜¯åŒç­‰çº§çš„ç±»åŠ è½½å™¨ä¹‹é—´å¯ä»¥å‡ºç°ç›¸åŒçš„å…¨ç±»åï¼Œå¹¶ä¸”äº’ç›¸æ˜¯æ„Ÿå—ä¸åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Classå¯¹è±¡ä¸åŒã€‚ å­åŠ è½½å™¨åŠ è½½çš„ç±»å¯ä»¥æ„ŸçŸ¥åˆ°çˆ¶åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ï¼Œåä¹‹åˆ™ä¸è¡Œã€‚ä¾‹å¦‚è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½åœ¨Stringç±»ä¸­ä½¿ç”¨çš„ï¼Œå› ä¸ºStringç±»æ˜¯ç”±BootstrapåŠ è½½å™¨åŠ è½½çš„ï¼Œè€Œè‡ªå®šä¹‰ç±»æ˜¯AppClassLoaderåŠ è½½çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰ç±»ä¸­ä½¿ç”¨Stringç±»ã€‚ 1234567891011121314151617181920212223242526272829303132public class ClD { public static void main(String[] args) throws Exception { TomcodeClassLoader classLoader = new TomcodeClassLoader(); Class&lt;?&gt; aClass = classLoader.loadClass(&quot;classloader.B&quot;); TomcodeClassLoader classLoader2 = new TomcodeClassLoader(); Class&lt;?&gt; bClass1 = classLoader2.loadClass(&quot;classloader.B&quot;); System.out.println(aClass.getClassLoader()); System.out.println(bClass1.getClassLoader()); System.out.println(aClass == bClass1); Object o = aClass.newInstance(); Object o1 = bClass1.newInstance(); bClass1.getMethod(&quot;setB&quot;, Object.class).invoke(o1, o); }}public class B { private B b; public B() { } public void setB(Object b) { this.b = (B) b; }} è¾“å‡ºï¼š 123456789101112classloader.TomcodeClassLoader@1d44bcfaclassloader.TomcodeClassLoader@6f94fa3efalseException in thread &quot;main&quot; java.lang.reflect.InvocationTargetException at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at classloader.ClD.main(ClD.java:23)Caused by: java.lang.ClassCastException: classloader.B cannot be cast to classloader.B at classloader.B.setB(B.java:11) ... 5 more é¦–å…ˆï¼Œä¸¤ä¸ªClasså¯¹è±¡éƒ½æ˜¯ç”±TomcodeClassLoaderè¿›è¡ŒåŠ è½½çš„ï¼Œä½†æ˜¯ä¸æ˜¯åŒä¸€ä¸ªClassLoaderå¯¹è±¡ï¼Œä¸¤ä¸ªTomcodeClassLoaderæ˜¯åŒç­‰çº§çš„ï¼Œå› æ­¤ä¸¤ä¸ªåŠ è½½å‡ºæ¥çš„Classå¯¹è±¡æ˜¯ä¸åŒçš„ å…¶æ¬¡ï¼Œä¸¤ä¸ªClasså¯¹è±¡æ˜¯æ— æ³•äº’ç›¸æ„ŸçŸ¥åˆ°ï¼Œä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¸¤ä¸ªä¸åŒClasså¯¹è±¡åˆ›å»ºçš„å®ä¾‹ä¸èƒ½è¿›è¡Œå¼ºè½¬ 8 æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„ä¸€ä¸ªé‡è¦åœºæ™¯å°±æ˜¯æ•°æ®åº“è¿æ¥é©±åŠ¨ï¼Œæ•°æ®åº“è¿æ¥é©±åŠ¨é‡‡ç”¨çš„SPIæœºåˆ¶æ¥åŠ è½½æ•°æ®åº“é©±åŠ¨ã€‚SPIç®€å•æ¥è¯´ä½¿ç”¨è¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥åŠ¨æ€åŠ è½½æ¥å£çš„å®ç°ç±»ï¼Œæ‹¿åˆ°é…ç½®æ–‡ä»¶ä¸­çš„å®ç°ç±»ï¼Œé€šè¿‡åå°„åŠ è½½ç±»ï¼Œå…·ä½“æš‚ä¸å±•å¼€é˜è¿°ï¼ŒSPIå°±å¯ä»¥ç”¨æ¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹è·å–æ•°æ®åº“è¿æ¥çš„ä»£ç ï¼š 1234public static void main(String[] args) throws ClassNotFoundException, SQLException { Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;); Connection conn = DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/newmall&quot;);} ä»£ç éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¸€å¥Class.forName(â€œcom.mysql.cj.jdbc.Driverâ€);å°±æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼ŒåŠ è½½äº†Mysqlé©±åŠ¨ã€‚ Class.forName(â€œcom.mysql.cj.jdbc.Driverâ€)åŠ è½½Mysqlé©±åŠ¨ï¼Œåˆ™å°†æ‰§è¡Œè¯¥ç±»çš„é™æ€ä»£ç å—ï¼š 1234567static { try { java.sql.DriverManager.registerDriver(new Driver()); } catch (SQLException E) { throw new RuntimeException(&quot;Can't register driver!&quot;); }} è¯¥é™æ€ä»£ç å—ä½¿ç”¨äº†DriverManagerï¼Œåˆ™åŠ è½½è¯¥ç±»ï¼Œæ³¨æ„DriverManageræ˜¯java.sqlä¸‹çš„ï¼Œç”±BootsrapåŠ è½½å™¨æ‰€åŠ è½½ï¼ŒDriverManagerä¸­çš„é™æ€ä»£ç å—æ‰§è¡Œï¼Œåœ¨é™æ€ä»£ç å—ä¸­åŠ è½½äº†Mysqlçš„é©±åŠ¨ã€‚ æ³¨æ„ï¼Œæ­¤æ—¶DriverManageræ˜¯ç”±BootsrapåŠ è½½å™¨åŠ è½½ï¼Œè¿™æ„å‘³ç€ï¼ŒDriverManagerä¸­åªèƒ½ä½¿ç”¨ç”±BootsrapåŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“é©±åŠ¨å±äºç¬¬ä¸‰æ–¹æä¾›çš„ï¼Œè‚¯å®šä¸æ˜¯ç”±BootsrapåŠ è½½å™¨åŠ è½½ï¼Œå› æ­¤æ­¤æ—¶éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‡‡ç”¨çš„å°±æ˜¯SPIæœºåˆ¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051static { loadInitialDrivers(); println(&quot;JDBC DriverManager initialized&quot;);}private static void loadInitialDrivers() { String drivers; try { drivers = AccessController.doPrivileged(new PrivilegedAction&lt;String&gt;() { public String run() { return System.getProperty(&quot;jdbc.drivers&quot;); } }); } catch (Exception ex) { drivers = null; } AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() { public Void run() { // SPIåŠ è½½é©±åŠ¨ç±» ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class); Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator(); try{ while(driversIterator.hasNext()) { driversIterator.next(); } } catch(Throwable t) { // Do nothing } return null; } }); println(&quot;DriverManager.initialize: jdbc.drivers = &quot; + drivers); if (drivers == null || drivers.equals(&quot;&quot;)) { return; } String[] driversList = drivers.split(&quot;:&quot;); println(&quot;number of Drivers:&quot; + driversList.length); for (String aDriver : driversList) { try { println(&quot;DriverManager.Initialize: loading &quot; + aDriver); Class.forName(aDriver, true, ClassLoader.getSystemClassLoader()); } catch (Exception ex) { println(&quot;DriverManager.Initialize: load failed: &quot; + ex); } }} æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨loadInitialDriversæ–¹æ³•ä¸­ä½¿ç”¨SPIåŠ è½½META-INF/servicesä¸­é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„Driveræ¥å£çš„å®ç°ç±»ï¼Œæˆ‘ä»¬çœ‹ServiceLoader.loadæ–¹æ³•ï¼š 1234public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) { ClassLoader cl = Thread.currentThread().getContextClassLoader(); // è·å–å½“å‰çº¿ç¨‹çš„ClassLoader return ServiceLoader.load(service, cl);} è¿™é‡Œæ˜¯æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…³é”®ï¼Œæˆ‘ä»¬ä»å½“å‰çº¿ç¨‹ä¸­è·å–åˆ°äº†ClassLoaderå¯¹è±¡ï¼Œè¿™ä¸ªClassLoaderå¯¹è±¡ä¸æ˜¯åŠ è½½åŠ è½½DriverManagerçš„Bootstrap ClassLoaderï¼Œè€Œæ˜¯AppClassLoaderï¼Œæˆ‘ä»¬ä½¿ç”¨AppClassLoaderä¾¿å¯ä»¥åŠ è½½ç¬¬ä¸‰æ–¹æä¾›çš„é©±åŠ¨jaråŒ…ã€‚ è€ŒJavaæä¾›äº†Class.forName(String name, boolean initialize, ClassLoader loader)æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šåŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨ï¼Œä¾¿å¯ä»¥åœ¨DriverManagerå†…åŠ è½½ç¬¬ä¸‰æ–¹Mysqlé©±åŠ¨äº†ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚","link":"/2020/07/24/lei-jia-zai-qi/"}],"tags":[{"name":"netty","slug":"netty","link":"/tags/netty/"},{"name":"JAVA","slug":"JAVA","link":"/tags/JAVA/"},{"name":"spring","slug":"spring","link":"/tags/spring/"},{"name":"mybatis","slug":"mybatis","link":"/tags/mybatis/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","link":"/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"redis","slug":"redis","link":"/tags/redis/"}],"categories":[{"name":"Netty","slug":"Netty","link":"/categories/Netty/"},{"name":"JAVA","slug":"JAVA","link":"/categories/JAVA/"},{"name":"SSM","slug":"SSM","link":"/categories/SSM/"},{"name":"Redis","slug":"Redis","link":"/categories/Redis/"},{"name":"JVM","slug":"JVM","link":"/categories/JVM/"}]}